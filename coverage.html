
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>service: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/nervatura/nervatura/v6/pkg/component/client/service/client.go (33.3%)</option>
				
				<option value="file1">github.com/nervatura/nervatura/v6/pkg/component/client/service/customer.go (0.0%)</option>
				
				<option value="file2">github.com/nervatura/nervatura/v6/pkg/component/client/service/employee.go (0.0%)</option>
				
				<option value="file3">github.com/nervatura/nervatura/v6/pkg/component/client/service/place.go (0.0%)</option>
				
				<option value="file4">github.com/nervatura/nervatura/v6/pkg/component/client/service/product.go (0.0%)</option>
				
				<option value="file5">github.com/nervatura/nervatura/v6/pkg/component/client/service/project.go (0.0%)</option>
				
				<option value="file6">github.com/nervatura/nervatura/v6/pkg/component/client/service/search.go (0.0%)</option>
				
				<option value="file7">github.com/nervatura/nervatura/v6/pkg/component/client/service/setting.go (0.0%)</option>
				
				<option value="file8">github.com/nervatura/nervatura/v6/pkg/component/client/service/tool.go (0.0%)</option>
				
				<option value="file9">github.com/nervatura/nervatura/v6/pkg/component/client/service/trans.go (45.6%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package service

import (
        "errors"
        "fmt"
        "log/slog"
        "slices"
        "strings"
        "time"

        ct "github.com/nervatura/component/pkg/component"
        cu "github.com/nervatura/component/pkg/util"
        api "github.com/nervatura/nervatura/v6/pkg/api"
        cpu "github.com/nervatura/nervatura/v6/pkg/component"
        cp "github.com/nervatura/nervatura/v6/pkg/component/client/component"
        md "github.com/nervatura/nervatura/v6/pkg/model"
        ut "github.com/nervatura/nervatura/v6/pkg/service/utils"
        st "github.com/nervatura/nervatura/v6/pkg/static"
        "golang.org/x/oauth2"
        "golang.org/x/oauth2/google"
)

// ClientService implements the Nervatura Client GUI Service.
type ClientService struct {
        Config       cu.IM
        AuthConfigs  map[string]*oauth2.Config
        AppLog       *slog.Logger
        Session      *api.SessionService
        NewDataStore func(config cu.IM, alias string, appLog *slog.Logger) *api.DataStore
        Modules      map[string]ServiceModule
        UI           *cp.ClientComponent
}

// ServiceModule is an interface that defines the methods for a module in the ClientService.
type ServiceModule interface {
        // Data is the method that returns the data for the module.
        Data(evt ct.ResponseEvent, params cu.IM) (data cu.IM, err error)
        // Response is the method that returns the response for the module.
        Response(evt ct.ResponseEvent) (re ct.ResponseEvent, err error)
}

var moduleMap = map[string]func(cls *ClientService) ServiceModule{
        "search": func(cls *ClientService) ServiceModule <span class="cov0" title="0">{
                return NewSearchService(cls)
        }</span>,
        "customer": func(cls *ClientService) ServiceModule <span class="cov0" title="0">{
                return NewCustomerService(cls)
        }</span>,
        "employee": func(cls *ClientService) ServiceModule <span class="cov0" title="0">{
                return NewEmployeeService(cls)
        }</span>,
        "place": func(cls *ClientService) ServiceModule <span class="cov0" title="0">{
                return NewPlaceService(cls)
        }</span>,
        "product": func(cls *ClientService) ServiceModule <span class="cov0" title="0">{
                return NewProductService(cls)
        }</span>,
        "project": func(cls *ClientService) ServiceModule <span class="cov0" title="0">{
                return NewProjectService(cls)
        }</span>,
        "tool": func(cls *ClientService) ServiceModule <span class="cov0" title="0">{
                return NewToolService(cls)
        }</span>,
        "trans": func(cls *ClientService) ServiceModule <span class="cov0" title="0">{
                return NewTransService(cls)
        }</span>,
}

func NewClientService(config cu.IM, appLog *slog.Logger) *ClientService <span class="cov0" title="0">{
        cls := &amp;ClientService{
                Config:       config,
                AppLog:       appLog,
                Session:      api.NewSession(config, "", cu.ToString(config["NT_SESSION_ALIAS"], "")),
                NewDataStore: api.NewDataStore,
                Modules:      map[string]ServiceModule{},
                UI:           cp.NewClientComponent(),
        }
        for key, fn := range moduleMap </span><span class="cov0" title="0">{
                cls.Modules[key] = fn(cls)
        }</span>
        <span class="cov0" title="0">cls.AuthConfigs = cls.getAuthConfig()
        return cls</span>
}

func (cls *ClientService) getDataStore(alias string) *api.DataStore <span class="cov8" title="1">{
        return cls.NewDataStore(cls.Config, alias, cls.AppLog)
}</span>

func (cls *ClientService) getAuthConfig() (authMap map[string]*oauth2.Config) <span class="cov0" title="0">{
        cfMap := map[string]*oauth2.Config{
                "NT_GOOGLE_CLIENT": {
                        ClientID:     cu.ToString(cls.Config["NT_GOOGLE_CLIENT_ID"], ""),
                        ClientSecret: cu.ToString(cls.Config["NT_GOOGLE_CLIENT_SECRET"], ""),
                        RedirectURL:  st.AuthRedirectURL,
                        Scopes:       []string{"email"},
                        Endpoint:     google.Endpoint,
                },
        }
        authMap = map[string]*oauth2.Config{}
        for _, key := range []string{"NT_GOOGLE_CLIENT", "NT_FACEBOOK_CLIENT", "NT_GITHUB_CLIENT", "NT_MICROSOFT_CLIENT"} </span><span class="cov0" title="0">{
                if cu.ToString(cls.Config[key+"_ID"], "") != "" &amp;&amp; cu.ToString(cls.Config[key+"_SECRET"], "") != "" </span><span class="cov0" title="0">{
                        authMap[key] = cfMap[key]
                }</span>
        }
        <span class="cov0" title="0">return authMap</span>
}

func (cls *ClientService) GetClient(host, sessionID, eventURL, lang, theme string) (client *ct.Client) <span class="cov0" title="0">{
        authButtons := func() (authBtn []ct.LoginAuthButton) </span><span class="cov0" title="0">{
                btnValue := cu.SM{
                        "NT_GOOGLE_CLIENT":    "google,Google,Google",
                        "NT_FACEBOOK_CLIENT":  "facebook,Facebook,Facebook",
                        "NT_GITHUB_CLIENT":    "github,Github,Github",
                        "NT_MICROSOFT_CLIENT": "microsoft,Microsoft,Microsoft",
                }
                authBtn = []ct.LoginAuthButton{}
                for key := range cls.AuthConfigs </span><span class="cov0" title="0">{
                        authBtn = append(authBtn, ct.LoginAuthButton{
                                Id:    strings.Split(btnValue[key], ",")[0],
                                Label: strings.Split(btnValue[key], ",")[1],
                                Icon:  strings.Split(btnValue[key], ",")[2],
                        })
                }</span>
                <span class="cov0" title="0">return authBtn</span>
        }
        <span class="cov0" title="0">cli := &amp;ct.Client{
                BaseComponent: ct.BaseComponent{
                        Id:           sessionID + "_client",
                        EventURL:     eventURL,
                        OnResponse:   cls.MainResponse,
                        RequestValue: map[string]cu.IM{},
                        RequestMap:   map[string]ct.ClientComponent{},
                        Data:         cu.IM{},
                },
                Ticket: ct.Ticket{
                        Host:       host,
                        AuthMethod: "password",
                        Database:   cu.ToString(cls.Config["NT_DEFAULT_ALIAS"], ""),
                        SessionID:  sessionID,
                },
                LoginURL: st.ClientPath + "/auth/",
                //LoginDisabled:   false,
                LoginButtons: authButtons(),
                Version:      cu.ToString(cls.Config["version"], ""),
                //HideSideBar:     false,
                //HideMenu:        false,
                Lang:            lang,
                Theme:           theme,
                ClientLabels:    cls.UI.Labels,
                ClientMenu:      cls.UI.Menu,
                ClientSideBar:   cls.UI.SideBar,
                ClientLogin:     cls.UI.Login,
                ClientSearch:    cls.UI.Search,
                ClientBrowser:   cls.UI.Browser,
                ClientEditor:    cls.UI.Editor,
                ClientModalForm: cls.UI.ModalForm,
                ClientForm:      cls.UI.Form,
        }
        //cli.SetConfigValue("hide_exit", false)
        return cli</span>
}

func (cls *ClientService) LoadSession(sessionID string) (client *ct.Client, err error) <span class="cov0" title="0">{
        var memClient interface{}
        if memClient, err = cls.Session.LoadSession(sessionID, &amp;client); err == nil </span><span class="cov0" title="0">{
                if memClient, found := memClient.(*ct.Client); found </span><span class="cov0" title="0">{
                        client = memClient
                }</span> else<span class="cov0" title="0"> {
                        client.OnResponse = cls.MainResponse

                        client.ClientLabels = cls.UI.Labels
                        client.ClientMenu = cls.UI.Menu
                        client.ClientSideBar = cls.UI.SideBar
                        client.ClientLogin = cls.UI.Login
                        client.ClientSearch = cls.UI.Search
                        client.ClientBrowser = cls.UI.Browser
                        client.ClientEditor = cls.UI.Editor
                        client.ClientModalForm = cls.UI.ModalForm
                        client.ClientForm = cls.UI.Form
                        _, err = client.Render()
                }</span>
        }
        <span class="cov0" title="0">return client, err</span>
}

func (cls *ClientService) AuthUser(database, username string) (user cu.IM, err error) <span class="cov0" title="0">{
        ds := cls.getDataStore(database)
        if authUser, err := ds.AuthUser("", username); err == nil </span><span class="cov0" title="0">{
                user = cu.IM{
                        "id": authUser.Id, "code": authUser.Code,
                        "user_name": authUser.UserName, "user_group": authUser.UserGroup.String(),
                        "tags": authUser.AuthMeta.Tags, "auth_map": authUser.AuthMap,
                        "bookmarks": authUser.AuthMeta.Bookmarks, "auth_filter": authUser.AuthMeta.Filter,
                }
        }</span>
        <span class="cov0" title="0">return user, err</span>
}

func (cls *ClientService) userLogin(database, username, password string) (user cu.IM, err error) <span class="cov0" title="0">{
        ds := cls.getDataStore(database)

        if user, err = cls.AuthUser(database, username); err == nil </span><span class="cov0" title="0">{
                _, err = ds.UserLogin(username, password, false)
        }</span>
        <span class="cov0" title="0">return user, err</span>
}

func (cls *ClientService) codeName(ds *api.DataStore, code, model string) (name string) <span class="cov8" title="1">{
        if code != "" </span><span class="cov0" title="0">{
                if rows, err := ds.StoreDataQuery(md.Query{
                        Fields: []string{"*"}, From: model,
                        Filters: []md.Filter{
                                {Field: "code", Comp: "==", Value: code},
                        },
                }, true); err == nil </span><span class="cov0" title="0">{
                        name = cu.ToString(rows[0][model+"_name"], "")
                }</span>
        }
        <span class="cov8" title="1">return name</span>
}

func (cls *ClientService) evtMsg(name, triggerName, value, toastType string, timeout int64) ct.ResponseEvent <span class="cov8" title="1">{
        return ct.ResponseEvent{
                Trigger: &amp;ct.Toast{
                        Type:    toastType,
                        Value:   value,
                        Timeout: timeout,
                },
                TriggerName: triggerName,
                Name:        name,
                Header: cu.SM{
                        ct.HeaderRetarget: "#toast-msg",
                        ct.HeaderReswap:   "innerHTML",
                },
        }
}</span>

func (cls *ClientService) editorCodeSelector(evt ct.ResponseEvent, editor, codeType string, editorData cu.IM,
        resultUpdate func(params cu.IM) (re ct.ResponseEvent, err error)) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        values := cu.ToIM(evt.Value, cu.IM{})
        value := cu.ToString(values["value"], "")
        event := cu.ToString(values["event"], "")
        if fe, found := values["form_event"]; found </span><span class="cov0" title="0">{
                event = cu.ToString(fe, "")
        }</span>

        <span class="cov8" title="1">if event == ct.SelectorEventSearch </span><span class="cov0" title="0">{
                sConf := cls.UI.SearchConfig.View(codeType+"_simple", client.Labels())
                filters := client.ToFilters(cu.ToString(value, ""), sConf.Filters)
                var resultData cu.IM
                if resultData, err = cls.Modules["search"].Data(evt, cu.IM{
                        "view":    codeType + "_simple",
                        "query":   cls.UI.SearchConfig.Query(codeType+"_simple", cu.IM{"editor": editor}),
                        "filters": filters,
                }); err != nil </span><span class="cov0" title="0">{
                        return evt, err
                }</span>
                <span class="cov0" title="0">stateData[codeType+"_selector"] = cu.ToIMA(resultData["result"], []cu.IM{})
                return resultUpdate(cu.IM{"event": event, "dirty": false})</span>
        }
        <span class="cov8" title="1">if slices.Contains([]string{"transitem", "transmovement", "transpayment", "invoice"}, codeType) </span><span class="cov8" title="1">{
                codeType = "trans"
        }</span>
        <span class="cov8" title="1">if event == ct.SelectorEventSelected </span><span class="cov8" title="1">{
                valueData := cu.ToIM(values["value"], cu.IM{})
                selectedRow := cu.ToIM(valueData["row"], cu.IM{})
                editorData[codeType+"_code"] = selectedRow["code"]
                if cu.ToString(selectedRow[codeType+"_name"], "") != "" </span><span class="cov8" title="1">{
                        stateData[codeType+"_name"] = selectedRow[codeType+"_name"]
                }</span>
                <span class="cov8" title="1">return resultUpdate(cu.IM{"event": event, "dirty": true, "values": selectedRow})</span>
        }
        <span class="cov0" title="0">if event == ct.SelectorEventDelete </span><span class="cov0" title="0">{
                editorData[codeType+"_code"] = nil
                return resultUpdate(cu.IM{"event": event, "dirty": true})
        }</span>
        <span class="cov0" title="0">if event == ct.SelectorEventLink </span><span class="cov0" title="0">{
                selectValue := values["value"].(ct.SelectOption)
                stateData["params"] = cu.IM{
                        codeType + "_code": cu.ToString(selectValue.Value, ""),
                        "session_id":       client.Ticket.SessionID}
                if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("inputbox_dirty"),
                                "warning_message": client.Msg("inputbox_drop"),
                                "next":            codeType,
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, nil
                }</span> else<span class="cov0" title="0"> {
                        return cls.setEditor(evt, codeType, stateData["params"].(cu.IM)), nil
                }</span>
        }
        <span class="cov0" title="0">return evt, err</span>
}

func (cls *ClientService) showReportSelector(evt ct.ResponseEvent, refType, code string) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        userConfig := cu.ToIM(client.Ticket.User["auth_map"], cu.IM{})

        configReport := cu.ToIMA(stateData["config_report"], []cu.IM{})
        modal := cu.IM{
                "title":         code,
                "icon":          ct.IconChartBar,
                "config_data":   stateData["config_data"],
                "config_report": configReport,
                "code":          code,
                "ref_type":      refType,
                "orientation":   cu.ToString(userConfig["orientation"], st.DefaultOrientation),
                "paper_size":    cu.ToString(userConfig["paper_size"], st.DefaultPaperSize),
                "copy":          1,
                "auth_code":     cu.ToString(client.Ticket.User["code"], ""),
                "url_pdf":       fmt.Sprintf(st.ClientPath+"/session/export/report/modal/%s?output=pdf&amp;inline=true", client.Ticket.SessionID),
                "url_export":    fmt.Sprintf(st.ClientPath+"/session/export/report/modal/%s?output=pdf", client.Ticket.SessionID),
                "url_xml":       fmt.Sprintf(st.ClientPath+"/session/export/report/modal/%s?output=xml", client.Ticket.SessionID),
                "next":          "report_queue",
        }
        if len(configReport) &gt; 0 </span><span class="cov8" title="1">{
                modal["template"] = configReport[0]["report_key"]
        }</span>
        <span class="cov8" title="1">client.SetForm("report", modal, 0, true)
        return evt, err</span>
}

func (cls *ClientService) addMapField(evt ct.ResponseEvent, editorMap cu.IM,
        resultUpdate func(params cu.IM) (re ct.ResponseEvent, err error)) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        mapField := cu.ToString(stateData["map_field"], "")
        configMap := cu.ToIMA(stateData["config_map"], []cu.IM{})
        var defaultValue any = ""
        if idx := slices.IndexFunc(configMap, func(c cu.IM) bool </span><span class="cov8" title="1">{
                return cu.ToString(c["field_name"], "") == mapField
        }</span>); idx &gt; int(-1) <span class="cov8" title="1">{
                fieldType := cu.ToString(configMap[idx]["field_type"], "")
                fieldDesc := cu.ToString(configMap[idx]["description"], "")
                if slices.Contains([]string{
                        "FIELD_CUSTOMER", "FIELD_EMPLOYEE", "FIELD_PLACE", "FIELD_PRODUCT", "FIELD_PROJECT", "FIELD_TOOL",
                        "FIELD_TRANS_ITEM", "FIELD_TRANS_MOVEMENT", "FIELD_TRANS_PAYMENT"}, fieldType) </span><span class="cov8" title="1">{
                        model := strings.ToLower(strings.ReplaceAll(strings.ReplaceAll(fieldType, "FIELD_", ""), "TRANS_", ""))
                        modal := cu.IM{
                                "title":         client.Msg("map_new"),
                                "icon":          ct.IconUser,
                                "label":         fieldDesc,
                                "placeholder":   "",
                                "field_name":    "value",
                                "default_value": "",
                                "required":      false,
                                "next":          "editor_map_value",
                                "model":         model,
                                "map_field":     mapField,
                        }
                        client.SetForm("input_string", modal, 0, true)
                        return evt, nil
                }</span>
                <span class="cov8" title="1">defaultValue = cp.DefaultMapValue(fieldType)
                if fieldType == md.FieldTypeEnum.String() </span><span class="cov8" title="1">{
                        defaultValue = cu.ToString(ut.ToStringArray(configMap[idx]["tags"])[0], "")
                }</span>
        }
        <span class="cov8" title="1">editorMap[mapField] = defaultValue
        stateData["map_field"] = ""
        return resultUpdate(cu.IM{"dirty": true})</span>
}

func (cls *ClientService) updateMapField(evt ct.ResponseEvent, editorMap cu.IM,
        resultUpdate func(params cu.IM) (re ct.ResponseEvent, err error)) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        ds := cls.getDataStore(client.Ticket.Database)

        values := cu.ToIM(evt.Value, cu.IM{})
        valueData := cu.ToIM(values["value"], cu.IM{})
        row := cu.ToIM(valueData["row"], cu.IM{})
        fieldName := cu.ToString(row["field_name"], "")
        fieldType := cu.ToString(row["field_type"], "")
        if slices.Contains([]string{
                "FIELD_CUSTOMER", "FIELD_EMPLOYEE", "FIELD_PLACE", "FIELD_PRODUCT", "FIELD_PROJECT", "FIELD_TOOL",
                "FIELD_TRANS_ITEM", "FIELD_TRANS_MOVEMENT", "FIELD_TRANS_PAYMENT"}, fieldType) </span><span class="cov8" title="1">{
                model := strings.ToLower(strings.ReplaceAll(strings.ReplaceAll(fieldType, "FIELD_", ""), "TRANS_", ""))
                if _, err := ds.GetDataByID(model, 0, cu.ToString(row["value"], ""), true); err != nil </span><span class="cov8" title="1">{
                        errMsg := fmt.Sprintf("%s: %s (%s)", client.Msg("invalid_code"), cu.ToString(row["value"], ""), model)
                        return evt, errors.New(errMsg)
                }</span>
        }
        <span class="cov8" title="1">editorMap[fieldName] = row["value"]
        return resultUpdate(cu.IM{"dirty": true})</span>
}

func (cls *ClientService) editorFormOK(evt ct.ResponseEvent, rows []cu.IM, customValues map[string]func(value any)) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})

        for field := range frmValue </span><span class="cov8" title="1">{
                if fn, ok := customValues["frm_"+field]; ok </span><span class="cov0" title="0">{
                        fn(frmValue[field])
                }</span> else<span class="cov8" title="1"> if _, found := rows[frmIndex][field]; found </span><span class="cov8" title="1">{
                        rows[frmIndex][field] = frmValue[field]
                }</span>
        }
        <span class="cov8" title="1">for field := range frmBaseValues </span><span class="cov8" title="1">{
                if fn, ok := customValues["base_"+field]; ok </span><span class="cov8" title="1">{
                        fn(frmBaseValues[field])
                }</span>
        }
        <span class="cov8" title="1">stateData["dirty"] = true
        return evt, err</span>
}

func (cls *ClientService) editorFormTags(params cu.IM, evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        frmKey := cu.ToString(form["key"], "")
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})
        formEvent := cu.ToString(frmValues["form_event"], "")
        rowField := cu.ToString(params["row_field"], "tags")

        if formEvent == ct.ListEventAddItem </span><span class="cov8" title="1">{
                modal := cu.IM{
                        "title":         cu.ToString(params["title"], client.Msg("inputbox_new_tag")),
                        "icon":          cu.ToString(params["icon"], ct.IconTag),
                        "label":         cu.ToString(params["label"], client.Msg("inputbox_enter_tag")),
                        "placeholder":   "",
                        "field_name":    "value",
                        "default_value": "",
                        "required":      false,
                        "next":          "form_add_tag",
                        "frm_key":       frmKey,
                        "frm_index":     frmIndex,
                        "row":           frmBaseValues,
                        "row_field":     rowField,
                        "meta_name":     params["meta_name"],
                        "options":       params["options"],
                        "value":         params["value"],
                        "is_null":       params["is_null"],
                }
                client.SetForm(cu.ToString(params["form_key"], "input_string"), modal, 0, true)
                return evt, nil
        }</span>
        <span class="cov8" title="1">if formEvent == ct.ListEventDelete </span><span class="cov0" title="0">{
                metaName := ut.MetaName(frmBaseValues, cu.ToString(params["meta_name"], "_meta"))
                tags := ut.ToStringArray(frmBaseValues[rowField])
                if metaName != "" </span><span class="cov0" title="0">{
                        tags = ut.ToStringArray(cu.ToIM(frmBaseValues[metaName], cu.IM{})[rowField])
                }</span>
                <span class="cov0" title="0">row := cu.ToIM(frmValue["row"], cu.IM{})
                if idx := slices.Index(tags, cu.ToString(row["tag"], "")); idx &gt; int(-1) </span><span class="cov0" title="0">{
                        tags = append(tags[:idx], tags[idx+1:]...)
                        if metaName != "" </span><span class="cov0" title="0">{
                                cu.ToIM(frmBaseValues[metaName], cu.IM{})[rowField] = tags
                        }</span> else<span class="cov0" title="0"> {
                                frmBaseValues[rowField] = tags
                        }</span>
                }
                <span class="cov0" title="0">stateData["dirty"] = true
                client.SetForm(cu.ToString(stateData["view"], ""), frmBaseValues, frmIndex, false)
                return evt, nil</span>
        }
        <span class="cov8" title="1">return evt, nil</span>
}

func (cls *ClientService) editorTags(evt ct.ResponseEvent, editorMeta cu.IM,
        resultUpdate func(params cu.IM) (re ct.ResponseEvent, err error)) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        values := cu.ToIM(evt.Value, cu.IM{})
        event := cu.ToString(values["event"], "")

        if event == ct.ListEventAddItem </span><span class="cov8" title="1">{
                modal := cu.IM{
                        "title":         client.Msg("inputbox_new_tag"),
                        "icon":          ct.IconTag,
                        "label":         client.Msg("inputbox_enter_tag"),
                        "placeholder":   "",
                        "field_name":    "value",
                        "default_value": "",
                        "required":      false,
                        "next":          "editor_add_tag",
                }
                client.SetForm("input_string", modal, 0, true)
                return evt, nil
        }</span>
        <span class="cov8" title="1">if event == ct.ListEventDelete </span><span class="cov8" title="1">{
                tags := ut.ToStringArray(editorMeta["tags"])
                valueData := cu.ToIM(values["value"], cu.IM{})
                row := cu.ToIM(valueData["row"], cu.IM{})
                if idx := slices.Index(tags, cu.ToString(row["tag"], "")); idx &gt; int(-1) </span><span class="cov8" title="1">{
                        tags = append(tags[:idx], tags[idx+1:]...)
                        editorMeta["tags"] = tags
                }</span>
        }
        <span class="cov8" title="1">return resultUpdate(cu.IM{"event": event, "dirty": true})</span>
}

func (cls *ClientService) addBookmark(evt ct.ResponseEvent, bm md.Bookmark) ct.ResponseEvent <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        ds := cls.getDataStore(client.Ticket.Database)
        var err error
        var authUser md.Auth
        if authUser, err = ds.AuthUser(cu.ToString(client.Ticket.User["code"], ""), ""); err == nil </span><span class="cov8" title="1">{
                authUser.AuthMeta.Bookmarks = append(authUser.AuthMeta.Bookmarks, bm)
                var bookmarks []cu.IM
                if err = ut.ConvertToType(authUser.AuthMeta.Bookmarks, &amp;bookmarks); err == nil </span><span class="cov8" title="1">{
                        client.Ticket.User["bookmarks"] = bookmarks
                }</span>
                <span class="cov8" title="1">values := cu.IM{}
                ut.ConvertByteToIMData(authUser.AuthMeta, values, "auth_meta")
                update := md.Update{Values: values, Model: "auth", IDKey: authUser.Id}
                _, err = ds.StoreDataUpdate(update)</span>
        }
        <span class="cov8" title="1">if err != nil </span><span class="cov8" title="1">{
                return cls.evtMsg(evt.Name, evt.TriggerName, err.Error(), ct.ToastTypeError, 0)
        }</span>
        <span class="cov8" title="1">return evt</span>
}

func (cls *ClientService) deleteBookmark(evt ct.ResponseEvent) ct.ResponseEvent <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        ds := cls.getDataStore(client.Ticket.Database)
        bookmarks := cu.ToIMA(client.Ticket.User["bookmarks"], []cu.IM{})

        data := cu.ToIM(evt.Value, cu.IM{})
        value := cu.ToIM(data["value"], cu.IM{})
        idx := cu.ToInteger(value["index"], 0)

        var err error
        var authUser md.Auth
        if authUser, err = ds.AuthUser(cu.ToString(client.Ticket.User["code"], ""), ""); err == nil </span><span class="cov0" title="0">{
                if idx &lt; int64(len(authUser.AuthMeta.Bookmarks)) </span><span class="cov0" title="0">{
                        authUser.AuthMeta.Bookmarks = append(authUser.AuthMeta.Bookmarks[:idx], authUser.AuthMeta.Bookmarks[idx+1:]...)
                        bookmarks = append(bookmarks[:idx], bookmarks[idx+1:]...)
                }</span>
                <span class="cov0" title="0">client.Ticket.User["bookmarks"] = bookmarks
                values := cu.IM{}
                ut.ConvertByteToIMData(authUser.AuthMeta, values, "auth_meta")
                update := md.Update{Values: values, Model: "auth", IDKey: authUser.Id}
                _, err = ds.StoreDataUpdate(update)</span>
        }
        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                return cls.evtMsg(evt.Name, evt.TriggerName, err.Error(), ct.ToastTypeError, 0)
        }</span>
        <span class="cov0" title="0">return cls.mainResponseBookmark(evt)</span>
}

func (cls *ClientService) setBookmark(evt ct.ResponseEvent) ct.ResponseEvent <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        bookmarks := cu.ToIMA(client.Ticket.User["bookmarks"], []cu.IM{})

        evtData := cu.ToIM(evt.Value, cu.IM{})
        value := cu.ToIM(evtData["value"], cu.IM{})
        valueRow := cu.ToIM(value["row"], cu.IM{})
        idx := cu.ToInteger(valueRow["index"], cu.ToInteger(value["index"], 0))
        bookmark := bookmarks[idx]
        client.CloseModal()

        if cu.ToString(bookmark["bookmark_type"], "") == md.BookmarkTypeEditor.String() </span><span class="cov0" title="0">{
                return cls.setEditor(evt, cu.ToString(bookmark["key"], ""),
                        cu.IM{
                                "editor_view": cu.ToString(bookmark["key"], ""),
                                cu.ToString(bookmark["key"], "") + "_code": cu.ToString(bookmark["code"], ""),
                                "session_id": client.Ticket.SessionID,
                        })
        }</span>
        <span class="cov0" title="0">userConfig := cu.ToIM(client.Ticket.User["auth_map"], cu.IM{})
        client.SetSearch(cu.ToString(bookmark["key"], ""), cu.IM{
                "session_id":  client.Ticket.SessionID,
                "user_config": userConfig,
                "auth_filter": client.Ticket.User["auth_filter"],
                "user_group":  client.Ticket.User["user_group"],
                cu.ToString(bookmark["key"], ""): cu.IM{
                        "filters":         bookmark["filters"],
                        "visible_columns": bookmark["columns"],
                },
        }, false)
        return evt</span>
}

func (cls *ClientService) setEditor(evt ct.ResponseEvent, module string, params cu.IM) ct.ResponseEvent <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        var moData cu.IM = cu.IM{}
        var err error
        if sm, found := cls.Modules[module]; found </span><span class="cov0" title="0">{
                if moData, err = sm.Data(evt, params); err != nil </span><span class="cov0" title="0">{
                        return cls.evtMsg(evt.Name, evt.TriggerName, err.Error(), ct.ToastTypeError, 0)
                }</span>
        }
        <span class="cov8" title="1">client.SetEditor(module, cu.ToString(params["editor_view"], module), moData)
        return evt</span>
}

func (cls *ClientService) searchEvent(evt ct.ResponseEvent) (re ct.ResponseEvent) <span class="cov0" title="0">{
        var err error
        client := evt.Trigger.(*ct.Client)
        _, stateKey, stateData := client.GetStateData()
        var filter string = cu.ToString(evt.Value, "")
        sConf := cls.UI.SearchConfig.View(stateKey, client.Labels())
        var resultData cu.IM
        if resultData, err = cls.Modules["search"].Data(evt, cu.IM{
                "view":    stateKey,
                "query":   cls.UI.SearchConfig.Query(stateKey, cu.IM{"editor": ""}),
                "filters": client.GetSearchFilters(filter, sConf.Filters),
        }); err != nil </span><span class="cov0" title="0">{
                return cls.evtMsg(evt.Name, evt.TriggerName, err.Error(), ct.ToastTypeError, 0)
        }</span>
        <span class="cov0" title="0">stateData["rows"] = cu.ToIMA(resultData["result"], []cu.IM{})
        stateData["filter_value"] = filter
        client.SetSearch(stateKey, stateData, cu.ToBoolean(stateData["simple"], false))
        return evt</span>
}

func (cls *ClientService) insertPrintQueue(ds *api.DataStore, data cu.IM) (err error) <span class="cov8" title="1">{
        values := cu.IM{
                "config_type": md.ConfigTypePrintQueue.String(),
        }
        if configDataByte, err := ds.ConvertToByte(md.ConfigPrintQueue{
                RefType:     cu.ToString(data["ref_type"], ""),
                RefCode:     cu.ToString(data["code"], ""),
                Qty:         cu.ToInteger(data["copy"], 0),
                ReportCode:  cu.ToString(data["template"], ""),
                Orientation: cu.ToString(data["orientation"], ""),
                PaperSize:   cu.ToString(data["paper_size"], ""),
                AuthCode:    cu.ToString(data["auth_code"], ""),
        }); err == nil </span><span class="cov8" title="1">{
                values["data"] = string(configDataByte[:])
        }</span>
        <span class="cov8" title="1">_, err = ds.StoreDataUpdate(md.Update{Values: values, Model: "config"})
        return err</span>
}

func (cls *ClientService) mainResponseLogin(evt ct.ResponseEvent) (re ct.ResponseEvent) <span class="cov0" title="0">{
        var err error
        client := evt.Trigger.(*ct.Client)
        evtData := cu.ToIM(evt.Value, cu.IM{})
        username := cu.ToString(evtData["username"], "")
        password := cu.ToString(evtData["password"], "")
        database := cu.ToString(evtData["database"], cu.ToString(cls.Config["NT_DEFAULT_ALIAS"], ""))
        var user cu.IM
        if user, err = cls.userLogin(database, username, password); err != nil </span><span class="cov0" title="0">{
                return cls.evtMsg(evt.Name, evt.TriggerName, err.Error(), ct.ToastTypeError, 0)
        }</span>
        <span class="cov0" title="0">client.Ticket.Database = database
        client.Ticket.User = user
        client.Ticket.Expiry = time.Now().Add(time.Duration(cu.ToFloat(cls.Config["NT_SESSION_EXP"], 1)) * time.Hour)
        userConfig := cu.ToIM(user["auth_map"], cu.IM{})
        client.Lang = cu.ToString(userConfig["lang"], st.DefaultLang)
        client.Theme = cu.ToString(userConfig["theme"], st.DefaultTheme)
        client.SetSearch(st.DefaultSearchView, cu.IM{
                "user_config": userConfig,
                "auth_filter": user["auth_filter"],
                "user_group":  user["user_group"],
        }, true)

        url := fmt.Sprintf(st.ClientPath+"/session/%s", client.Ticket.SessionID)
        return cpu.EvtRedirect(ct.LoginEventLogin, evt.Name, url)</span>
}

func (cls *ClientService) mainResponseAuth(evt ct.ResponseEvent) (re ct.ResponseEvent) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        authConfig := cu.ToString(evt.Value, "")
        if config, found := cls.AuthConfigs[cu.ToString(evt.Value, "")]; found </span><span class="cov0" title="0">{
                config.RedirectURL = fmt.Sprintf(config.RedirectURL, client.Ticket.Host)
                verifier := oauth2.GenerateVerifier()
                url := config.AuthCodeURL(client.Ticket.SessionID, oauth2.AccessTypeOffline, oauth2.S256ChallengeOption(verifier))
                client.Data["verifier"] = verifier
                client.Data["auth_config"] = authConfig
                return cpu.EvtRedirect(ct.LoginEventAuth, evt.Name, url)
        }</span>
        <span class="cov0" title="0">return cls.evtMsg(evt.Name, evt.TriggerName, "Invalid oAuth provider", ct.ToastTypeError, 0)</span>
}

func (cls *ClientService) mainResponseLink(evt ct.ResponseEvent, evtData cu.IM) (re ct.ResponseEvent) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        row := cu.ToIM(evtData["row"], cu.IM{})
        fieldName := cu.ToString(evtData["fieldname"], "")
        fieldType := cu.ToString(row["field_type"], "")
        module := strings.Split(strings.TrimPrefix(fieldName, "ref_"), "_")[0]
        rowId := cu.ToString(row[module+"_id"], "")
        if fieldName == "value" &amp;&amp; fieldType == "FIELD_URL" </span><span class="cov0" title="0">{
                return cpu.EvtRedirect(evt.Name, evt.TriggerName, cu.ToString(row["value"], ""))
        }</span>
        <span class="cov0" title="0">if fieldName == "value" &amp;&amp; slices.Contains([]string{
                "FIELD_CUSTOMER", "FIELD_EMPLOYEE", "FIELD_PLACE", "FIELD_PRODUCT", "FIELD_PROJECT",
                "FIELD_TOOL", "FIELD_TRANS_ITEM", "FIELD_TRANS_MOVEMENT", "FIELD_TRANS_PAYMENT"}, fieldType) </span><span class="cov0" title="0">{
                module = strings.ToLower(strings.TrimPrefix(fieldType, "FIELD_"))
                return cls.setEditor(evt, module, cu.IM{
                        "editor_view":    module,
                        module + "_code": cu.ToString(row["value"], ""),
                        "session_id":     client.Ticket.SessionID,
                })
        }</span>
        <span class="cov0" title="0">if strings.HasSuffix(fieldName, "_code") </span><span class="cov0" title="0">{
                return cls.setEditor(evt, module, cu.IM{
                        "editor_view":                         module,
                        strings.TrimPrefix(fieldName, "ref_"): cu.ToString(row[fieldName], ""),
                        "session_id":                          client.Ticket.SessionID,
                })
        }</span>
        <span class="cov0" title="0">if fieldName == "code" </span><span class="cov0" title="0">{
                module = cu.ToString(row["editor"], "")
                rowId = cu.ToString(row["id"], "")
        }</span>
        <span class="cov0" title="0">return cls.setEditor(evt, module, cu.IM{
                "editor_view":  cu.ToString(row["editor_view"], ""),
                module + "_id": rowId,
                "session_id":   client.Ticket.SessionID,
        })</span>
}

func (cls *ClientService) mainResponseBookmark(evt ct.ResponseEvent) (re ct.ResponseEvent) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        var listRows []cu.IM = []cu.IM{}
        bookmarks := cu.ToIMA(client.Ticket.User["bookmarks"], []cu.IM{})
        for idx, bookmark := range bookmarks </span><span class="cov0" title="0">{
                listRows = append(listRows, cu.IM{
                        "lslabel": cu.ToString(bookmark["label"], ""),
                        "lsvalue": cu.ToString(bookmark["code"], "") +
                                " - " + client.Msg(cu.ToString(bookmark["bookmark_type"], "")),
                        "index": idx,
                })
        }</span>
        <span class="cov0" title="0">modal := cu.IM{
                "title":       client.Msg("bookmark_title"),
                "icon":        ct.IconSearch,
                "edit_item":   true,
                "edit_icon":   ct.IconStar,
                "list_filter": true,
                "delete_item": true,
                "rows":        listRows,
                "next":        "bookmark",
        }
        client.SetForm("selector", modal, 0, true)
        return evt</span>
}

func (cls *ClientService) mainResponseModule(evt ct.ResponseEvent) (re ct.ResponseEvent) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        state, stateKey, stateData := client.GetStateData()

        value := cu.ToString(evt.Value, "")
        mdKey := stateKey
        if state == "search" || state == "browser" </span><span class="cov0" title="0">{
                mdKey = "search"
        }</span>
        <span class="cov0" title="0">if value != mdKey </span><span class="cov0" title="0">{
                if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                        modal := cu.IM{
                                "name":            "warning",
                                "warning_label":   client.Msg("inputbox_dirty"),
                                "warning_message": client.Msg("inputbox_drop"),
                                "next":            "set_" + value,
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt
                }</span>
                <span class="cov0" title="0">switch value </span>{
                case "bookmark":<span class="cov0" title="0">
                        return cls.mainResponseBookmark(evt)</span>
                case "search":<span class="cov0" title="0">
                        client.ResetEditor()
                        return evt</span>
                default:<span class="cov0" title="0">
                        return cls.setEditor(evt, value,
                                cu.IM{
                                        "editor_view": value,
                                        "session_id":  client.Ticket.SessionID,
                                })</span>
                }
        }
        <span class="cov0" title="0">return evt</span>
}

func (cls *ClientService) mainResponseModuleEvent(evt ct.ResponseEvent, nextKey string) (re ct.ResponseEvent) <span class="cov0" title="0">{
        var err error
        client := evt.Trigger.(*ct.Client)
        state, stateKey, stateData := client.GetStateData()

        moduleKey := cu.ToString(nextKey, stateKey)
        if values, ok := evt.Value.(cu.IM); ok &amp;&amp; cu.ToString(values["name"], "") == "bookmark" </span><span class="cov0" title="0">{
                if cu.ToString(values["event"], "") == "list_delete" </span><span class="cov0" title="0">{
                        return cls.deleteBookmark(evt)
                }</span>
                <span class="cov0" title="0">if cu.ToString(values["event"], "") == "list_filter_change" </span><span class="cov0" title="0">{
                        return evt
                }</span>
                <span class="cov0" title="0">return cls.setBookmark(evt)</span>
        }
        <span class="cov0" title="0">if (state == "search" || state == "browser") &amp;&amp; nextKey == "" </span><span class="cov0" title="0">{
                moduleKey = "search"
        }</span>
        <span class="cov0" title="0">if state == "form" </span><span class="cov0" title="0">{
                moduleKey = cu.ToString(stateData["key"], "")
        }</span>
        <span class="cov0" title="0">if sm, found := cls.Modules[moduleKey]; found </span><span class="cov0" title="0">{
                if evt, err = sm.Response(evt); err != nil </span><span class="cov0" title="0">{
                        return cls.evtMsg(evt.Name, evt.TriggerName, err.Error(), ct.ToastTypeError, 0)
                }</span>
        }
        <span class="cov0" title="0">return evt</span>
}

func (cls *ClientService) MainResponse(evt ct.ResponseEvent) (re ct.ResponseEvent) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, stateKey, _ := client.GetStateData()

        reMap := map[string]func() ct.ResponseEvent{
                ct.BrowserEventSearch: func() ct.ResponseEvent </span><span class="cov0" title="0">{
                        return cls.searchEvent(evt)
                }</span>,

                ct.SearchEventSearch: func() ct.ResponseEvent <span class="cov0" title="0">{
                        return cls.searchEvent(evt)
                }</span>,

                ct.TableEventEditCell: func() ct.ResponseEvent <span class="cov0" title="0">{
                        return cls.mainResponseLink(evt, cu.ToIM(evt.Value, cu.IM{}))
                }</span>,

                ct.TableEventAddItem: func() ct.ResponseEvent <span class="cov0" title="0">{
                        if slices.Contains([]string{"transitem", "transmovement", "transpayment"}, stateKey) </span><span class="cov0" title="0">{
                                return NewTransService(cls).createModal(evt,
                                        cu.IM{"state_key": stateKey, "next": stateKey + "_new"})
                        }</span>
                        <span class="cov0" title="0">module := stateKey
                        params := cu.IM{
                                "session_id": client.Ticket.SessionID,
                        }
                        prmMap := map[string]cu.IM{
                                "transmovement_formula": {
                                        "module":       "trans",
                                        "session_id":   client.Ticket.SessionID,
                                        "trans_type":   md.TransTypeFormula.String(),
                                        "direction":    md.DirectionTransfer.String(),
                                        "editor_title": client.Msg("trans_formula_new"),
                                        "editor_icon":  cp.TransTypeIcon("TRANS_FORMULA"),
                                },
                                "transmovement_waybill": {
                                        "module":       "trans",
                                        "session_id":   client.Ticket.SessionID,
                                        "trans_type":   md.TransTypeWaybill.String(),
                                        "direction":    md.DirectionOut.String(),
                                        "editor_title": client.Msg("trans_waybill_new"),
                                        "editor_icon":  cp.TransTypeIcon("TRANS_WAYBILL"),
                                },
                        }
                        if prm, found := prmMap[module]; found </span><span class="cov0" title="0">{
                                module = cu.ToString(prm["module"], "")
                                params = prm
                        }</span>
                        <span class="cov0" title="0">return cls.setEditor(evt, module, params)</span>
                },

                ct.BrowserEventEditRow: func() ct.ResponseEvent <span class="cov0" title="0">{
                        evtData := cu.ToIM(evt.Value, cu.IM{})
                        resultMap := map[string]func() ct.ResponseEvent{
                                stateKey: func() ct.ResponseEvent </span><span class="cov0" title="0">{
                                        return cls.setEditor(evt, cu.ToString(evtData["editor"], ""),
                                                cu.IM{
                                                        "editor_view": cu.ToString(evtData["editor_view"], ""),
                                                        cu.ToString(evtData["editor"], "") + "_id": cu.ToString(evtData["editor_id"], ""),
                                                        "session_id": client.Ticket.SessionID,
                                                })
                                }</span>,
                        }
                        <span class="cov0" title="0">return resultMap[stateKey]()</span>
                },

                ct.SearchEventSelected: func() ct.ResponseEvent <span class="cov0" title="0">{
                        evtData := cu.ToIM(evt.Value, cu.IM{})
                        evtRow := cu.ToIM(evtData["row"], cu.IM{})
                        resultMap := map[string]func() ct.ResponseEvent{
                                stateKey: func() ct.ResponseEvent </span><span class="cov0" title="0">{
                                        return cls.setEditor(evt, cu.ToString(evtRow["editor"], ""),
                                                cu.IM{
                                                        "editor_view": cu.ToString(evtRow["editor_view"], ""),
                                                        cu.ToString(evtRow["editor"], "") + "_id": cu.ToString(evtRow["editor_id"], ""),
                                                        "session_id": client.Ticket.SessionID,
                                                })
                                }</span>,
                        }
                        <span class="cov0" title="0">return resultMap[stateKey]()</span>
                },

                /*
                        ct.EditorEventView: func() ct.ResponseEvent {
                                //client.SetEditor(stateKey, cu.ToString(evt.Value, ""), stateData)
                                //client.SetProperty("editor_view", cu.ToString(evt.Value, ""))
                                //client.SetProperty("view", cu.ToString(evt.Value, ""))
                                return evt
                        },
                */

                ct.ClientEventModule: func() ct.ResponseEvent <span class="cov0" title="0">{
                        return cls.mainResponseModule(evt)
                }</span>,

                ct.FormEventOK: func() ct.ResponseEvent <span class="cov0" title="0">{
                        frmValues := cu.ToIM(evt.Value, cu.IM{})
                        frmData := cu.ToIM(frmValues["data"], cu.IM{})
                        switch frmData["next"] </span>{
                        case "set_search":<span class="cov0" title="0">
                                client.ResetEditor()
                                return evt</span>

                        case "set_setting":<span class="cov0" title="0">
                                return cls.setEditor(evt, "setting", cu.IM{
                                        "editor_view": "setting",
                                        "session_id":  client.Ticket.SessionID,
                                })</span>

                        case "set_bookmark":<span class="cov0" title="0">
                                return cls.mainResponseBookmark(evt)</span>

                        case "trans_new", "transitem_new", "transpayment_new", "transmovement_new":<span class="cov0" title="0">
                                return cls.mainResponseModuleEvent(evt, "trans")</span>

                        default:<span class="cov0" title="0">
                                return cls.mainResponseModuleEvent(evt, "")</span>
                        }
                },

                ct.FormEventChange: func() ct.ResponseEvent <span class="cov0" title="0">{
                        values := cu.ToIM(evt.Value, cu.IM{})
                        valueData := cu.ToIM(values["data"], cu.IM{})
                        return cls.mainResponseModuleEvent(evt, cu.ToString(valueData["module"], ""))
                }</span>,

                ct.ClientEventForm: func() ct.ResponseEvent <span class="cov0" title="0">{
                        return cls.mainResponseModuleEvent(evt, "")
                }</span>,

                ct.ClientEventSideMenu: func() ct.ResponseEvent <span class="cov0" title="0">{
                        return cls.mainResponseModuleEvent(evt, "")
                }</span>,

                ct.BrowserEventBookmark: func() ct.ResponseEvent <span class="cov0" title="0">{
                        return cls.mainResponseModuleEvent(evt, "")
                }</span>,

                ct.EditorEventField: func() ct.ResponseEvent <span class="cov0" title="0">{
                        evtData := cu.ToIM(evt.Value, cu.IM{})
                        fieldName := cu.ToString(evtData["name"], "")
                        values := cu.ToIM(evtData["value"], cu.IM{})
                        row := cu.ToIM(values["row"], cu.IM{})
                        editor := cu.ToString(row["editor"], "")
                        if fieldName == ct.TableEventEditCell &amp;&amp; editor == "" </span><span class="cov0" title="0">{
                                return cls.mainResponseLink(evt, cu.ToIM(evtData["value"], cu.IM{}))
                        }</span>
                        <span class="cov0" title="0">return cls.mainResponseModuleEvent(evt, editor)</span>
                },

                ct.LoginEventLogin: func() ct.ResponseEvent <span class="cov0" title="0">{
                        return cls.mainResponseLogin(evt)
                }</span>,

                ct.LoginEventAuth: func() ct.ResponseEvent <span class="cov0" title="0">{
                        return cls.mainResponseAuth(evt)
                }</span>,

                ct.ClientEventLogOut: func() ct.ResponseEvent <span class="cov0" title="0">{
                        client.Ticket.User = nil
                        client.Ticket.Expiry = time.Now()
                        return cpu.EvtRedirect(ct.LoginEventAuth, evt.Name, client.LoginURL)
                }</span>,
        }

        <span class="cov0" title="0">if rm, found := reMap[evt.Name]; found </span><span class="cov0" title="0">{
                return rm()
        }</span>
        <span class="cov0" title="0">return evt</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package service

import (
        "fmt"
        "slices"
        "time"

        ct "github.com/nervatura/component/pkg/component"
        cu "github.com/nervatura/component/pkg/util"
        api "github.com/nervatura/nervatura/v6/pkg/api"
        md "github.com/nervatura/nervatura/v6/pkg/model"
        ut "github.com/nervatura/nervatura/v6/pkg/service/utils"
)

type CustomerService struct {
        cls *ClientService
}

func NewCustomerService(cls *ClientService) *CustomerService <span class="cov0" title="0">{
        return &amp;CustomerService{
                cls: cls,
        }
}</span>

func (s *CustomerService) Data(evt ct.ResponseEvent, params cu.IM) (data cu.IM, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        ds := s.cls.getDataStore(client.Ticket.Database)
        user := cu.ToIM(client.Ticket.User, cu.IM{})

        data = cu.IM{
                "customer": cu.IM{
                        "customer_type": md.CustomerType(0),
                        "customer_meta": cu.IM{
                                "tags": []string{},
                        },
                        "customer_map": cu.IM{},
                        "addresses":    []cu.IM{},
                        "contacts":     []cu.IM{},
                        "events":       []cu.IM{},
                },
                "config_map":    cu.IM{},
                "config_data":   cu.IM{},
                "config_report": cu.IM{},
                "user":          user,
                "dirty":         false,
                "editor_icon":   ct.IconUser,
                "editor_title":  "",
        }

        if cu.ToString(params["customer_id"], "") != "" || cu.ToString(params["customer_code"], "") != "" </span><span class="cov0" title="0">{
                var customers []cu.IM = []cu.IM{}
                if customers, err = ds.StoreDataQuery(md.Query{
                        Fields: []string{"*"}, From: "customer",
                        Filters: []md.Filter{
                                {Field: "deleted", Comp: "==", Value: false},
                                {Field: "id", Comp: "==", Value: cu.ToInteger(params["customer_id"], 0)},
                                {Or: true, Field: "code", Comp: "==", Value: cu.ToString(params["customer_code"], "")},
                        },
                }, false); err != nil </span><span class="cov0" title="0">{
                        return data, err
                }</span>
                <span class="cov0" title="0">if len(customers) &gt; 0 </span><span class="cov0" title="0">{
                        data["customer"] = customers[0]
                        data["editor_title"] = cu.ToString(customers[0]["code"], "")
                }</span>
        }

        <span class="cov0" title="0">var rows []cu.IM = []cu.IM{}
        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_map",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_map"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_data",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_data"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"id", "report_key", "report_name"}, From: "config_report",
                Filters: []md.Filter{
                        {Field: "report_type", Comp: "==", Value: "CUSTOMER"},
                },
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_report"] = rows

        return data, err</span>
}

func (s *CustomerService) Response(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        switch evt.Name </span>{
        case ct.FormEventOK:<span class="cov0" title="0">
                return s.formNext(evt)</span>

        case ct.ClientEventForm:<span class="cov0" title="0">
                return s.formEvent(evt)</span>

        case ct.ClientEventSideMenu:<span class="cov0" title="0">
                return s.sideMenu(evt)</span>

        default:<span class="cov0" title="0">
                return s.editorField(evt)</span>
        }
}

func (s *CustomerService) update(ds *api.DataStore, data cu.IM) (editor cu.IM, err error) <span class="cov0" title="0">{
        var customer md.Customer = md.Customer{}
        ut.ConvertToType(data["customer"], &amp;customer)
        values := cu.IM{
                "customer_type": customer.CustomerType.String(),
                "customer_name": customer.CustomerName,
        }
        if customer.Code != "" </span><span class="cov0" title="0">{
                values["code"] = customer.Code
        }</span>

        <span class="cov0" title="0">ut.ConvertByteToIMData(customer.Contacts, values, "contacts")
        ut.ConvertByteToIMData(customer.Addresses, values, "addresses")
        ut.ConvertByteToIMData(customer.Events, values, "events")
        ut.ConvertByteToIMData(customer.CustomerMeta, values, "customer_meta")
        ut.ConvertByteToIMData(customer.CustomerMap, values, "customer_map")

        var customerID int64
        newCustomer := (customer.Id == 0)
        update := md.Update{Values: values, Model: "customer"}
        if !newCustomer </span><span class="cov0" title="0">{
                update.IDKey = customer.Id
        }</span>
        <span class="cov0" title="0">if customerID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newCustomer </span><span class="cov0" title="0">{
                var customers []cu.IM = []cu.IM{}
                if customers, err = ds.StoreDataGet(cu.IM{"id": customerID, "model": "customer"}, true); err == nil </span><span class="cov0" title="0">{
                        data["customer"] = customers[0]
                        data["editor_title"] = cu.ToString(cu.ToIM(customers[0], cu.IM{})["code"], "")
                }</span>
        }
        <span class="cov0" title="0">return data, err</span>
}

func (s *CustomerService) delete(ds *api.DataStore, customerID int64) (err error) <span class="cov0" title="0">{
        return ds.DataDelete("customer", customerID, "")
}</span>

func (s *CustomerService) formNext(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        customer := cu.ToIM(stateData["customer"], cu.IM{})
        customerMeta := cu.ToIM(customer["customer_meta"], cu.IM{})
        customerMap := cu.ToIM(customer["customer_map"], cu.IM{})

        resultUpdate := func(dirty bool) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                customer["customer_meta"] = customerMeta
                customer["customer_map"] = customerMap
                stateData["customer"] = customer
                if dirty </span><span class="cov0" title="0">{
                        stateData["dirty"] = dirty
                }</span>
                <span class="cov0" title="0">client.SetEditor("customer", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})

        nextMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_cancel": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        client.ResetEditor()
                        return evt, err
                }</span>,

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if err = s.delete(ds, cu.ToInteger(customer["id"], 0)); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">client.ResetEditor()
                        return evt, err</span>
                },

                "editor_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(customerMeta["tags"])
                                if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        customerMeta["tags"] = tags
                                        return resultUpdate(true)
                                }</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "form_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        frmKey := cu.ToString(frmData["frm_key"], "")
                        frmIndex := cu.ToInteger(frmData["frm_index"], 0)
                        row := cu.ToIM(frmData["row"], cu.IM{})
                        metaName := ut.MetaName(row, "_meta")
                        rowField := cu.ToString(frmData["row_field"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(row[rowField])
                                if metaName != "" </span><span class="cov0" title="0">{
                                        tags = ut.ToStringArray(cu.ToIM(row[metaName], cu.IM{})[rowField])
                                }</span>
                                <span class="cov0" title="0">if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        if metaName != "" </span><span class="cov0" title="0">{
                                                cu.ToIM(row[metaName], cu.IM{})[rowField] = tags
                                        }</span> else<span class="cov0" title="0"> {
                                                row[rowField] = tags
                                        }</span>
                                        <span class="cov0" title="0">client.SetForm(frmKey, row, frmIndex, false)
                                        return evt, nil</span>
                                }
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "bookmark_add": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        label := cu.ToString(frmValue["value"], "")
                        bookmark := md.Bookmark{
                                BookmarkType: md.BookmarkTypeEditor,
                                Label:        label,
                                Key:          "customer",
                                Code:         cu.ToString(customer["code"], ""),
                                Filters:      []any{},
                                Columns:      map[string]bool{},
                                TimeStamp:    md.TimeDateTime{Time: time.Now()},
                        }
                        return s.cls.addBookmark(evt, bookmark), nil
                }</span>,

                "editor_map_value": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        code := cu.ToString(frmValue["value"], "")
                        model := cu.ToString(frmData["model"], "")
                        mapField := cu.ToString(frmData["map_field"], "")
                        if _, err := ds.GetDataByID(model, 0, code, true); err != nil </span><span class="cov0" title="0">{
                                frmData["label"] = fmt.Sprintf("%s: %s (%s)", client.Msg("invalid_code"), code, model)
                                frmData["default_value"] = code
                                frmData["invalid"] = true
                                client.SetForm("input_string", frmData, 0, true)
                                return evt, nil
                        }</span>
                        <span class="cov0" title="0">customerMap[mapField] = code
                        stateData["map_field"] = ""
                        return resultUpdate(true)</span>
                },
        }

        <span class="cov0" title="0">if fn, ok := nextMap[cu.ToString(frmData["next"], "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">return evt, err</span>
}

func (s *CustomerService) formEvent(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        customer := cu.ToIM(stateData["customer"], cu.IM{})

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        frmKey := cu.ToString(form["key"], "")
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})
        frmEvent := cu.ToString(frmValues["event"], "")
        rows := cu.ToIMA(customer[frmKey], []cu.IM{})
        if srows, found := stateData[frmKey]; found &amp;&amp; (len(rows) == 0) </span><span class="cov0" title="0">{
                rows = cu.ToIMA(srows, []cu.IM{})
        }</span>
        <span class="cov0" title="0">delete := (cu.ToString(frmValue["form_delete"], "") != "")

        resultUpdate := func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                if _, found := customer[frmKey]; found </span><span class="cov0" title="0">{
                        customer[frmKey] = rows
                }</span> else<span class="cov0" title="0"> {
                        stateData[frmKey] = rows
                }</span>
                <span class="cov0" title="0">stateData["dirty"] = true
                return evt, err</span>
        }

        <span class="cov0" title="0">eventMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.FormEventOK: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        //rowMeta := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_meta")], cu.IM{})
                        //rowMap := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_map")], cu.IM{})
                        customValues := map[string]func(value any){
                                "base_tags": func(value any) </span><span class="cov0" title="0">{
                                        rows[frmIndex]["tags"] = value
                                }</span>,
                        }
                        <span class="cov0" title="0">return s.cls.editorFormOK(evt, rows, customValues)</span>
                },

                ct.FormEventCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if delete </span><span class="cov0" title="0">{
                                if _, found := stateData[frmKey]; found </span><span class="cov0" title="0">{
                                        deleteRows := cu.ToIMA(stateData[frmKey+"_delete"], []cu.IM{})
                                        deleteRows = append(deleteRows, rows[frmIndex])
                                        stateData[frmKey+"_delete"] = deleteRows
                                }</span>
                                <span class="cov0" title="0">rows = append(rows[:frmIndex], rows[frmIndex+1:]...)
                                return resultUpdate()</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                ct.FormEventChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        fieldName := cu.ToString(frmValues["name"], "")
                        switch fieldName </span>{
                        case "tags":<span class="cov0" title="0">
                                return s.cls.editorFormTags(cu.IM{"row_field": fieldName}, evt)</span>
                        default:<span class="cov0" title="0">
                                frmBaseValues[fieldName] = frmValues["value"]
                                cu.ToSM(evt.Header, cu.SM{})[ct.HeaderReswap] = ct.SwapNone</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },
        }

        <span class="cov0" title="0">if len(rows) &gt; 0 &amp;&amp; frmIndex &lt; int64(len(rows)) </span><span class="cov0" title="0">{
                if fn, ok := eventMap[frmEvent]; ok </span><span class="cov0" title="0">{
                        return fn()
                }</span>
        }

        <span class="cov0" title="0">return evt, err</span>
}

func (s *CustomerService) sideMenu(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        customer := cu.ToIM(stateData["customer"], cu.IM{})
        ds := s.cls.getDataStore(client.Ticket.Database)

        menuMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_save": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        if stateData, err = s.update(ds, stateData); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">stateData["dirty"] = false
                        client.SetEditor("customer", cu.ToString(stateData["view"], ""), stateData)
                        return evt, err</span>
                },

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("inputbox_delete"),
                                "warning_message": "",
                                "next":            "editor_delete",
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, err
                }</span>,

                "editor_cancel": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_dirty"),
                                        "warning_message": client.Msg("inputbox_drop"),
                                        "next":            "editor_cancel",
                                }
                                client.SetForm("warning", modal, 0, true)
                        }</span> else<span class="cov0" title="0"> {
                                client.ResetEditor()
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "editor_new": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.setEditor(evt, "customer",
                                cu.IM{
                                        "session_id": client.Ticket.SessionID,
                                }), nil
                }</span>,

                "editor_report": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.showReportSelector(evt, "CUSTOMER", cu.ToString(customer["code"], ""))
                }</span>,

                "editor_bookmark": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "title":         client.Msg("bookmark_new"),
                                "icon":          ct.IconStar,
                                "label":         client.Msg("bookmark_enter"),
                                "placeholder":   "",
                                "field_name":    "value",
                                "default_value": "",
                                "required":      false,
                                "next":          "bookmark_add",
                        }
                        client.SetForm("input_string", modal, 0, true)
                        return evt, nil
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := menuMap[cu.ToString(evt.Value, "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>

        <span class="cov0" title="0">return evt, err</span>
}

func (s *CustomerService) editorField(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        customer := cu.ToIM(stateData["customer"], cu.IM{})
        customerMeta := cu.ToIM(customer["customer_meta"], cu.IM{})
        customerMap := cu.ToIM(customer["customer_map"], cu.IM{})

        resultUpdate := func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                customer["customer_meta"] = customerMeta
                customer["customer_map"] = customerMap
                stateData["customer"] = customer
                if cu.ToBoolean(params["dirty"], false) </span><span class="cov0" title="0">{
                        stateData["dirty"] = true
                }</span>
                <span class="cov0" title="0">client.SetEditor("customer", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">values := cu.ToIM(evt.Value, cu.IM{})
        fieldName := cu.ToString(values["name"], "")
        value := cu.ToString(values["value"], "")

        fieldMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.TableEventRowSelected: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        client.SetForm(cu.ToString(stateData["view"], ""), cu.ToIM(valueData["row"], cu.IM{}), cu.ToInteger(valueData["index"], 0), false)
                        return evt, nil
                }</span>,

                ct.TableEventAddItem: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        view := cu.ToString(stateData["view"], "")
                        typeMap := map[string]func() cu.IM{
                                "addresses": func() cu.IM </span><span class="cov0" title="0">{
                                        var address cu.IM
                                        ut.ConvertToType(md.Address{
                                                Tags:       []string{},
                                                AddressMap: cu.IM{},
                                        }, &amp;address)
                                        return address
                                }</span>,
                                "contacts": func() cu.IM <span class="cov0" title="0">{
                                        var contact cu.IM
                                        ut.ConvertToType(md.Contact{
                                                Tags:       []string{},
                                                ContactMap: cu.IM{},
                                        }, &amp;contact)
                                        return contact
                                }</span>,
                                "events": func() cu.IM <span class="cov0" title="0">{
                                        var event cu.IM
                                        ut.ConvertToType(md.Event{
                                                Tags:     []string{},
                                                EventMap: cu.IM{},
                                        }, &amp;event)
                                        return event
                                }</span>,
                        }
                        <span class="cov0" title="0">if slices.Contains([]string{"addresses", "contacts", "events"}, view) </span><span class="cov0" title="0">{
                                getBase := func() (base cu.IM) </span><span class="cov0" title="0">{
                                        if _, found := customer[view]; found </span><span class="cov0" title="0">{
                                                return customer
                                        }</span>
                                        <span class="cov0" title="0">return stateData</span>
                                }
                                <span class="cov0" title="0">base := getBase()
                                rows := cu.ToIMA(base[view], []cu.IM{})
                                rows = append(rows, typeMap[view]())
                                base[view] = rows
                                client.SetForm(view, cu.MergeIM(typeMap[view](), cu.IM{}), cu.ToInteger(len(rows)-1, 0), false)
                                return evt, nil</span>
                        }
                        <span class="cov0" title="0">return s.cls.addMapField(evt, customerMap, resultUpdate)</span>
                },

                ct.TableEventFormDelete: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        row := cu.ToIM(valueData["row"], cu.IM{})
                        fieldName := cu.ToString(row["field_name"], "")
                        delete(customerMap, fieldName)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                ct.TableEventFormUpdate: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.updateMapField(evt, customerMap, resultUpdate)
                }</span>,

                ct.TableEventFormChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                ct.TableEventFormCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                "map_field": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        stateData["map_field"] = value
                        return resultUpdate(cu.IM{"dirty": false})
                }</span>,

                "queue": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.ToIM(client.Data["modal"], cu.IM{})
                        modalData := cu.ToIM(modal["data"], cu.IM{})
                        if err = s.cls.insertPrintQueue(ds, modalData); err == nil </span><span class="cov0" title="0">{
                                return s.cls.evtMsg(evt.Name, evt.TriggerName, client.Msg("report_add_queue"), ct.ToastTypeSuccess, 5), nil
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "tags": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorTags(evt, customerMeta, resultUpdate)
                }</span>,

                "customer_name": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        customer[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "customer_type": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        customer[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        customerMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "terms": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        customerMeta[fieldName] = cu.ToInteger(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "credit_limit": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        customerMeta[fieldName] = cu.ToFloat(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "discount": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        customerMeta[fieldName] = cu.ToFloat(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "inactive": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        customerMeta[fieldName] = cu.ToBoolean(value, false)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "tax_free": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        customerMeta[fieldName] = cu.ToBoolean(value, false)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := fieldMap[fieldName]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">if slices.Contains([]string{"orientation", "template", "paper_size", "copy"}, fieldName) </span><span class="cov0" title="0">{
                modal := cu.ToIM(client.Data["modal"], cu.IM{})
                modalData := cu.ToIM(modal["data"], cu.IM{})
                modalData[fieldName] = value
                client.SetForm("report", modalData, 0, true)
                return evt, nil
        }</span>
        <span class="cov0" title="0">return evt, nil</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package service

import (
        "fmt"
        "slices"
        "time"

        ct "github.com/nervatura/component/pkg/component"
        cu "github.com/nervatura/component/pkg/util"
        api "github.com/nervatura/nervatura/v6/pkg/api"
        md "github.com/nervatura/nervatura/v6/pkg/model"
        ut "github.com/nervatura/nervatura/v6/pkg/service/utils"
)

type EmployeeService struct {
        cls *ClientService
}

func NewEmployeeService(cls *ClientService) *EmployeeService <span class="cov0" title="0">{
        return &amp;EmployeeService{
                cls: cls,
        }
}</span>

func (s *EmployeeService) Data(evt ct.ResponseEvent, params cu.IM) (data cu.IM, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        ds := s.cls.getDataStore(client.Ticket.Database)
        user := cu.ToIM(client.Ticket.User, cu.IM{})

        data = cu.IM{
                "employee": cu.IM{
                        "employee_meta": cu.IM{
                                "start_date": "",
                                "end_date":   "",
                                "tags":       []string{},
                        },
                        "employee_map": cu.IM{},
                        "address": cu.IM{
                                "tags":        []string{},
                                "address_map": cu.IM{},
                        },
                        "contact": cu.IM{
                                "tags":        []string{},
                                "contact_map": cu.IM{},
                        },
                        "events":     []cu.IM{},
                        "time_stamp": md.TimeDateTime{Time: time.Now()},
                },
                "config_map":    cu.IM{},
                "config_data":   cu.IM{},
                "config_report": cu.IM{},
                "user":          user,
                "dirty":         false,
                "editor_icon":   ct.IconUser,
                "editor_title":  "",
        }

        if cu.ToString(params["employee_id"], "") != "" || cu.ToString(params["employee_code"], "") != "" </span><span class="cov0" title="0">{
                var employees []cu.IM = []cu.IM{}
                if employees, err = ds.StoreDataQuery(md.Query{
                        Fields: []string{"*"}, From: "employee",
                        Filters: []md.Filter{
                                {Field: "deleted", Comp: "==", Value: false},
                                {Field: "id", Comp: "==", Value: cu.ToInteger(params["employee_id"], 0)},
                                {Or: true, Field: "code", Comp: "==", Value: cu.ToString(params["employee_code"], "")},
                        },
                }, false); err != nil </span><span class="cov0" title="0">{
                        return data, err
                }</span>
                <span class="cov0" title="0">if len(employees) &gt; 0 </span><span class="cov0" title="0">{
                        data["employee"] = employees[0]
                        data["editor_title"] = cu.ToString(employees[0]["code"], "")
                }</span>
        }

        <span class="cov0" title="0">var rows []cu.IM = []cu.IM{}
        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_map",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_map"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_data",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_data"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"id", "report_key", "report_name"}, From: "config_report",
                Filters: []md.Filter{
                        {Field: "report_type", Comp: "==", Value: "EMPLOYEE"},
                },
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_report"] = rows

        return data, err</span>
}

func (s *EmployeeService) update(ds *api.DataStore, data cu.IM) (editor cu.IM, err error) <span class="cov0" title="0">{
        var employee md.Employee = md.Employee{}
        ut.ConvertToType(data["employee"], &amp;employee)
        values := cu.IM{}
        if employee.Code != "" </span><span class="cov0" title="0">{
                values["code"] = employee.Code
        }</span>

        <span class="cov0" title="0">ut.ConvertByteToIMData(employee.Address, values, "address")
        ut.ConvertByteToIMData(employee.Contact, values, "contact")
        ut.ConvertByteToIMData(employee.Events, values, "events")
        ut.ConvertByteToIMData(employee.EmployeeMeta, values, "employee_meta")
        ut.ConvertByteToIMData(employee.EmployeeMap, values, "employee_map")

        var employeeID int64
        newEmployee := (employee.Id == 0)
        update := md.Update{Values: values, Model: "employee"}
        if !newEmployee </span><span class="cov0" title="0">{
                update.IDKey = employee.Id
        }</span>
        <span class="cov0" title="0">if employeeID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newEmployee </span><span class="cov0" title="0">{
                var employees []cu.IM = []cu.IM{}
                if employees, err = ds.StoreDataGet(cu.IM{"id": employeeID, "model": "employee"}, true); err == nil </span><span class="cov0" title="0">{
                        data["employee"] = employees[0]
                        data["editor_title"] = cu.ToString(cu.ToIM(employees[0], cu.IM{})["code"], "")
                }</span>
        }
        <span class="cov0" title="0">return data, err</span>
}

func (s *EmployeeService) delete(ds *api.DataStore, employeeID int64) (err error) <span class="cov0" title="0">{
        return ds.DataDelete("employee", employeeID, "")
}</span>

func (s *EmployeeService) formNext(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        employee := cu.ToIM(stateData["employee"], cu.IM{})
        employeeMeta := cu.ToIM(employee["employee_meta"], cu.IM{})
        employeeMap := cu.ToIM(employee["employee_map"], cu.IM{})

        resultUpdate := func(dirty bool) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                employee["employee_meta"] = employeeMeta
                employee["employee_map"] = employeeMap
                stateData["employee"] = employee
                if dirty </span><span class="cov0" title="0">{
                        stateData["dirty"] = dirty
                }</span>
                <span class="cov0" title="0">client.SetEditor("employee", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})

        nextMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_cancel": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        client.ResetEditor()
                        return evt, err
                }</span>,

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if err = s.delete(ds, cu.ToInteger(employee["id"], 0)); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">client.ResetEditor()
                        return evt, err</span>
                },

                "editor_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(employeeMeta["tags"])
                                if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        employeeMeta["tags"] = tags
                                        return resultUpdate(true)
                                }</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "form_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        frmKey := cu.ToString(frmData["frm_key"], "")
                        frmIndex := cu.ToInteger(frmData["frm_index"], 0)
                        row := cu.ToIM(frmData["row"], cu.IM{})
                        metaName := ut.MetaName(row, "_meta")
                        rowField := cu.ToString(frmData["row_field"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(row[rowField])
                                if metaName != "" </span><span class="cov0" title="0">{
                                        tags = ut.ToStringArray(cu.ToIM(row[metaName], cu.IM{})[rowField])
                                }</span>
                                <span class="cov0" title="0">if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        if metaName != "" </span><span class="cov0" title="0">{
                                                cu.ToIM(row[metaName], cu.IM{})[rowField] = tags
                                        }</span> else<span class="cov0" title="0"> {
                                                row[rowField] = tags
                                        }</span>
                                        <span class="cov0" title="0">client.SetForm(frmKey, row, frmIndex, false)
                                        return evt, nil</span>
                                }
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "bookmark_add": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        label := cu.ToString(frmValue["value"], "")
                        bookmark := md.Bookmark{
                                BookmarkType: md.BookmarkTypeEditor,
                                Label:        label,
                                Key:          "employee",
                                Code:         cu.ToString(employee["code"], ""),
                                Filters:      []any{},
                                Columns:      map[string]bool{},
                                TimeStamp:    md.TimeDateTime{Time: time.Now()},
                        }
                        return s.cls.addBookmark(evt, bookmark), nil
                }</span>,

                "editor_map_value": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        code := cu.ToString(frmValue["value"], "")
                        model := cu.ToString(frmData["model"], "")
                        mapField := cu.ToString(frmData["map_field"], "")
                        if _, err := ds.GetDataByID(model, 0, code, true); err != nil </span><span class="cov0" title="0">{
                                frmData["label"] = fmt.Sprintf("%s: %s (%s)", client.Msg("invalid_code"), code, model)
                                frmData["default_value"] = code
                                frmData["invalid"] = true
                                client.SetForm("input_string", frmData, 0, true)
                                return evt, nil
                        }</span>
                        <span class="cov0" title="0">employeeMap[mapField] = code
                        stateData["map_field"] = ""
                        return resultUpdate(true)</span>
                },
        }

        <span class="cov0" title="0">if fn, ok := nextMap[cu.ToString(frmData["next"], "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">return evt, err</span>
}

func (s *EmployeeService) formEvent(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        employee := cu.ToIM(stateData["employee"], cu.IM{})

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        frmKey := cu.ToString(form["key"], "")
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})
        frmEvent := cu.ToString(frmValues["event"], "")
        rows := cu.ToIMA(employee[frmKey], []cu.IM{})
        if srows, found := stateData[frmKey]; found &amp;&amp; (len(rows) == 0) </span><span class="cov0" title="0">{
                rows = cu.ToIMA(srows, []cu.IM{})
        }</span>
        <span class="cov0" title="0">delete := (cu.ToString(frmValue["form_delete"], "") != "")

        resultUpdate := func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                if _, found := employee[frmKey]; found </span><span class="cov0" title="0">{
                        employee[frmKey] = rows
                }</span> else<span class="cov0" title="0"> {
                        stateData[frmKey] = rows
                }</span>
                <span class="cov0" title="0">stateData["dirty"] = true
                return evt, err</span>
        }

        <span class="cov0" title="0">eventMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.FormEventOK: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        //rowMeta := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_meta")], cu.IM{})
                        //rowMap := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_map")], cu.IM{})
                        customValues := map[string]func(value any){
                                "base_tags": func(value any) </span><span class="cov0" title="0">{
                                        rows[frmIndex]["tags"] = value
                                }</span>,
                        }
                        <span class="cov0" title="0">return s.cls.editorFormOK(evt, rows, customValues)</span>
                },

                ct.FormEventCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if delete </span><span class="cov0" title="0">{
                                if _, found := stateData[frmKey]; found </span><span class="cov0" title="0">{
                                        deleteRows := cu.ToIMA(stateData[frmKey+"_delete"], []cu.IM{})
                                        deleteRows = append(deleteRows, rows[frmIndex])
                                        stateData[frmKey+"_delete"] = deleteRows
                                }</span>
                                <span class="cov0" title="0">rows = append(rows[:frmIndex], rows[frmIndex+1:]...)
                                return resultUpdate()</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                ct.FormEventChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        fieldName := cu.ToString(frmValues["name"], "")
                        switch fieldName </span>{
                        case "tags":<span class="cov0" title="0">
                                return s.cls.editorFormTags(cu.IM{"row_field": fieldName}, evt)</span>
                        default:<span class="cov0" title="0">
                                frmBaseValues[fieldName] = frmValues["value"]
                                cu.ToSM(evt.Header, cu.SM{})[ct.HeaderReswap] = ct.SwapNone</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },
        }

        <span class="cov0" title="0">if len(rows) &gt; 0 &amp;&amp; frmIndex &lt; int64(len(rows)) </span><span class="cov0" title="0">{
                if fn, ok := eventMap[frmEvent]; ok </span><span class="cov0" title="0">{
                        return fn()
                }</span>
        }

        <span class="cov0" title="0">return evt, err</span>
}

func (s *EmployeeService) sideMenu(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        employee := cu.ToIM(stateData["employee"], cu.IM{})
        ds := s.cls.getDataStore(client.Ticket.Database)

        menuMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_save": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        if stateData, err = s.update(ds, stateData); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">stateData["dirty"] = false
                        client.SetEditor("employee", cu.ToString(stateData["view"], ""), stateData)
                        return evt, err</span>
                },

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("inputbox_delete"),
                                "warning_message": "",
                                "next":            "editor_delete",
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, err
                }</span>,

                "editor_cancel": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_dirty"),
                                        "warning_message": client.Msg("inputbox_drop"),
                                        "next":            "editor_cancel",
                                }
                                client.SetForm("warning", modal, 0, true)
                        }</span> else<span class="cov0" title="0"> {
                                client.ResetEditor()
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "editor_new": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.setEditor(evt, "employee",
                                cu.IM{
                                        "session_id": client.Ticket.SessionID,
                                }), nil
                }</span>,

                "editor_report": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.showReportSelector(evt, "EMPLOYEE", cu.ToString(employee["code"], ""))
                }</span>,

                "editor_bookmark": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "title":         client.Msg("bookmark_new"),
                                "icon":          ct.IconStar,
                                "label":         client.Msg("bookmark_enter"),
                                "placeholder":   "",
                                "field_name":    "value",
                                "default_value": "",
                                "required":      false,
                                "next":          "bookmark_add",
                        }
                        client.SetForm("input_string", modal, 0, true)
                        return evt, nil
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := menuMap[cu.ToString(evt.Value, "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>

        <span class="cov0" title="0">return evt, err</span>
}

func (s *EmployeeService) editorField(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        employee := cu.ToIM(stateData["employee"], cu.IM{})
        employeeMeta := cu.ToIM(employee["employee_meta"], cu.IM{})
        employeeMap := cu.ToIM(employee["employee_map"], cu.IM{})
        address := cu.ToIM(employee["address"], cu.IM{})
        contact := cu.ToIM(employee["contact"], cu.IM{})

        resultUpdate := func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                employee["employee_meta"] = employeeMeta
                employee["employee_map"] = employeeMap
                employee["address"] = address
                employee["contact"] = contact
                stateData["employee"] = employee
                if cu.ToBoolean(params["dirty"], false) </span><span class="cov0" title="0">{
                        stateData["dirty"] = true
                }</span>
                <span class="cov0" title="0">client.SetEditor("employee", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">values := cu.ToIM(evt.Value, cu.IM{})
        fieldName := cu.ToString(values["name"], "")
        value := cu.ToString(values["value"], "")

        fieldMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.TableEventRowSelected: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        client.SetForm(cu.ToString(stateData["view"], ""), cu.ToIM(valueData["row"], cu.IM{}), cu.ToInteger(valueData["index"], 0), false)
                        return evt, nil
                }</span>,

                ct.TableEventAddItem: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        view := cu.ToString(stateData["view"], "")
                        typeMap := map[string]func() cu.IM{
                                "events": func() cu.IM </span><span class="cov0" title="0">{
                                        var event cu.IM
                                        ut.ConvertToType(md.Event{
                                                Tags:     []string{},
                                                EventMap: cu.IM{},
                                        }, &amp;event)
                                        return event
                                }</span>,
                        }
                        <span class="cov0" title="0">if slices.Contains([]string{"events"}, view) </span><span class="cov0" title="0">{
                                getBase := func() (base cu.IM) </span><span class="cov0" title="0">{
                                        if _, found := employee[view]; found </span><span class="cov0" title="0">{
                                                return employee
                                        }</span>
                                        <span class="cov0" title="0">return stateData</span>
                                }
                                <span class="cov0" title="0">base := getBase()
                                rows := cu.ToIMA(base[view], []cu.IM{})
                                rows = append(rows, typeMap[view]())
                                base[view] = rows
                                client.SetForm(view, cu.MergeIM(typeMap[view](), cu.IM{}), cu.ToInteger(len(rows)-1, 0), false)
                                return evt, nil</span>
                        }
                        <span class="cov0" title="0">return s.cls.addMapField(evt, employeeMap, resultUpdate)</span>
                },

                ct.TableEventFormDelete: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        row := cu.ToIM(valueData["row"], cu.IM{})
                        fieldName := cu.ToString(row["field_name"], "")
                        delete(employeeMap, fieldName)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                ct.TableEventFormUpdate: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.updateMapField(evt, employeeMap, resultUpdate)
                }</span>,

                ct.TableEventFormChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                ct.TableEventFormCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                "map_field": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        stateData["map_field"] = value
                        return resultUpdate(cu.IM{"dirty": false})
                }</span>,

                "queue": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.ToIM(client.Data["modal"], cu.IM{})
                        modalData := cu.ToIM(modal["data"], cu.IM{})
                        if err = s.cls.insertPrintQueue(ds, modalData); err == nil </span><span class="cov0" title="0">{
                                return s.cls.evtMsg(evt.Name, evt.TriggerName, client.Msg("report_add_queue"), ct.ToastTypeSuccess, 5), nil
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "tags": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorTags(evt, employeeMeta, resultUpdate)
                }</span>,

                "start_date": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        employeeMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "end_date": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        employeeMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        employeeMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "inactive": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        employeeMeta[fieldName] = cu.ToBoolean(value, false)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "first_name": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        contact[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "surname": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        contact[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "status": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        contact[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "email": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        contact[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "phone": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        contact[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "mobile": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        contact[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "contact_notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        contact["notes"] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "country": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "state": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "zip_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "city": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "street": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "address_notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address["notes"] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := fieldMap[fieldName]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">if slices.Contains([]string{"orientation", "template", "paper_size", "copy"}, fieldName) </span><span class="cov0" title="0">{
                modal := cu.ToIM(client.Data["modal"], cu.IM{})
                modalData := cu.ToIM(modal["data"], cu.IM{})
                modalData[fieldName] = value
                client.SetForm("report", modalData, 0, true)
                return evt, nil
        }</span>
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *EmployeeService) Response(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        switch evt.Name </span>{
        case ct.FormEventOK:<span class="cov0" title="0">
                return s.formNext(evt)</span>

        case ct.ClientEventForm:<span class="cov0" title="0">
                return s.formEvent(evt)</span>

        case ct.ClientEventSideMenu:<span class="cov0" title="0">
                return s.sideMenu(evt)</span>

        default:<span class="cov0" title="0">
                return s.editorField(evt)</span>
        }
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package service

import (
        "fmt"
        "slices"
        "time"

        ct "github.com/nervatura/component/pkg/component"
        cu "github.com/nervatura/component/pkg/util"
        api "github.com/nervatura/nervatura/v6/pkg/api"
        md "github.com/nervatura/nervatura/v6/pkg/model"
        ut "github.com/nervatura/nervatura/v6/pkg/service/utils"
)

type PlaceService struct {
        cls *ClientService
}

func NewPlaceService(cls *ClientService) *PlaceService <span class="cov0" title="0">{
        return &amp;PlaceService{
                cls: cls,
        }
}</span>

func (s *PlaceService) Data(evt ct.ResponseEvent, params cu.IM) (data cu.IM, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        ds := s.cls.getDataStore(client.Ticket.Database)
        user := cu.ToIM(client.Ticket.User, cu.IM{})

        data = cu.IM{
                "place": cu.IM{
                        "place_type": md.PlaceType(0),
                        "place_meta": cu.IM{
                                "tags": []string{},
                        },
                        "place_map": cu.IM{},
                        "address":   cu.IM{},
                        "contacts":  []cu.IM{},
                },
                "config_map":   cu.IM{},
                "config_data":  cu.IM{},
                "currencies":   cu.IM{},
                "user":         user,
                "dirty":        false,
                "editor_icon":  ct.IconUser,
                "editor_title": "",
        }

        if cu.ToString(params["place_id"], "") != "" || cu.ToString(params["place_code"], "") != "" </span><span class="cov0" title="0">{
                var places []cu.IM = []cu.IM{}
                if places, err = ds.StoreDataQuery(md.Query{
                        Fields: []string{"*"}, From: "place",
                        Filters: []md.Filter{
                                {Field: "deleted", Comp: "==", Value: false},
                                {Field: "id", Comp: "==", Value: cu.ToInteger(params["place_id"], 0)},
                                {Or: true, Field: "code", Comp: "==", Value: cu.ToString(params["place_code"], "")},
                        },
                }, false); err != nil </span><span class="cov0" title="0">{
                        return data, err
                }</span>
                <span class="cov0" title="0">if len(places) &gt; 0 </span><span class="cov0" title="0">{
                        data["place"] = places[0]
                        data["editor_title"] = cu.ToString(places[0]["code"], "")
                }</span>
        }

        <span class="cov0" title="0">var rows []cu.IM = []cu.IM{}
        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_map",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_map"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_data",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_data"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"code", "description", "digit"}, From: "currency_view",
                OrderBy: []string{"code"},
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["currencies"] = rows

        return data, err</span>
}

func (s *PlaceService) update(ds *api.DataStore, data cu.IM) (editor cu.IM, err error) <span class="cov0" title="0">{
        var place md.Place = md.Place{}
        ut.ConvertToType(data["place"], &amp;place)
        values := cu.IM{
                "place_type": place.PlaceType.String(),
                "place_name": place.PlaceName,
        }
        if place.Code != "" </span><span class="cov0" title="0">{
                values["code"] = place.Code
        }</span>

        <span class="cov0" title="0">ut.ConvertByteToIMData(place.Contacts, values, "contacts")
        ut.ConvertByteToIMData(place.Address, values, "address")
        ut.ConvertByteToIMData(place.PlaceMeta, values, "place_meta")
        ut.ConvertByteToIMData(place.PlaceMap, values, "place_map")

        var placeID int64
        newPlace := (place.Id == 0)
        update := md.Update{Values: values, Model: "place"}
        if !newPlace </span><span class="cov0" title="0">{
                update.IDKey = place.Id
        }</span>
        <span class="cov0" title="0">if placeID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newPlace </span><span class="cov0" title="0">{
                var places []cu.IM = []cu.IM{}
                if places, err = ds.StoreDataGet(cu.IM{"id": placeID, "model": "place"}, true); err == nil </span><span class="cov0" title="0">{
                        data["place"] = places[0]
                        data["editor_title"] = cu.ToString(cu.ToIM(places[0], cu.IM{})["code"], "")
                }</span>
        }
        <span class="cov0" title="0">return data, err</span>
}

func (s *PlaceService) delete(ds *api.DataStore, placeID int64) (err error) <span class="cov0" title="0">{
        return ds.DataDelete("place", placeID, "")
}</span>

func (s *PlaceService) formNext(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        place := cu.ToIM(stateData["place"], cu.IM{})
        placeMeta := cu.ToIM(place["place_meta"], cu.IM{})
        placeMap := cu.ToIM(place["place_map"], cu.IM{})

        resultUpdate := func(dirty bool) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                place["place_meta"] = placeMeta
                place["place_map"] = placeMap
                stateData["place"] = place
                if dirty </span><span class="cov0" title="0">{
                        stateData["dirty"] = dirty
                }</span>
                <span class="cov0" title="0">client.SetEditor("place", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})

        nextMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_cancel": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        client.ResetEditor()
                        return evt, err
                }</span>,

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if err = s.delete(ds, cu.ToInteger(place["id"], 0)); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">client.ResetEditor()
                        return evt, err</span>
                },

                "editor_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(placeMeta["tags"])
                                if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        placeMeta["tags"] = tags
                                        return resultUpdate(true)
                                }</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "form_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        frmKey := cu.ToString(frmData["frm_key"], "")
                        frmIndex := cu.ToInteger(frmData["frm_index"], 0)
                        row := cu.ToIM(frmData["row"], cu.IM{})
                        metaName := ut.MetaName(row, "_meta")
                        rowField := cu.ToString(frmData["row_field"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(row[rowField])
                                if metaName != "" </span><span class="cov0" title="0">{
                                        tags = ut.ToStringArray(cu.ToIM(row[metaName], cu.IM{})[rowField])
                                }</span>
                                <span class="cov0" title="0">if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        if metaName != "" </span><span class="cov0" title="0">{
                                                cu.ToIM(row[metaName], cu.IM{})[rowField] = tags
                                        }</span> else<span class="cov0" title="0"> {
                                                row[rowField] = tags
                                        }</span>
                                        <span class="cov0" title="0">client.SetForm(frmKey, row, frmIndex, false)
                                        return evt, nil</span>
                                }
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "bookmark_add": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        label := cu.ToString(frmValue["value"], "")
                        bookmark := md.Bookmark{
                                BookmarkType: md.BookmarkTypeEditor,
                                Label:        label,
                                Key:          "place",
                                Code:         cu.ToString(place["code"], ""),
                                Filters:      []any{},
                                Columns:      map[string]bool{},
                                TimeStamp:    md.TimeDateTime{Time: time.Now()},
                        }
                        return s.cls.addBookmark(evt, bookmark), nil
                }</span>,

                "editor_map_value": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        code := cu.ToString(frmValue["value"], "")
                        model := cu.ToString(frmData["model"], "")
                        mapField := cu.ToString(frmData["map_field"], "")
                        if _, err := ds.GetDataByID(model, 0, code, true); err != nil </span><span class="cov0" title="0">{
                                frmData["label"] = fmt.Sprintf("%s: %s (%s)", client.Msg("invalid_code"), code, model)
                                frmData["default_value"] = code
                                frmData["invalid"] = true
                                client.SetForm("input_string", frmData, 0, true)
                                return evt, nil
                        }</span>
                        <span class="cov0" title="0">placeMap[mapField] = code
                        stateData["map_field"] = ""
                        return resultUpdate(true)</span>
                },
        }

        <span class="cov0" title="0">if fn, ok := nextMap[cu.ToString(frmData["next"], "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">return evt, err</span>
}

func (s *PlaceService) formEvent(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        place := cu.ToIM(stateData["place"], cu.IM{})

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        frmKey := cu.ToString(form["key"], "")
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})
        frmEvent := cu.ToString(frmValues["event"], "")
        rows := cu.ToIMA(place[frmKey], []cu.IM{})
        if srows, found := stateData[frmKey]; found &amp;&amp; (len(rows) == 0) </span><span class="cov0" title="0">{
                rows = cu.ToIMA(srows, []cu.IM{})
        }</span>
        <span class="cov0" title="0">delete := (cu.ToString(frmValue["form_delete"], "") != "")

        resultUpdate := func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                if _, found := place[frmKey]; found </span><span class="cov0" title="0">{
                        place[frmKey] = rows
                }</span> else<span class="cov0" title="0"> {
                        stateData[frmKey] = rows
                }</span>
                <span class="cov0" title="0">stateData["dirty"] = true
                return evt, err</span>
        }

        <span class="cov0" title="0">eventMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.FormEventOK: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        //rowMeta := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_meta")], cu.IM{})
                        //rowMap := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_map")], cu.IM{})
                        customValues := map[string]func(value any){
                                "base_tags": func(value any) </span><span class="cov0" title="0">{
                                        rows[frmIndex]["tags"] = value
                                }</span>,
                        }
                        <span class="cov0" title="0">return s.cls.editorFormOK(evt, rows, customValues)</span>
                },

                ct.FormEventCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if delete </span><span class="cov0" title="0">{
                                if _, found := stateData[frmKey]; found </span><span class="cov0" title="0">{
                                        deleteRows := cu.ToIMA(stateData[frmKey+"_delete"], []cu.IM{})
                                        deleteRows = append(deleteRows, rows[frmIndex])
                                        stateData[frmKey+"_delete"] = deleteRows
                                }</span>
                                <span class="cov0" title="0">rows = append(rows[:frmIndex], rows[frmIndex+1:]...)
                                return resultUpdate()</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                ct.FormEventChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        fieldName := cu.ToString(frmValues["name"], "")
                        switch fieldName </span>{
                        case "tags":<span class="cov0" title="0">
                                return s.cls.editorFormTags(cu.IM{"row_field": fieldName}, evt)</span>
                        default:<span class="cov0" title="0">
                                frmBaseValues[fieldName] = frmValues["value"]
                                cu.ToSM(evt.Header, cu.SM{})[ct.HeaderReswap] = ct.SwapNone</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },
        }

        <span class="cov0" title="0">if len(rows) &gt; 0 &amp;&amp; frmIndex &lt; int64(len(rows)) </span><span class="cov0" title="0">{
                if fn, ok := eventMap[frmEvent]; ok </span><span class="cov0" title="0">{
                        return fn()
                }</span>
        }

        <span class="cov0" title="0">return evt, err</span>
}

func (s *PlaceService) sideMenu(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)

        menuMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_save": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        if stateData, err = s.update(ds, stateData); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">stateData["dirty"] = false
                        client.SetEditor("place", cu.ToString(stateData["view"], ""), stateData)
                        return evt, err</span>
                },

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("inputbox_delete"),
                                "warning_message": "",
                                "next":            "editor_delete",
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, err
                }</span>,

                "editor_cancel": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_dirty"),
                                        "warning_message": client.Msg("inputbox_drop"),
                                        "next":            "editor_cancel",
                                }
                                client.SetForm("warning", modal, 0, true)
                        }</span> else<span class="cov0" title="0"> {
                                client.ResetEditor()
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "editor_new": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.setEditor(evt, "place",
                                cu.IM{
                                        "session_id": client.Ticket.SessionID,
                                }), nil
                }</span>,

                "editor_bookmark": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "title":         client.Msg("bookmark_new"),
                                "icon":          ct.IconStar,
                                "label":         client.Msg("bookmark_enter"),
                                "placeholder":   "",
                                "field_name":    "value",
                                "default_value": "",
                                "required":      false,
                                "next":          "bookmark_add",
                        }
                        client.SetForm("input_string", modal, 0, true)
                        return evt, nil
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := menuMap[cu.ToString(evt.Value, "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>

        <span class="cov0" title="0">return evt, err</span>
}

func (s *PlaceService) editorField(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        place := cu.ToIM(stateData["place"], cu.IM{})
        placeMeta := cu.ToIM(place["place_meta"], cu.IM{})
        placeMap := cu.ToIM(place["place_map"], cu.IM{})
        address := cu.ToIM(place["address"], cu.IM{})

        resultUpdate := func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                place["place_meta"] = placeMeta
                place["place_map"] = placeMap
                place["address"] = address
                stateData["place"] = place
                if cu.ToBoolean(params["dirty"], false) </span><span class="cov0" title="0">{
                        stateData["dirty"] = true
                }</span>
                <span class="cov0" title="0">client.SetEditor("place", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">values := cu.ToIM(evt.Value, cu.IM{})
        fieldName := cu.ToString(values["name"], "")
        value := cu.ToString(values["value"], "")

        fieldMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.TableEventRowSelected: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        client.SetForm(cu.ToString(stateData["view"], ""), cu.ToIM(valueData["row"], cu.IM{}), cu.ToInteger(valueData["index"], 0), false)
                        return evt, nil
                }</span>,

                ct.TableEventAddItem: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        view := cu.ToString(stateData["view"], "")
                        typeMap := map[string]func() cu.IM{
                                "contacts": func() cu.IM </span><span class="cov0" title="0">{
                                        var contact cu.IM
                                        ut.ConvertToType(md.Contact{
                                                Tags:       []string{},
                                                ContactMap: cu.IM{},
                                        }, &amp;contact)
                                        return contact
                                }</span>,
                        }
                        <span class="cov0" title="0">if slices.Contains([]string{"contacts"}, view) </span><span class="cov0" title="0">{
                                getBase := func() (base cu.IM) </span><span class="cov0" title="0">{
                                        if _, found := place[view]; found </span><span class="cov0" title="0">{
                                                return place
                                        }</span>
                                        <span class="cov0" title="0">return stateData</span>
                                }
                                <span class="cov0" title="0">base := getBase()
                                rows := cu.ToIMA(base[view], []cu.IM{})
                                rows = append(rows, typeMap[view]())
                                base[view] = rows
                                client.SetForm(view, cu.MergeIM(typeMap[view](), cu.IM{}), cu.ToInteger(len(rows)-1, 0), false)
                                return evt, nil</span>
                        }
                        <span class="cov0" title="0">return s.cls.addMapField(evt, placeMap, resultUpdate)</span>
                },

                ct.TableEventFormDelete: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        row := cu.ToIM(valueData["row"], cu.IM{})
                        fieldName := cu.ToString(row["field_name"], "")
                        delete(placeMap, fieldName)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                ct.TableEventFormUpdate: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.updateMapField(evt, placeMap, resultUpdate)
                }</span>,

                ct.TableEventFormChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                ct.TableEventFormCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                "map_field": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        stateData["map_field"] = value
                        return resultUpdate(cu.IM{"dirty": false})
                }</span>,

                "tags": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorTags(evt, placeMeta, resultUpdate)
                }</span>,

                "place_name": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        place[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "place_type": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        place[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        placeMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "inactive": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        placeMeta[fieldName] = cu.ToBoolean(value, false)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "currency_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        place[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "country": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "state": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "zip_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "city": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "street": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        address[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := fieldMap[fieldName]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *PlaceService) Response(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        switch evt.Name </span>{
        case ct.FormEventOK:<span class="cov0" title="0">
                return s.formNext(evt)</span>

        case ct.ClientEventForm:<span class="cov0" title="0">
                return s.formEvent(evt)</span>

        case ct.ClientEventSideMenu:<span class="cov0" title="0">
                return s.sideMenu(evt)</span>

        default:<span class="cov0" title="0">
                return s.editorField(evt)</span>
        }
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package service

import (
        "fmt"
        "slices"
        "strings"
        "time"

        ct "github.com/nervatura/component/pkg/component"
        cu "github.com/nervatura/component/pkg/util"
        api "github.com/nervatura/nervatura/v6/pkg/api"
        md "github.com/nervatura/nervatura/v6/pkg/model"
        ut "github.com/nervatura/nervatura/v6/pkg/service/utils"
)

type ProductService struct {
        cls *ClientService
}

func NewProductService(cls *ClientService) *ProductService <span class="cov0" title="0">{
        return &amp;ProductService{
                cls: cls,
        }
}</span>

func (s *ProductService) Data(evt ct.ResponseEvent, params cu.IM) (data cu.IM, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        ds := s.cls.getDataStore(client.Ticket.Database)
        user := cu.ToIM(client.Ticket.User, cu.IM{})

        data = cu.IM{
                "product": cu.IM{
                        "product_type": md.ProductType(0),
                        "product_meta": cu.IM{
                                "barcode_type": md.BarcodeTypeEan13.String(),
                        },
                },
                "prices":        cu.IM{},
                "config_map":    cu.IM{},
                "config_data":   cu.IM{},
                "config_report": cu.IM{},
                "tax_codes":     cu.IM{},
                "currencies":    cu.IM{},
                "units":         cu.IM{},
                "user":          user,
                "dirty":         false,
                "editor_icon":   ct.IconShoppingCart,
                "editor_title":  "",
        }
        var rows []cu.IM = []cu.IM{}
        if cu.ToString(params["product_id"], "") != "" || cu.ToString(params["product_code"], "") != "" </span><span class="cov0" title="0">{
                var products []cu.IM = []cu.IM{}
                if products, err = ds.StoreDataQuery(md.Query{
                        Fields: []string{"*"}, From: "product",
                        Filters: []md.Filter{
                                {Field: "deleted", Comp: "==", Value: false},
                                {Field: "id", Comp: "==", Value: cu.ToInteger(params["product_id"], 0)},
                                {Or: true, Field: "code", Comp: "==", Value: cu.ToString(params["product_code"], "")},
                        },
                }, false); err != nil </span><span class="cov0" title="0">{
                        return data, err
                }</span>
                <span class="cov0" title="0">if len(products) &gt; 0 </span><span class="cov0" title="0">{
                        data["product"] = products[0]
                        data["editor_title"] = cu.ToString(products[0]["code"], "")
                }</span>

                <span class="cov0" title="0">if rows, err = ds.StoreDataQuery(md.Query{
                        Fields: []string{"*"}, From: "price",
                        Filters: []md.Filter{
                                {Field: "product_code", Comp: "==", Value: cu.ToString(products[0]["code"], "")},
                                {Field: "deleted", Comp: "==", Value: false},
                        },
                }, false); err != nil </span><span class="cov0" title="0">{
                        return data, err
                }</span>
                <span class="cov0" title="0">data["prices"] = rows</span>
        }
        <span class="cov0" title="0">product := cu.ToIM(data["product"], cu.IM{})

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_map",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_map"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_data",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_data"] = rows
        if cu.ToInteger(product["id"], 0) == 0 </span><span class="cov0" title="0">{
                if idx := slices.IndexFunc(rows, func(c cu.IM) bool </span><span class="cov0" title="0">{
                        return cu.ToString(c["config_key"], "") == "default_taxcode"
                }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                        product["tax_code"] = cu.ToString(rows[idx]["config_value"], "")
                }</span>
                <span class="cov0" title="0">if idx := slices.IndexFunc(rows, func(c cu.IM) bool </span><span class="cov0" title="0">{
                        return cu.ToString(c["config_key"], "") == "default_unit"
                }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                        productMeta := cu.ToIM(product["product_meta"], cu.IM{})
                        productMeta["unit"] = cu.ToString(rows[idx]["config_value"], "")
                        product["product_meta"] = productMeta
                }</span>
        }

        <span class="cov0" title="0">if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"id", "report_key", "report_name"}, From: "config_report",
                Filters: []md.Filter{
                        {Field: "report_type", Comp: "==", Value: "PRODUCT"},
                },
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_report"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"code", "description"}, From: "tax_view",
                OrderBy: []string{"code"},
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["tax_codes"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"code", "description"}, From: "currency_view",
                OrderBy: []string{"code"},
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["currencies"] = rows

        return data, err</span>
}

func (s *ProductService) update(ds *api.DataStore, data cu.IM) (editor cu.IM, err error) <span class="cov0" title="0">{
        var product md.Product = md.Product{}
        ut.ConvertToType(data["product"], &amp;product)
        values := cu.IM{
                "product_type": product.ProductType.String(),
                "product_name": product.ProductName,
                "tax_code":     product.TaxCode,
        }
        if product.Code != "" </span><span class="cov0" title="0">{
                values["code"] = product.Code
        }</span>

        <span class="cov0" title="0">ut.ConvertByteToIMData(product.Events, values, "events")
        ut.ConvertByteToIMData(product.ProductMeta, values, "product_meta")
        ut.ConvertByteToIMData(product.ProductMap, values, "product_map")

        var productID int64
        newProduct := (product.Id == 0)
        update := md.Update{Values: values, Model: "product"}
        if !newProduct </span><span class="cov0" title="0">{
                update.IDKey = product.Id
        }</span>
        <span class="cov0" title="0">if productID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newProduct </span><span class="cov0" title="0">{
                var products []cu.IM = []cu.IM{}
                if products, err = ds.StoreDataGet(cu.IM{"id": productID, "model": "product"}, true); err == nil </span><span class="cov0" title="0">{
                        data["product"] = products[0]
                        data["editor_title"] = cu.ToString(cu.ToIM(products[0], cu.IM{})["code"], "")
                }</span>
        }

        <span class="cov0" title="0">for _, pr := range cu.ToIMA(data["prices"], []cu.IM{}) </span><span class="cov0" title="0">{
                var price md.Price = md.Price{
                        PriceType: md.PriceType(md.PriceTypeCustomer),
                        PriceMeta: md.PriceMeta{
                                Tags: []string{},
                        },
                        PriceMap: cu.IM{},
                }
                if err = ut.ConvertToType(pr, &amp;price); err == nil </span><span class="cov0" title="0">{
                        values = cu.IM{
                                "valid_from":    price.ValidFrom.Format(time.DateOnly),
                                "valid_to":      "",
                                "product_code":  price.ProductCode,
                                "price_type":    price.PriceType.String(),
                                "currency_code": price.CurrencyCode,
                                "qty":           price.Qty,
                                "customer_code": nil,
                        }
                        if !price.ValidTo.IsZero() </span><span class="cov0" title="0">{
                                values["valid_to"] = price.ValidTo.Format(time.DateOnly)
                        }</span>
                        <span class="cov0" title="0">if price.CustomerCode != "" </span><span class="cov0" title="0">{
                                values["customer_code"] = price.CustomerCode
                        }</span>
                        <span class="cov0" title="0">ut.ConvertByteToIMData(price.PriceMeta, values, "price_meta")
                        ut.ConvertByteToIMData(price.PriceMap, values, "price_map")

                        priceID := price.Id
                        update := md.Update{Values: values, Model: "price"}
                        if priceID &gt; 0 </span><span class="cov0" title="0">{
                                update.IDKey = priceID
                        }</span>
                        <span class="cov0" title="0">if priceID, err = ds.StoreDataUpdate(update); err != nil </span><span class="cov0" title="0">{
                                return data, err
                        }</span>
                        <span class="cov0" title="0">pr["id"] = priceID</span>
                }
        }

        <span class="cov0" title="0">for _, pr := range cu.ToIMA(data["prices_delete"], []cu.IM{}) </span><span class="cov0" title="0">{
                if err = ds.DataDelete("price", cu.ToInteger(pr["id"], 0), ""); err != nil </span><span class="cov0" title="0">{
                        return data, err
                }</span>
        }

        <span class="cov0" title="0">return data, err</span>
}

func (s *ProductService) delete(ds *api.DataStore, productID int64) (err error) <span class="cov0" title="0">{
        return ds.DataDelete("product", productID, "")
}</span>

func (s *ProductService) formNext(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        product := cu.ToIM(stateData["product"], cu.IM{})
        productMeta := cu.ToIM(product["product_meta"], cu.IM{})
        productMap := cu.ToIM(product["product_map"], cu.IM{})

        resultUpdate := func(dirty bool) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                product["product_meta"] = productMeta
                product["product_map"] = productMap
                stateData["product"] = product
                if dirty </span><span class="cov0" title="0">{
                        stateData["dirty"] = dirty
                }</span>
                <span class="cov0" title="0">client.SetEditor("product", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})

        nextMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_cancel": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        client.ResetEditor()
                        return evt, err
                }</span>,

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if err = s.delete(ds, cu.ToInteger(product["id"], 0)); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">client.ResetEditor()
                        return evt, err</span>
                },

                "customer": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        params := cu.ToIM(stateData["params"], cu.IM{})
                        return s.cls.setEditor(evt, "customer", params), nil
                }</span>,

                "editor_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(productMeta["tags"])
                                if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        productMeta["tags"] = tags
                                        return resultUpdate(true)
                                }</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "form_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        frmKey := cu.ToString(frmData["frm_key"], "")
                        frmIndex := cu.ToInteger(frmData["frm_index"], 0)
                        row := cu.ToIM(frmData["row"], cu.IM{})
                        metaName := ut.MetaName(row, "_meta")
                        rowField := cu.ToString(frmData["row_field"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(row[rowField])
                                if metaName != "" </span><span class="cov0" title="0">{
                                        tags = ut.ToStringArray(cu.ToIM(row[metaName], cu.IM{})[rowField])
                                }</span>
                                <span class="cov0" title="0">if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        if metaName != "" </span><span class="cov0" title="0">{
                                                cu.ToIM(row[metaName], cu.IM{})[rowField] = tags
                                        }</span> else<span class="cov0" title="0"> {
                                                row[rowField] = tags
                                        }</span>
                                        <span class="cov0" title="0">client.SetForm(frmKey, row, frmIndex, false)
                                        return evt, nil</span>
                                }
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "bookmark_add": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        label := cu.ToString(frmValue["value"], "")
                        bookmark := md.Bookmark{
                                BookmarkType: md.BookmarkTypeEditor,
                                Label:        label,
                                Key:          "product",
                                Code:         cu.ToString(product["code"], ""),
                                Filters:      []any{},
                                Columns:      map[string]bool{},
                                TimeStamp:    md.TimeDateTime{Time: time.Now()},
                        }
                        return s.cls.addBookmark(evt, bookmark), nil
                }</span>,

                "editor_map_value": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        code := cu.ToString(frmValue["value"], "")
                        model := cu.ToString(frmData["model"], "")
                        mapField := cu.ToString(frmData["map_field"], "")
                        if _, err := ds.GetDataByID(model, 0, code, true); err != nil </span><span class="cov0" title="0">{
                                frmData["label"] = fmt.Sprintf("%s: %s (%s)", client.Msg("invalid_code"), code, model)
                                frmData["default_value"] = code
                                frmData["invalid"] = true
                                client.SetForm("input_string", frmData, 0, true)
                                return evt, nil
                        }</span>
                        <span class="cov0" title="0">productMap[mapField] = code
                        stateData["map_field"] = ""
                        return resultUpdate(true)</span>
                },
        }

        <span class="cov0" title="0">if fn, ok := nextMap[cu.ToString(frmData["next"], "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">return evt, err</span>
}

func (s *ProductService) formEvent(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        product := cu.ToIM(stateData["product"], cu.IM{})

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        frmKey := cu.ToString(form["key"], "")
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})
        frmEvent := cu.ToString(frmValues["event"], "")
        rows := cu.ToIMA(product[frmKey], []cu.IM{})
        if srows, found := stateData[frmKey]; found &amp;&amp; (len(rows) == 0) </span><span class="cov0" title="0">{
                rows = cu.ToIMA(srows, []cu.IM{})
        }</span>
        <span class="cov0" title="0">delete := (cu.ToString(frmValue["form_delete"], "") != "")

        resultUpdate := func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                if _, found := product[frmKey]; found </span><span class="cov0" title="0">{
                        product[frmKey] = rows
                }</span> else<span class="cov0" title="0"> {
                        stateData[frmKey] = rows
                }</span>
                <span class="cov0" title="0">stateData["dirty"] = true
                return evt, err</span>
        }

        <span class="cov0" title="0">eventMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.FormEventOK: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        rowMeta := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_meta")], cu.IM{})
                        //rowMap := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_map")], cu.IM{})
                        customValues := map[string]func(value any){
                                "frm_price_value": func(value any) </span><span class="cov0" title="0">{
                                        rowMeta["price_value"] = cu.ToFloat(value, 0)
                                }</span>,
                                "frm_qty": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["qty"] = cu.ToFloat(value, 0)
                                }</span>,
                                "base_price_meta": func(value any) <span class="cov0" title="0">{
                                        rowMeta["tags"] = cu.ToIM(value, cu.IM{})["tags"]
                                }</span>,
                                "base_customer_code": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["customer_code"] = value
                                }</span>,
                                "base_tags": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["tags"] = value
                                }</span>,
                        }
                        <span class="cov0" title="0">return s.cls.editorFormOK(evt, rows, customValues)</span>
                },

                ct.FormEventCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if delete </span><span class="cov0" title="0">{
                                if _, found := stateData[frmKey]; found </span><span class="cov0" title="0">{
                                        deleteRows := cu.ToIMA(stateData[frmKey+"_delete"], []cu.IM{})
                                        deleteRows = append(deleteRows, rows[frmIndex])
                                        stateData[frmKey+"_delete"] = deleteRows
                                }</span>
                                <span class="cov0" title="0">rows = append(rows[:frmIndex], rows[frmIndex+1:]...)
                                return resultUpdate()</span>
                        }
                        <span class="cov0" title="0">return evt, err</span>
                },

                ct.FormEventChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        fieldName := cu.ToString(frmValues["name"], "")
                        switch fieldName </span>{
                        case "tags":<span class="cov0" title="0">
                                return s.cls.editorFormTags(cu.IM{"row_field": fieldName}, evt)</span>
                        case "customer_code":<span class="cov0" title="0">
                                form := cu.ToIM(stateData["form"], cu.IM{})
                                formRow := cu.ToIM(form["data"], cu.IM{})
                                return s.cls.editorCodeSelector(evt, "product", strings.Split(fieldName, "_")[0], formRow,
                                        func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                                                client.SetForm(cu.ToString(form["key"], ""),
                                                        cu.MergeIM(formRow,
                                                                cu.IM{"currencies": stateData["currencies"], "customer_selector": stateData["customer_selector"]}),
                                                        cu.ToInteger(form["index"], 0), false)
                                                return evt, nil
                                        }</span>)
                        case "price_value":<span class="cov0" title="0">
                                cu.ToIM(frmBaseValues["price_meta"], cu.IM{})["price_value"] = frmValues["value"]
                                cu.ToSM(evt.Header, cu.SM{})[ct.HeaderReswap] = ct.SwapNone</span>
                        default:<span class="cov0" title="0">
                                frmBaseValues[fieldName] = frmValues["value"]
                                cu.ToSM(evt.Header, cu.SM{})[ct.HeaderReswap] = ct.SwapNone</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },
        }

        <span class="cov0" title="0">if len(rows) &gt; 0 &amp;&amp; frmIndex &lt; int64(len(rows)) </span><span class="cov0" title="0">{
                if fn, ok := eventMap[frmEvent]; ok </span><span class="cov0" title="0">{
                        return fn()
                }</span>
        }

        <span class="cov0" title="0">return evt, err</span>
}

func (s *ProductService) sideMenu(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        product := cu.ToIM(stateData["product"], cu.IM{})
        ds := s.cls.getDataStore(client.Ticket.Database)

        menuMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_save": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        if stateData, err = s.update(ds, stateData); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">stateData["dirty"] = false
                        client.SetEditor("product", cu.ToString(stateData["view"], ""), stateData)
                        return evt, err</span>
                },

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("inputbox_delete"),
                                "warning_message": "",
                                "next":            "editor_delete",
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, err
                }</span>,

                "editor_cancel": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_dirty"),
                                        "warning_message": client.Msg("inputbox_drop"),
                                        "next":            "editor_cancel",
                                }
                                client.SetForm("warning", modal, 0, true)
                        }</span> else<span class="cov0" title="0"> {
                                client.ResetEditor()
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "editor_new": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.setEditor(evt, "product",
                                cu.IM{
                                        "session_id": client.Ticket.SessionID,
                                }), nil
                }</span>,

                "editor_report": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.showReportSelector(evt, "PRODUCT", cu.ToString(product["code"], ""))
                }</span>,

                "editor_bookmark": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "title":         client.Msg("bookmark_new"),
                                "icon":          ct.IconStar,
                                "label":         client.Msg("bookmark_enter"),
                                "placeholder":   "",
                                "field_name":    "value",
                                "default_value": "",
                                "required":      false,
                                "next":          "bookmark_add",
                        }
                        client.SetForm("input_string", modal, 0, true)
                        return evt, nil
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := menuMap[cu.ToString(evt.Value, "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>

        <span class="cov0" title="0">return evt, err</span>
}

func (s *ProductService) editorField(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        product := cu.ToIM(stateData["product"], cu.IM{})
        productMeta := cu.ToIM(product["product_meta"], cu.IM{})
        productMap := cu.ToIM(product["product_map"], cu.IM{})

        resultUpdate := func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                product["product_meta"] = productMeta
                product["product_map"] = productMap
                stateData["product"] = product
                if cu.ToBoolean(params["dirty"], false) </span><span class="cov0" title="0">{
                        stateData["dirty"] = true
                }</span>
                <span class="cov0" title="0">client.SetEditor("product", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">values := cu.ToIM(evt.Value, cu.IM{})
        fieldName := cu.ToString(values["name"], "")
        value := cu.ToString(values["value"], "")

        fieldMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.TableEventRowSelected: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        client.SetForm(cu.ToString(stateData["view"], ""),
                                cu.MergeIM(cu.ToIM(valueData["row"], cu.IM{}),
                                        cu.IM{"currencies": stateData["currencies"]}),
                                cu.ToInteger(valueData["index"], 0), false)
                        return evt, nil
                }</span>,

                ct.TableEventAddItem: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        view := cu.ToString(stateData["view"], "")
                        typeMap := map[string]func() cu.IM{
                                "prices": func() cu.IM </span><span class="cov0" title="0">{
                                        var price cu.IM
                                        ut.ConvertToType(md.Price{
                                                ProductCode:  cu.ToString(product["code"], ""),
                                                PriceType:    md.PriceTypeCustomer,
                                                CurrencyCode: cu.ToString(cu.ToIMA(stateData["currencies"], []cu.IM{})[0]["code"], ""),
                                                ValidFrom:    md.TimeDate{Time: time.Now()},
                                                PriceMeta: md.PriceMeta{
                                                        Tags: []string{},
                                                },
                                                PriceMap: cu.IM{},
                                        }, &amp;price)
                                        return price
                                }</span>,
                                "events": func() cu.IM <span class="cov0" title="0">{
                                        var event cu.IM
                                        ut.ConvertToType(md.Event{
                                                Tags:     []string{},
                                                EventMap: cu.IM{},
                                        }, &amp;event)
                                        return event
                                }</span>,
                        }
                        <span class="cov0" title="0">if slices.Contains([]string{"prices", "events"}, view) </span><span class="cov0" title="0">{
                                getBase := func() (base cu.IM) </span><span class="cov0" title="0">{
                                        if _, found := product[view]; found </span><span class="cov0" title="0">{
                                                return product
                                        }</span>
                                        <span class="cov0" title="0">return stateData</span>
                                }
                                <span class="cov0" title="0">base := getBase()
                                rows := cu.ToIMA(base[view], []cu.IM{})
                                rows = append(rows, typeMap[view]())
                                base[view] = rows
                                client.SetForm(view,
                                        cu.MergeIM(typeMap[view](),
                                                cu.IM{"currencies": stateData["currencies"]}),
                                        cu.ToInteger(len(rows)-1, 0), false)
                                return evt, nil</span>
                        }
                        <span class="cov0" title="0">return s.cls.addMapField(evt, productMap, resultUpdate)</span>
                },

                ct.TableEventFormDelete: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        row := cu.ToIM(valueData["row"], cu.IM{})
                        fieldName := cu.ToString(row["field_name"], "")
                        delete(productMap, fieldName)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                ct.TableEventFormUpdate: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.updateMapField(evt, productMap, resultUpdate)
                }</span>,

                ct.TableEventFormChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                ct.TableEventFormCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                "map_field": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        stateData["map_field"] = value
                        return resultUpdate(cu.IM{"dirty": false})
                }</span>,

                "queue": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.ToIM(client.Data["modal"], cu.IM{})
                        modalData := cu.ToIM(modal["data"], cu.IM{})
                        if err = s.cls.insertPrintQueue(ds, modalData); err == nil </span><span class="cov0" title="0">{
                                return s.cls.evtMsg(evt.Name, evt.TriggerName, client.Msg("report_add_queue"), ct.ToastTypeSuccess, 5), nil
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "tags": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorTags(evt, productMeta, resultUpdate)
                }</span>,

                "barcode_qty": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        productMeta[fieldName] = cu.ToFloat(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "inactive": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        productMeta[fieldName] = cu.ToBoolean(value, false)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        product[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "product_name": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        product[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "product_type": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        product[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "tax_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        product[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "unit": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        productMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "barcode_type": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        productMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "barcode": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        productMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        productMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := fieldMap[fieldName]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">if slices.Contains([]string{"orientation", "template", "paper_size", "copy"}, fieldName) </span><span class="cov0" title="0">{
                modal := cu.ToIM(client.Data["modal"], cu.IM{})
                modalData := cu.ToIM(modal["data"], cu.IM{})
                modalData[fieldName] = value
                client.SetForm("report", modalData, 0, true)
                return evt, nil
        }</span>
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *ProductService) Response(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        switch evt.Name </span>{
        case ct.FormEventOK:<span class="cov0" title="0">
                return s.formNext(evt)</span>

        case ct.ClientEventForm:<span class="cov0" title="0">
                return s.formEvent(evt)</span>

        case ct.ClientEventSideMenu:<span class="cov0" title="0">
                return s.sideMenu(evt)</span>

        default:<span class="cov0" title="0">
                return s.editorField(evt)</span>
        }
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package service

import (
        "fmt"
        "slices"
        "strings"
        "time"

        ct "github.com/nervatura/component/pkg/component"
        cu "github.com/nervatura/component/pkg/util"
        api "github.com/nervatura/nervatura/v6/pkg/api"
        md "github.com/nervatura/nervatura/v6/pkg/model"
        ut "github.com/nervatura/nervatura/v6/pkg/service/utils"
)

type ProjectService struct {
        cls *ClientService
}

func NewProjectService(cls *ClientService) *ProjectService <span class="cov0" title="0">{
        return &amp;ProjectService{
                cls: cls,
        }
}</span>

func (s *ProjectService) Data(evt ct.ResponseEvent, params cu.IM) (data cu.IM, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        ds := s.cls.getDataStore(client.Ticket.Database)
        user := cu.ToIM(client.Ticket.User, cu.IM{})

        data = cu.IM{
                "project": cu.IM{
                        "addresses":   []cu.IM{},
                        "contacts":    []cu.IM{},
                        "events":      []cu.IM{},
                        "project_map": cu.IM{},
                        "project_meta": cu.IM{
                                "start_date": "",
                                "end_date":   "",
                                "tags":       []string{},
                        },
                },
                "config_map":    cu.IM{},
                "config_data":   cu.IM{},
                "config_report": cu.IM{},
                "user":          user,
                "dirty":         false,
                "editor_icon":   ct.IconClock,
                "editor_title":  "",
                "customer_name": "",
        }

        if cu.ToString(params["project_id"], "") != "" || cu.ToString(params["project_code"], "") != "" </span><span class="cov0" title="0">{
                var projects []cu.IM = []cu.IM{}
                if projects, err = ds.StoreDataQuery(md.Query{
                        Fields: []string{"*"}, From: "project",
                        Filters: []md.Filter{
                                {Field: "deleted", Comp: "==", Value: false},
                                {Field: "id", Comp: "==", Value: cu.ToInteger(params["project_id"], 0)},
                                {Or: true, Field: "code", Comp: "==", Value: cu.ToString(params["project_code"], "")},
                        },
                }, false); err != nil </span><span class="cov0" title="0">{
                        return data, err
                }</span>
                <span class="cov0" title="0">if len(projects) &gt; 0 </span><span class="cov0" title="0">{
                        data["project"] = projects[0]
                        data["editor_title"] = cu.ToString(projects[0]["code"], "")
                        data["customer_name"] = s.cls.codeName(ds, cu.ToString(projects[0]["customer_code"], ""), "customer")
                }</span>
        }

        <span class="cov0" title="0">var rows []cu.IM = []cu.IM{}
        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_map",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_map"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_data",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_data"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"id", "report_key", "report_name"}, From: "config_report",
                Filters: []md.Filter{
                        {Field: "report_type", Comp: "==", Value: "PROJECT"},
                },
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_report"] = rows

        return data, err</span>
}

func (s *ProjectService) update(ds *api.DataStore, data cu.IM) (editor cu.IM, err error) <span class="cov0" title="0">{
        var project md.Project = md.Project{}
        ut.ConvertToType(data["project"], &amp;project)
        values := cu.IM{
                "project_name":  project.ProjectName,
                "customer_code": nil,
        }
        if project.Code != "" </span><span class="cov0" title="0">{
                values["code"] = project.Code
        }</span>
        <span class="cov0" title="0">if project.CustomerCode != "" </span><span class="cov0" title="0">{
                values["customer_code"] = project.CustomerCode
        }</span>

        <span class="cov0" title="0">ut.ConvertByteToIMData(project.Contacts, values, "contacts")
        ut.ConvertByteToIMData(project.Addresses, values, "addresses")
        ut.ConvertByteToIMData(project.Events, values, "events")
        ut.ConvertByteToIMData(project.ProjectMeta, values, "project_meta")
        ut.ConvertByteToIMData(project.ProjectMap, values, "project_map")

        var projectID int64
        newProject := (project.Id == 0)
        update := md.Update{Values: values, Model: "project"}
        if !newProject </span><span class="cov0" title="0">{
                update.IDKey = project.Id
        }</span>
        <span class="cov0" title="0">if projectID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newProject </span><span class="cov0" title="0">{
                var projects []cu.IM = []cu.IM{}
                if projects, err = ds.StoreDataGet(cu.IM{"id": projectID, "model": "project"}, true); err == nil </span><span class="cov0" title="0">{
                        data["project"] = projects[0]
                        data["editor_title"] = cu.ToString(cu.ToIM(projects[0], cu.IM{})["code"], "")
                }</span>
        }
        <span class="cov0" title="0">return data, err</span>
}

func (s *ProjectService) delete(ds *api.DataStore, projectID int64) (err error) <span class="cov0" title="0">{
        return ds.DataDelete("project", projectID, "")
}</span>

func (s *ProjectService) formNext(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        project := cu.ToIM(stateData["project"], cu.IM{})
        projectMeta := cu.ToIM(project["project_meta"], cu.IM{})
        projectMap := cu.ToIM(project["project_map"], cu.IM{})

        resultUpdate := func(dirty bool) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                project["project_meta"] = projectMeta
                project["project_map"] = projectMap
                stateData["project"] = project
                if dirty </span><span class="cov0" title="0">{
                        stateData["dirty"] = dirty
                }</span>
                <span class="cov0" title="0">client.SetEditor("project", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})

        nextMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_cancel": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        client.ResetEditor()
                        return evt, err
                }</span>,

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if err = s.delete(ds, cu.ToInteger(project["id"], 0)); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">client.ResetEditor()
                        return evt, err</span>
                },

                "customer": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        params := cu.ToIM(stateData["params"], cu.IM{})
                        return s.cls.setEditor(evt, "customer", params), nil
                }</span>,

                "editor_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(projectMeta["tags"])
                                if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        projectMeta["tags"] = tags
                                        return resultUpdate(true)
                                }</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "form_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        frmKey := cu.ToString(frmData["frm_key"], "")
                        frmIndex := cu.ToInteger(frmData["frm_index"], 0)
                        row := cu.ToIM(frmData["row"], cu.IM{})
                        metaName := ut.MetaName(row, "_meta")
                        rowField := cu.ToString(frmData["row_field"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(row[rowField])
                                if metaName != "" </span><span class="cov0" title="0">{
                                        tags = ut.ToStringArray(cu.ToIM(row[metaName], cu.IM{})[rowField])
                                }</span>
                                <span class="cov0" title="0">if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        if metaName != "" </span><span class="cov0" title="0">{
                                                cu.ToIM(row[metaName], cu.IM{})[rowField] = tags
                                        }</span> else<span class="cov0" title="0"> {
                                                row[rowField] = tags
                                        }</span>
                                        <span class="cov0" title="0">client.SetForm(frmKey, row, frmIndex, false)
                                        return evt, nil</span>
                                }
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "bookmark_add": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        label := cu.ToString(frmValue["value"], "")
                        bookmark := md.Bookmark{
                                BookmarkType: md.BookmarkTypeEditor,
                                Label:        label,
                                Key:          "project",
                                Code:         cu.ToString(project["code"], ""),
                                Filters:      []any{},
                                Columns:      map[string]bool{},
                                TimeStamp:    md.TimeDateTime{Time: time.Now()},
                        }
                        return s.cls.addBookmark(evt, bookmark), nil
                }</span>,

                "editor_map_value": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        code := cu.ToString(frmValue["value"], "")
                        model := cu.ToString(frmData["model"], "")
                        mapField := cu.ToString(frmData["map_field"], "")
                        if _, err := ds.GetDataByID(model, 0, code, true); err != nil </span><span class="cov0" title="0">{
                                frmData["label"] = fmt.Sprintf("%s: %s (%s)", client.Msg("invalid_code"), code, model)
                                frmData["default_value"] = code
                                frmData["invalid"] = true
                                client.SetForm("input_string", frmData, 0, true)
                                return evt, nil
                        }</span>
                        <span class="cov0" title="0">projectMap[mapField] = code
                        stateData["map_field"] = ""
                        return resultUpdate(true)</span>
                },
        }

        <span class="cov0" title="0">if fn, ok := nextMap[cu.ToString(frmData["next"], "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">return evt, err</span>
}

func (s *ProjectService) formEvent(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        project := cu.ToIM(stateData["project"], cu.IM{})

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        frmKey := cu.ToString(form["key"], "")
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})
        frmEvent := cu.ToString(frmValues["event"], "")
        rows := cu.ToIMA(project[frmKey], []cu.IM{})
        if srows, found := stateData[frmKey]; found &amp;&amp; (len(rows) == 0) </span><span class="cov0" title="0">{
                rows = cu.ToIMA(srows, []cu.IM{})
        }</span>
        <span class="cov0" title="0">delete := (cu.ToString(frmValue["form_delete"], "") != "")

        resultUpdate := func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                if _, found := project[frmKey]; found </span><span class="cov0" title="0">{
                        project[frmKey] = rows
                }</span> else<span class="cov0" title="0"> {
                        stateData[frmKey] = rows
                }</span>
                <span class="cov0" title="0">stateData["dirty"] = true
                return evt, err</span>
        }

        <span class="cov0" title="0">eventMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.FormEventOK: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        //rowMeta := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_meta")], cu.IM{})
                        //rowMap := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_map")], cu.IM{})
                        customValues := map[string]func(value any){
                                "base_tags": func(value any) </span><span class="cov0" title="0">{
                                        rows[frmIndex]["tags"] = value
                                }</span>,
                        }
                        <span class="cov0" title="0">return s.cls.editorFormOK(evt, rows, customValues)</span>
                },

                ct.FormEventCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if delete </span><span class="cov0" title="0">{
                                if _, found := stateData[frmKey]; found </span><span class="cov0" title="0">{
                                        deleteRows := cu.ToIMA(stateData[frmKey+"_delete"], []cu.IM{})
                                        deleteRows = append(deleteRows, rows[frmIndex])
                                        stateData[frmKey+"_delete"] = deleteRows
                                }</span>
                                <span class="cov0" title="0">rows = append(rows[:frmIndex], rows[frmIndex+1:]...)
                                return resultUpdate()</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                ct.FormEventChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        fieldName := cu.ToString(frmValues["name"], "")
                        switch fieldName </span>{
                        case "tags":<span class="cov0" title="0">
                                return s.cls.editorFormTags(cu.IM{"row_field": fieldName}, evt)</span>
                        default:<span class="cov0" title="0">
                                frmBaseValues[fieldName] = frmValues["value"]
                                cu.ToSM(evt.Header, cu.SM{})[ct.HeaderReswap] = ct.SwapNone</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },
        }

        <span class="cov0" title="0">if len(rows) &gt; 0 &amp;&amp; frmIndex &lt; int64(len(rows)) </span><span class="cov0" title="0">{
                if fn, ok := eventMap[frmEvent]; ok </span><span class="cov0" title="0">{
                        return fn()
                }</span>
        }

        <span class="cov0" title="0">return evt, err</span>
}

func (s *ProjectService) sideMenu(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        project := cu.ToIM(stateData["project"], cu.IM{})
        ds := s.cls.getDataStore(client.Ticket.Database)

        menuMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_save": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        if stateData, err = s.update(ds, stateData); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">stateData["dirty"] = false
                        client.SetEditor("project", cu.ToString(stateData["view"], ""), stateData)
                        return evt, err</span>
                },

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("inputbox_delete"),
                                "warning_message": "",
                                "next":            "editor_delete",
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, err
                }</span>,

                "editor_cancel": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_dirty"),
                                        "warning_message": client.Msg("inputbox_drop"),
                                        "next":            "editor_cancel",
                                }
                                client.SetForm("warning", modal, 0, true)
                        }</span> else<span class="cov0" title="0"> {
                                client.ResetEditor()
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "editor_new": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.setEditor(evt, "project",
                                cu.IM{
                                        "session_id": client.Ticket.SessionID,
                                }), nil
                }</span>,

                "editor_report": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.showReportSelector(evt, "PROJECT", cu.ToString(project["code"], ""))
                }</span>,

                "editor_bookmark": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "title":         client.Msg("bookmark_new"),
                                "icon":          ct.IconStar,
                                "label":         client.Msg("bookmark_enter"),
                                "placeholder":   "",
                                "field_name":    "value",
                                "default_value": "",
                                "required":      false,
                                "next":          "bookmark_add",
                        }
                        client.SetForm("input_string", modal, 0, true)
                        return evt, nil
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := menuMap[cu.ToString(evt.Value, "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>

        <span class="cov0" title="0">return evt, err</span>
}

func (s *ProjectService) editorField(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        project := cu.ToIM(stateData["project"], cu.IM{})
        projectMeta := cu.ToIM(project["project_meta"], cu.IM{})
        projectMap := cu.ToIM(project["project_map"], cu.IM{})

        resultUpdate := func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                project["project_meta"] = projectMeta
                project["project_map"] = projectMap
                stateData["project"] = project
                if cu.ToBoolean(params["dirty"], false) </span><span class="cov0" title="0">{
                        stateData["dirty"] = true
                }</span>
                <span class="cov0" title="0">client.SetEditor("project", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">values := cu.ToIM(evt.Value, cu.IM{})
        fieldName := cu.ToString(values["name"], "")
        value := cu.ToString(values["value"], "")

        fieldMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.TableEventRowSelected: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        client.SetForm(cu.ToString(stateData["view"], ""), cu.ToIM(valueData["row"], cu.IM{}), cu.ToInteger(valueData["index"], 0), false)
                        return evt, nil
                }</span>,

                ct.TableEventAddItem: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        view := cu.ToString(stateData["view"], "")
                        typeMap := map[string]func() cu.IM{
                                "addresses": func() cu.IM </span><span class="cov0" title="0">{
                                        var address cu.IM
                                        ut.ConvertToType(md.Address{
                                                Tags:       []string{},
                                                AddressMap: cu.IM{},
                                        }, &amp;address)
                                        return address
                                }</span>,
                                "contacts": func() cu.IM <span class="cov0" title="0">{
                                        var contact cu.IM
                                        ut.ConvertToType(md.Contact{
                                                Tags:       []string{},
                                                ContactMap: cu.IM{},
                                        }, &amp;contact)
                                        return contact
                                }</span>,
                                "events": func() cu.IM <span class="cov0" title="0">{
                                        var event cu.IM
                                        ut.ConvertToType(md.Event{
                                                Tags:     []string{},
                                                EventMap: cu.IM{},
                                        }, &amp;event)
                                        return event
                                }</span>,
                        }
                        <span class="cov0" title="0">if slices.Contains([]string{"addresses", "contacts", "events"}, view) </span><span class="cov0" title="0">{
                                getBase := func() (base cu.IM) </span><span class="cov0" title="0">{
                                        if _, found := project[view]; found </span><span class="cov0" title="0">{
                                                return project
                                        }</span>
                                        <span class="cov0" title="0">return stateData</span>
                                }
                                <span class="cov0" title="0">base := getBase()
                                rows := cu.ToIMA(base[view], []cu.IM{})
                                rows = append(rows, typeMap[view]())
                                base[view] = rows
                                client.SetForm(view, cu.MergeIM(typeMap[view](), cu.IM{}), cu.ToInteger(len(rows)-1, 0), false)
                                return evt, nil</span>
                        }
                        <span class="cov0" title="0">return s.cls.addMapField(evt, projectMap, resultUpdate)</span>
                },

                ct.TableEventFormDelete: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        row := cu.ToIM(valueData["row"], cu.IM{})
                        fieldName := cu.ToString(row["field_name"], "")
                        delete(projectMap, fieldName)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                ct.TableEventFormUpdate: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.updateMapField(evt, projectMap, resultUpdate)
                }</span>,

                ct.TableEventFormChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                ct.TableEventFormCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                "map_field": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        stateData["map_field"] = value
                        return resultUpdate(cu.IM{"dirty": false})
                }</span>,

                "queue": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.ToIM(client.Data["modal"], cu.IM{})
                        modalData := cu.ToIM(modal["data"], cu.IM{})
                        if err = s.cls.insertPrintQueue(ds, modalData); err == nil </span><span class="cov0" title="0">{
                                return s.cls.evtMsg(evt.Name, evt.TriggerName, client.Msg("report_add_queue"), ct.ToastTypeSuccess, 5), nil
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "tags": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorTags(evt, projectMeta, resultUpdate)
                }</span>,

                "project_name": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        project[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "customer_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorCodeSelector(evt, "project", strings.Split(fieldName, "_")[0], project, resultUpdate)
                }</span>,

                "notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        projectMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "start_date": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        projectMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "end_date": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        projectMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "inactive": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        projectMeta[fieldName] = cu.ToBoolean(value, false)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := fieldMap[fieldName]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">if slices.Contains([]string{"orientation", "template", "paper_size", "copy"}, fieldName) </span><span class="cov0" title="0">{
                modal := cu.ToIM(client.Data["modal"], cu.IM{})
                modalData := cu.ToIM(modal["data"], cu.IM{})
                modalData[fieldName] = value
                client.SetForm("report", modalData, 0, true)
                return evt, nil
        }</span>
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *ProjectService) Response(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        switch evt.Name </span>{
        case ct.FormEventOK:<span class="cov0" title="0">
                return s.formNext(evt)</span>

        case ct.ClientEventForm:<span class="cov0" title="0">
                return s.formEvent(evt)</span>

        case ct.ClientEventSideMenu:<span class="cov0" title="0">
                return s.sideMenu(evt)</span>

        default:<span class="cov0" title="0">
                return s.editorField(evt)</span>
        }
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package service

import (
        "slices"
        "strings"
        "time"

        ct "github.com/nervatura/component/pkg/component"
        cu "github.com/nervatura/component/pkg/util"
        md "github.com/nervatura/nervatura/v6/pkg/model"
        ut "github.com/nervatura/nervatura/v6/pkg/service/utils"
)

type SearchService struct {
        cls *ClientService
}

func NewSearchService(cls *ClientService) *SearchService <span class="cov0" title="0">{
        return &amp;SearchService{
                cls: cls,
        }
}</span>

func (s *SearchService) Data(evt ct.ResponseEvent, params cu.IM) (data cu.IM, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        ds := s.cls.getDataStore(client.Ticket.Database)

        data = cu.IM{"result": []cu.IM{}}
        view := cu.ToString(params["view"], "")
        query := md.Query{}
        if pq, found := params["query"].(md.Query); found </span><span class="cov0" title="0">{
                query = pq
        }</span>
        <span class="cov0" title="0">filters := []ct.BrowserFilter{}
        if pf, found := params["filters"].([]ct.BrowserFilter); found </span><span class="cov0" title="0">{
                filters = pf
        }</span>

        <span class="cov0" title="0">queryFilters := []string{}
        for _, filter := range filters </span><span class="cov0" title="0">{
                queryFilters = s.cls.UI.SearchConfig.Filter(view, filter, queryFilters)
        }</span>

        <span class="cov0" title="0">if len(queryFilters) &gt; 0 </span><span class="cov0" title="0">{
                queryFilter := strings.Join(queryFilters, " ")
                queryFilter, _ = strings.CutPrefix(queryFilter, "or ")
                queryFilter, _ = strings.CutPrefix(queryFilter, "and ")
                queryFilter = "(" + queryFilter + ")"
                if len(query.Filter) &gt; 0 </span><span class="cov0" title="0">{
                        queryFilter = " and " + queryFilter
                }</span>
                <span class="cov0" title="0">query.Filter += queryFilter</span>
        }

        <span class="cov0" title="0">data["result"], err = ds.StoreDataQuery(query, false)
        return data, err</span>
}

func (s *SearchService) sideMenu(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, stateKey, stateData := client.GetStateData()
        groups := s.cls.UI.SearchConfig.SideGroups(client.Labels())
        switch strings.Split(cu.ToString(evt.Value, ""), "_")[0] </span>{

        case "group":<span class="cov0" title="0">
                viewName := stateKey
                simple := cu.ToBoolean(stateData["simple"], false)
                if cu.ToString(stateData["side_group"], "") == cu.ToString(evt.Value, "") </span><span class="cov0" title="0">{
                        stateData["side_group"] = ""
                }</span> else<span class="cov0" title="0"> {
                        stateData["side_group"] = evt.Value
                        if idx := slices.IndexFunc(groups, func(g md.SideGroup) bool </span><span class="cov0" title="0">{
                                return g.Name == evt.Value
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                viewName = groups[idx].Views[0]
                                simple = s.cls.UI.SearchConfig.View(viewName, client.Labels()).Simple
                                stateData["rows"] = []cu.IM{}
                                stateData["filter_value"] = ""
                        }</span>
                }
                <span class="cov0" title="0">client.SetSearch(viewName, stateData, simple)</span>

        default:<span class="cov0" title="0">
                stateData["rows"] = []cu.IM{}
                stateData["filter_value"] = ""
                client.SetSearch(cu.ToString(evt.Value, ""), stateData, s.cls.UI.SearchConfig.View(cu.ToString(evt.Value, ""), cu.SM{}).Simple)</span>

        }
        <span class="cov0" title="0">return evt, err</span>
}

func (s *SearchService) Response(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, stateKey, stateData := client.GetStateData()

        switch evt.Name </span>{
        case ct.ClientEventSideMenu:<span class="cov0" title="0">
                return s.sideMenu(evt)</span>

        case ct.BrowserEventBookmark:<span class="cov0" title="0">
                modal := cu.IM{
                        "title":         client.Msg("bookmark_new"),
                        "icon":          ct.IconStar,
                        "label":         client.Msg("bookmark_enter"),
                        "placeholder":   "",
                        "field_name":    "value",
                        "default_value": "",
                        "required":      false,
                        "next":          "bookmark_add",
                }
                client.SetForm("input_string", modal, 0, true)</span>

        case ct.FormEventOK:<span class="cov0" title="0">
                sConf := s.cls.UI.SearchConfig.View(stateKey, client.ClientLabels(client.Lang))
                visibleColumns := client.GetSearchVisibleColumns(ut.ToBoolMap(sConf.VisibleColumns, map[string]bool{}))
                viewData := cu.ToIM(stateData[stateKey], cu.IM{})
                frmValues := cu.ToIM(evt.Value, cu.IM{})
                frmValue := cu.ToIM(frmValues["value"], cu.IM{})
                label := cu.ToString(frmValue["value"], "")
                bookmark := md.Bookmark{
                        BookmarkType: md.BookmarkTypeBrowser,
                        Label:        label,
                        Key:          stateKey,
                        Code:         sConf.Title,
                        Filters:      viewData["filters"],
                        Columns:      visibleColumns,
                        TimeStamp:    md.TimeDateTime{Time: time.Now()},
                }
                return s.cls.addBookmark(evt, bookmark), nil</span>

        }
        <span class="cov0" title="0">return evt, err</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package service

import (
        "slices"
        "strings"

        ct "github.com/nervatura/component/pkg/component"
        cu "github.com/nervatura/component/pkg/util"
        api "github.com/nervatura/nervatura/v6/pkg/api"
        md "github.com/nervatura/nervatura/v6/pkg/model"
        ut "github.com/nervatura/nervatura/v6/pkg/service/utils"
        st "github.com/nervatura/nervatura/v6/pkg/static"
)

type SettingService struct {
        cls *ClientService
}

func NewSettingService(cls *ClientService) *SettingService <span class="cov0" title="0">{
        return &amp;SettingService{
                cls: cls,
        }
}</span>

func (s *SettingService) Data(evt ct.ResponseEvent, params cu.IM) (data cu.IM, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        ds := s.cls.getDataStore(client.Ticket.Database)
        user := cu.ToIM(client.Ticket.User, cu.IM{})

        userConfig := cu.ToIM(user["auth_map"], cu.IM{})
        data = cu.IM{
                "setting": cu.IM{
                        "id":          cu.ToInteger(user["id"], 0),
                        "lang":        cu.ToString(userConfig["lang"], st.DefaultLang),
                        "theme":       cu.ToString(userConfig["theme"], st.DefaultTheme),
                        "export_sep":  cu.ToString(userConfig["export_sep"], st.DefaultExportSep),
                        "page_size":   cu.ToString(userConfig["page_size"], st.DefaultPaperSize),
                        "orientation": cu.ToString(userConfig["orientation"], st.DefaultOrientation),
                        "pagination":  cu.ToString(userConfig["pagination"], st.DefaultPagination),
                        "history":     cu.ToInteger(userConfig["history"], st.DefaultHistory),
                        "password":    "",
                        "confirm":     "",
                },
                "config_data":   []cu.IM{},
                "config_map":    []cu.IM{},
                "config_values": []cu.IM{},
                "currency":      []cu.IM{},
                "tax":           []cu.IM{},
                "auth":          []cu.IM{},
                "template":      []cu.IM{},
                "dirty":         false,
                "user":          user,
                "editor_icon":   ct.IconCog,
                "editor_title":  "",
        }

        var rows []cu.IM = []cu.IM{}
        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_data", OrderBy: []string{"config_code", "config_key"},
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_data"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_map", OrderBy: []string{"field_name"},
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_map"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config",
                Filters: []md.Filter{
                        {Field: "config_type", Comp: "!=", Value: "CONFIG_REPORT"},
                },
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_values"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "currency",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["currency"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "tax",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["tax"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "auth",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["auth"] = rows

        data["template"], err = ds.ReportList(cu.ToString(ds.Config["NT_REPORT_DIR"], ""), "")

        return data, err</span>
}

func (s *SettingService) update(ds *api.DataStore, user, data cu.IM) (err error) <span class="cov0" title="0">{
        values := cu.IM{}
        config, err := ds.ConvertToByte(data)
        if err == nil </span><span class="cov0" title="0">{
                values["auth_map"] = string(config[:])
                _, err = ds.StoreDataUpdate(md.Update{Values: values, Model: "auth", IDKey: cu.ToInteger(user["id"], 0)})
        }</span>

        <span class="cov0" title="0">return err</span>
}

func (s *SettingService) configUpdate(ds *api.DataStore, data cu.IM) (editor cu.IM, err error) <span class="cov0" title="0">{
        var configData md.Config = md.Config{}
        ut.ConvertToType(data, &amp;configData)
        values := cu.IM{
                "config_type": configData.ConfigType.String(),
        }
        if configData.Code != "" </span><span class="cov0" title="0">{
                values["code"] = configData.Code
        }</span>

        <span class="cov0" title="0">ut.ConvertByteToIMData(configData.Data, values, "data")

        var configID int64
        newConfig := (configData.Id == 0)
        update := md.Update{Values: values, Model: "config"}
        if !newConfig </span><span class="cov0" title="0">{
                update.IDKey = configData.Id
        }</span>
        <span class="cov0" title="0">if configID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newConfig </span><span class="cov0" title="0">{
                var configs []cu.IM = []cu.IM{}
                if configs, err = ds.StoreDataGet(cu.IM{"id": configID, "model": "config"}, true); err == nil </span><span class="cov0" title="0">{
                        data = configs[0]
                }</span>
        }
        <span class="cov0" title="0">return data, err</span>
}

func (s *SettingService) currencyUpdate(ds *api.DataStore, data cu.IM) (editor cu.IM, err error) <span class="cov0" title="0">{
        var currencyData md.Currency = md.Currency{
                CurrencyMeta: md.CurrencyMeta{
                        Tags: []string{},
                },
                CurrencyMap: cu.IM{},
        }
        ut.ConvertToType(data, &amp;currencyData)
        values := cu.IM{}
        if currencyData.Code != "" </span><span class="cov0" title="0">{
                values["code"] = currencyData.Code
        }</span>

        <span class="cov0" title="0">ut.ConvertByteToIMData(currencyData.CurrencyMeta, values, "currency_meta")
        ut.ConvertByteToIMData(currencyData.CurrencyMap, values, "currency_map")

        var currencyID int64
        newConfig := (currencyData.Id == 0)
        update := md.Update{Values: values, Model: "currency"}
        if !newConfig </span><span class="cov0" title="0">{
                update.IDKey = currencyData.Id
        }</span>
        <span class="cov0" title="0">if currencyID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newConfig </span><span class="cov0" title="0">{
                var currencies []cu.IM = []cu.IM{}
                if currencies, err = ds.StoreDataGet(cu.IM{"id": currencyID, "model": "currency"}, true); err == nil </span><span class="cov0" title="0">{
                        data = currencies[0]
                }</span>
        }
        <span class="cov0" title="0">return data, err</span>
}

func (s *SettingService) currencyAdd(evt ct.ResponseEvent, code string) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)

        errorModal := func(msg string) </span><span class="cov0" title="0">{
                modal := cu.IM{
                        "title":      client.Msg("currency_new"),
                        "info_label": msg,
                        "icon":       ct.IconExclamationTriangle,
                }
                client.SetForm("info", modal, 0, true)
        }</span>

        <span class="cov0" title="0">code = strings.ToUpper(code)
        if len(code) != 3 </span><span class="cov0" title="0">{
                errorModal(client.Msg("currency_invalid"))
                return evt, nil
        }</span>

        <span class="cov0" title="0">if _, err = ds.StoreDataGet(cu.IM{"code": code, "model": "currency"}, true); err == nil </span><span class="cov0" title="0">{
                errorModal(client.Msg("currency_exists"))
                return evt, nil
        }</span>

        <span class="cov0" title="0">var currencyData cu.IM
        if currencyData, err = s.currencyUpdate(ds, cu.IM{"code": code}); err == nil </span><span class="cov0" title="0">{
                currencies := cu.ToIMA(stateData["currency"], []cu.IM{})
                currencies = append(currencies, currencyData)
                stateData["currency"] = currencies
        }</span>
        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                errorModal(err.Error())
                return evt, nil
        }</span>
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *SettingService) taxUpdate(ds *api.DataStore, data cu.IM) (editor cu.IM, err error) <span class="cov0" title="0">{
        var taxData md.Tax = md.Tax{
                TaxMeta: md.TaxMeta{
                        Tags: []string{},
                },
                TaxMap: cu.IM{},
        }
        ut.ConvertToType(data, &amp;taxData)
        values := cu.IM{}
        if taxData.Code != "" </span><span class="cov0" title="0">{
                values["code"] = taxData.Code
        }</span>

        <span class="cov0" title="0">ut.ConvertByteToIMData(taxData.TaxMeta, values, "tax_meta")
        ut.ConvertByteToIMData(taxData.TaxMap, values, "tax_map")

        var taxID int64
        newConfig := (taxData.Id == 0)
        update := md.Update{Values: values, Model: "tax"}
        if !newConfig </span><span class="cov0" title="0">{
                update.IDKey = taxData.Id
        }</span>
        <span class="cov0" title="0">if taxID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newConfig </span><span class="cov0" title="0">{
                var taxes []cu.IM = []cu.IM{}
                if taxes, err = ds.StoreDataGet(cu.IM{"id": taxID, "model": "tax"}, true); err == nil </span><span class="cov0" title="0">{
                        data = taxes[0]
                }</span>
        }
        <span class="cov0" title="0">return data, err</span>
}

func (s *SettingService) taxAdd(evt ct.ResponseEvent, code string) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)

        errorModal := func(msg string) </span><span class="cov0" title="0">{
                modal := cu.IM{
                        "title":      client.Msg("tax_new"),
                        "info_label": msg,
                        "icon":       ct.IconExclamationTriangle,
                }
                client.SetForm("info", modal, 0, true)
        }</span>

        <span class="cov0" title="0">code = strings.ToUpper(code)
        if _, err = ds.StoreDataGet(cu.IM{"code": code, "model": "tax"}, true); err == nil </span><span class="cov0" title="0">{
                errorModal(client.Msg("tax_exists"))
                return evt, nil
        }</span>

        <span class="cov0" title="0">var taxData cu.IM
        if taxData, err = s.taxUpdate(ds, cu.IM{"code": code}); err == nil </span><span class="cov0" title="0">{
                taxes := cu.ToIMA(stateData["tax"], []cu.IM{})
                taxes = append(taxes, taxData)
                stateData["tax"] = taxes
        }</span>
        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                errorModal(err.Error())
                return evt, nil
        }</span>
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *SettingService) authUpdate(ds *api.DataStore, data cu.IM) (editor cu.IM, err error) <span class="cov0" title="0">{
        var authData md.Auth = md.Auth{
                UserGroup: md.UserGroup(md.UserGroupUser),
                AuthMeta: md.AuthMeta{
                        Tags:      []string{},
                        Filter:    []md.AuthFilter{},
                        Bookmarks: []md.Bookmark{},
                },
                AuthMap: cu.IM{},
        }
        ut.ConvertToType(data, &amp;authData)
        values := cu.IM{}
        if authData.UserName != "admin" </span><span class="cov0" title="0">{
                values = cu.IM{
                        "user_name":  authData.UserName,
                        "user_group": authData.UserGroup.String(),
                        "disabled":   authData.Disabled,
                }
        }</span>

        <span class="cov0" title="0">ut.ConvertByteToIMData(authData.AuthMeta, values, "auth_meta")
        ut.ConvertByteToIMData(authData.AuthMap, values, "auth_map")

        var authID int64
        newAuth := (authData.Id == 0)
        update := md.Update{Values: values, Model: "auth"}
        if !newAuth </span><span class="cov0" title="0">{
                update.IDKey = authData.Id
        }</span>
        <span class="cov0" title="0">if authID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newAuth </span><span class="cov0" title="0">{
                var auths []cu.IM = []cu.IM{}
                if auths, err = ds.StoreDataGet(cu.IM{"id": authID, "model": "auth"}, true); err == nil </span><span class="cov0" title="0">{
                        data = auths[0]
                }</span>
        }
        <span class="cov0" title="0">return data, err</span>
}

func (s *SettingService) authAdd(evt ct.ResponseEvent, userName string) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)

        errorModal := func(msg string) </span><span class="cov0" title="0">{
                modal := cu.IM{
                        "title":      client.Msg("auth_new"),
                        "info_label": msg,
                        "icon":       ct.IconExclamationTriangle,
                }
                client.SetForm("info", modal, 0, true)
        }</span>

        <span class="cov0" title="0">userName = strings.ReplaceAll(strings.ToLower(userName), " ", "")
        if _, err = ds.StoreDataGet(cu.IM{"user_name": userName, "model": "auth"}, true); err == nil </span><span class="cov0" title="0">{
                errorModal(client.Msg("auth_exists"))
                return evt, nil
        }</span>

        <span class="cov0" title="0">var authData cu.IM
        if authData, err = s.authUpdate(ds,
                cu.IM{"user_name": userName, "user_group": md.UserGroupUser.String()}); err == nil </span><span class="cov0" title="0">{
                auths := cu.ToIMA(stateData["auth"], []cu.IM{})
                auths = append(auths, authData)
                stateData["auth"] = auths
        }</span>
        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                errorModal(err.Error())
                return evt, nil
        }</span>
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *SettingService) password(ds *api.DataStore, user, data cu.IM) (err error) <span class="cov0" title="0">{
        return ds.UserPassword(
                cu.ToString(user["code"], ""), cu.ToString(data["password"], ""), cu.ToString(data["confirm"], ""),
        )
}</span>

func (s *SettingService) sideMenu(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        state, _, stateData := client.GetStateData()
        if state != "form" </span><span class="cov0" title="0">{
                stateData["view"] = cu.ToString(evt.Value, "")
        }</span>

        /*
                menuMap := map[string]func() (re ct.ResponseEvent, err error){
                        "config_map": func() (re ct.ResponseEvent, err error) {
                                stateData["view"] = "config_map"
                                return evt, err
                        },
                }

                if fn, ok := menuMap[cu.ToString(evt.Value, "")]; ok {
                        return fn()
                }
        */

        <span class="cov0" title="0">return evt, err</span>
}

func (s *SettingService) formNextTags(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})

        tag := cu.ToString(frmValue["value"], "")
        frmKey := cu.ToString(frmData["frm_key"], "")
        frmIndex := cu.ToInteger(frmData["frm_index"], 0)
        row := cu.ToIM(frmData["row"], cu.IM{})
        rowField := cu.ToString(frmData["row_field"], "")
        metaName := ut.MetaName(row, cu.ToString(frmData["meta_name"], "_meta"))
        if tag != "" </span><span class="cov0" title="0">{
                tags := ut.ToStringArray(row[rowField])
                if metaName != "" </span><span class="cov0" title="0">{
                        tags = ut.ToStringArray(cu.ToIM(row[metaName], cu.IM{})[rowField])
                }</span>
                <span class="cov0" title="0">if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                        tags = append(tags, tag)
                        if metaName != "" </span><span class="cov0" title="0">{
                                cu.ToIM(row[metaName], cu.IM{})[rowField] = tags
                        }</span> else<span class="cov0" title="0"> {
                                row[rowField] = tags
                        }</span>
                        <span class="cov0" title="0">client.SetForm(frmKey, row, frmIndex, false)
                        return evt, nil</span>
                }
        }
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *SettingService) formNext(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        configValues := cu.ToIMA(stateData["config_values"], []cu.IM{})
        currencies := cu.ToIMA(stateData["currency"], []cu.IM{})
        taxes := cu.ToIMA(stateData["tax"], []cu.IM{})
        auth := cu.ToIMA(stateData["auth"], []cu.IM{})
        templates := cu.ToIMA(stateData["template"], []cu.IM{})

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})

        setErrorModal := func(err error) </span><span class="cov0" title="0">{
                if err != nil </span><span class="cov0" title="0">{
                        modal := cu.IM{
                                "info_label":   client.Msg("inputbox_delete_error"),
                                "info_message": err.Error(),
                                "icon":         ct.IconExclamationTriangle,
                        }
                        client.SetForm("info", modal, 0, true)
                }</span>
        }

        <span class="cov0" title="0">nextMap := map[string]func() (re ct.ResponseEvent, err error){
                "form_add_tag": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        return s.formNextTags(evt)
                }</span>,

                "form_update_shortcut_field": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.formEventChangeShortcutField(evt)
                }</span>,

                "config_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if idx := slices.IndexFunc(configValues, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == cu.ToString(frmData["code"], "")
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                if _, err = ds.StoreDataUpdate(md.Update{Model: "config", IDKey: cu.ToInteger(configValues[idx]["id"], 0)}); err == nil </span><span class="cov0" title="0">{
                                        configValues = append(configValues[:idx], configValues[idx+1:]...)
                                        stateData["config_values"] = configValues
                                }</span>
                        }
                        <span class="cov0" title="0">return evt, err</span>
                },

                "template_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if idx := slices.IndexFunc(templates, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == cu.ToString(frmData["code"], "") &amp;&amp; cu.ToInteger(c["id"], 0) &gt; 0
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                if _, err = ds.StoreDataUpdate(md.Update{Model: "config", IDKey: cu.ToInteger(templates[idx]["id"], 0)}); err == nil </span><span class="cov0" title="0">{
                                        templates[idx]["installed"] = false
                                        templates[idx]["id"] = 0
                                        stateData["template"] = templates
                                }</span>
                        }
                        <span class="cov0" title="0">return evt, err</span>
                },

                "auth_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if idx := slices.IndexFunc(auth, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == cu.ToString(frmData["code"], "")
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                if _, err = ds.StoreDataUpdate(md.Update{Model: "auth", IDKey: cu.ToInteger(auth[idx]["id"], 0)}); err == nil </span><span class="cov0" title="0">{
                                        auth = append(auth[:idx], auth[idx+1:]...)
                                        stateData["auth"] = auth
                                }</span>
                        }
                        <span class="cov0" title="0">return evt, err</span>
                },

                "password_reset": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if err = s.password(ds,
                                cu.IM{"code": cu.ToString(frmData["code"], "")},
                                cu.IM{"password": cu.ToString(frmValue["value"], ""), "confirm": cu.ToString(frmValue["value"], "")}); err == nil </span><span class="cov0" title="0">{
                                modal := cu.IM{
                                        "info_label":   client.Msg("auth_password_reset_ok"),
                                        "info_message": "",
                                        "icon":         ct.IconCheck,
                                }
                                client.SetForm("info", modal, 0, true)
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "currency_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if idx := slices.IndexFunc(currencies, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == cu.ToString(frmData["code"], "")
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                if _, err = ds.StoreDataUpdate(md.Update{Model: "currency", IDKey: cu.ToInteger(currencies[idx]["id"], 0)}); err == nil </span><span class="cov0" title="0">{
                                        currencies = append(currencies[:idx], currencies[idx+1:]...)
                                        stateData["currency"] = currencies
                                }</span>
                        }
                        <span class="cov0" title="0">setErrorModal(err)
                        return evt, nil</span>
                },

                "currency_add": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.currencyAdd(evt, cu.ToString(frmValue["value"], ""))
                }</span>,

                "tax_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if idx := slices.IndexFunc(taxes, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == cu.ToString(frmData["code"], "")
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                if _, err = ds.StoreDataUpdate(md.Update{Model: "tax", IDKey: cu.ToInteger(taxes[idx]["id"], 0)}); err == nil </span><span class="cov0" title="0">{
                                        taxes = append(taxes[:idx], taxes[idx+1:]...)
                                        stateData["tax"] = taxes
                                }</span>
                        }
                        <span class="cov0" title="0">setErrorModal(err)
                        return evt, nil</span>
                },

                "tax_add": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.taxAdd(evt, cu.ToString(frmValue["value"], ""))
                }</span>,

                "auth_add": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.authAdd(evt, cu.ToString(frmValue["value"], ""))
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := nextMap[cu.ToString(frmData["next"], "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">return evt, err</span>
}

func (s *SettingService) formEventChangeAuth(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        configValue := cu.ToIM(form["data"], cu.IM{})
        authMeta := cu.ToIM(configValue["auth_meta"], cu.IM{})

        fieldName := cu.ToString(frmValues["name"], "")

        switch fieldName </span>{
        case "tags":<span class="cov0" title="0">
                return s.cls.editorFormTags(cu.IM{"row_field": fieldName, "meta_name": "auth_meta"}, evt)</span>
        case "filter":<span class="cov0" title="0">
                opt := []ct.SelectOption{}
                ft := md.AuthFilter(0)
                for _, ftKey := range ft.Keys() </span><span class="cov0" title="0">{
                        opt = append(opt, ct.SelectOption{
                                Value: ftKey, Text: ftKey,
                        })
                }</span>
                <span class="cov0" title="0">return s.cls.editorFormTags(cu.IM{"row_field": fieldName, "meta_name": "auth_meta",
                        "options": opt, "value": opt[0].Value, "is_null": false, "form_key": "select",
                        "icon": ct.IconFilter, "title": client.Msg("inputbox_new_filter"),
                        "label": client.Msg("inputbox_enter_filter")}, evt)</span>
        case "user_name", "disabled":<span class="cov0" title="0">
                configValue[fieldName] = frmValues["value"]
                client.SetForm(cu.ToString(stateData["view"], ""), configValue, frmIndex, false)</span>
        case "user_group":<span class="cov0" title="0">
                configValue[fieldName] = frmValues["value"]
                if cu.ToString(frmValues["value"], "") == md.UserGroupAdmin.String() </span><span class="cov0" title="0">{
                        authMeta["filter"] = []md.AuthFilter{}
                }</span>
                <span class="cov0" title="0">client.SetForm(cu.ToString(stateData["view"], ""), configValue, frmIndex, false)</span>
        case "description":<span class="cov0" title="0">
                authMeta[fieldName] = frmValues["value"]
                client.SetForm(cu.ToString(stateData["view"], ""), configValue, frmIndex, false)</span>
        case "password":<span class="cov0" title="0">
                modal := cu.IM{
                        "title":         client.Msg("auth_password"),
                        "icon":          ct.IconKey,
                        "label":         client.Msg("auth_password_enter"),
                        "placeholder":   "",
                        "field_name":    "value",
                        "default_value": "",
                        "required":      false,
                        "next":          "password_reset",
                        "code":          cu.ToString(configValue["code"], ""),
                }
                client.SetForm("input_string", modal, 0, true)</span>
        }

        <span class="cov0" title="0">return evt, err</span>
}

func (s *SettingService) formEventChangeShortcutField(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        row := cu.ToIM(frmValue["row"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        frmKey := cu.ToString(form["key"], "")
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})
        formEvent := cu.ToString(frmValues["form_event"], "")

        switch formEvent </span>{
        case ct.ListEventAddItem, ct.ListEventEditItem:<span class="cov0" title="0">
                row := cu.ToIM(frmValue["row"], cu.IM{})
                modal := cu.IM{
                        "next":        "form_update_shortcut_field",
                        "frm_key":     frmKey,
                        "frm_index":   frmIndex,
                        "row":         frmBaseValues,
                        "field_name":  cu.ToString(row["field_name"], ""),
                        "description": cu.ToString(row["description"], ""),
                        "field_type":  cu.ToString(row["field_type"], md.ShortcutFieldString.String()),
                        "order":       cu.ToInteger(row["order"], 0),
                }
                client.SetForm("config_field", modal, 0, true)</span>

        case ct.ListEventDelete:<span class="cov0" title="0">
                configData := cu.ToIM(frmBaseValues["data"], cu.IM{})
                fields := cu.ToIMA(configData["fields"], []cu.IM{})
                if idx := slices.IndexFunc(fields, func(c cu.IM) bool </span><span class="cov0" title="0">{
                        return cu.ToString(c["field_name"], "") == cu.ToString(row["field_name"], "")
                }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                        fields = append(fields[:idx], fields[idx+1:]...)
                        configData["fields"] = fields
                        frmBaseValues["data"] = configData
                }</span>
                <span class="cov0" title="0">client.SetForm("shortcut", frmBaseValues, frmIndex, false)</span>
        }
        <span class="cov0" title="0">if evt.Name == ct.FormEventOK </span><span class="cov0" title="0">{
                frmBaseValues := cu.ToIM(frmData["row"], cu.IM{})
                configData := cu.ToIM(frmBaseValues["data"], cu.IM{})
                fields := cu.ToIMA(configData["fields"], []cu.IM{})
                if idx := slices.IndexFunc(fields, func(c cu.IM) bool </span><span class="cov0" title="0">{
                        return cu.ToString(c["field_name"], "") == cu.ToString(frmValue["field_name"], "")
                }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                        fields[idx] = frmValue
                }</span> else<span class="cov0" title="0"> {
                        fields = append(fields, frmValue)
                }</span>
                <span class="cov0" title="0">configData["fields"] = fields
                frmBaseValues["data"] = configData
                client.SetForm("shortcut", frmBaseValues, frmIndex, false)</span>
        }
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *SettingService) formEventChange(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        configValue := cu.ToIM(form["data"], cu.IM{})
        configMeta := cu.ToIM(configValue["data"], cu.IM{})

        fieldName := cu.ToString(frmValues["name"], "")
        switch cu.ToString(form["key"], "") </span>{
        case "config_map":<span class="cov0" title="0">
                switch fieldName </span>{
                case "tags":<span class="cov0" title="0">
                        return s.cls.editorFormTags(cu.IM{"row_field": fieldName, "meta_name": "data"}, evt)</span>
                case "filter":<span class="cov0" title="0">
                        opt := []ct.SelectOption{}
                        ft := md.MapFilter(0)
                        for _, ftKey := range ft.Keys() </span><span class="cov0" title="0">{
                                opt = append(opt, ct.SelectOption{
                                        Value: ftKey, Text: ftKey,
                                })
                        }</span>
                        <span class="cov0" title="0">return s.cls.editorFormTags(cu.IM{"row_field": fieldName, "meta_name": "data",
                                "options": opt, "value": opt[0].Value, "is_null": false, "form_key": "select",
                                "icon": ct.IconFilter, "title": client.Msg("inputbox_new_filter"),
                                "label": client.Msg("inputbox_enter_filter")}, evt)</span>

                case "field_name", "field_type", "description":<span class="cov0" title="0">
                        configMeta[fieldName] = frmValues["value"]
                        client.SetForm(cu.ToString(stateData["view"], ""), configValue, frmIndex, false)</span>
                }

        case "shortcut":<span class="cov0" title="0">
                switch fieldName </span>{
                case "fields":<span class="cov0" title="0">
                        return s.formEventChangeShortcutField(evt)</span>
                default:<span class="cov0" title="0">
                        configMeta[fieldName] = frmValues["value"]
                        client.SetForm(cu.ToString(stateData["view"], ""), configValue, frmIndex, false)</span>
                }

        case "auth":<span class="cov0" title="0">
                return s.formEventChangeAuth(evt)</span>
        }

        <span class="cov0" title="0">return evt, err</span>
}

func (s *SettingService) formEvent(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        configValues := cu.ToIMA(stateData["config_values"], []cu.IM{})
        authValues := cu.ToIMA(stateData["auth"], []cu.IM{})

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmEvent := cu.ToString(frmValues["event"], "")
        configValue := cu.ToIM(form["data"], cu.IM{})
        configMeta := cu.ToIM(configValue["data"], cu.IM{})
        delete := (cu.ToString(frmValue["form_delete"], "") != "")

        updateMap := map[string]func(){
                "config_map": func() </span><span class="cov0" title="0">{
                        configMeta["field_name"] = cu.ToString(frmValue["field_name"], "")
                        configMeta["field_type"] = cu.ToString(frmValue["field_type"], "")
                        configMeta["description"] = cu.ToString(frmValue["description"], "")
                        if idx := slices.IndexFunc(configValues, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == cu.ToString(configValue["code"], "")
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                if configValue, err = s.configUpdate(ds, configValue); err == nil </span><span class="cov0" title="0">{
                                        configValues[idx] = configValue
                                        stateData["config_values"] = configValues
                                }</span>
                        }
                },
                "shortcut": func() <span class="cov0" title="0">{
                        configMeta["shortcut_key"] = cu.ToString(frmValue["shortcut_key"], "")
                        configMeta["method"] = cu.ToString(frmValue["method"], "")
                        configMeta["description"] = cu.ToString(frmValue["description"], "")
                        configMeta["func_name"] = cu.ToString(frmValue["func_name"], "")
                        configMeta["address"] = cu.ToString(frmValue["address"], "")
                        configMeta["modul"] = cu.ToString(frmValue["modul"], "")
                        configMeta["icon"] = cu.ToString(frmValue["icon"], "")
                        if idx := slices.IndexFunc(configValues, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == cu.ToString(configValue["code"], "")
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                if configValue, err = s.configUpdate(ds, configValue); err == nil </span><span class="cov0" title="0">{
                                        configValues[idx] = configValue
                                        stateData["config_values"] = configValues
                                }</span>
                        }
                },
                "auth": func() <span class="cov0" title="0">{
                        if idx := slices.IndexFunc(authValues, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == cu.ToString(configValue["code"], "")
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                if configValue, err = s.authUpdate(ds, configValue); err == nil </span><span class="cov0" title="0">{
                                        authValues[idx] = configValue
                                        stateData["auth"] = authValues
                                }</span>
                        }
                },
        }

        <span class="cov0" title="0">eventMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.FormEventOK: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        if fn, ok := updateMap[cu.ToString(form["key"], "")]; ok </span><span class="cov0" title="0">{
                                fn()
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                ct.FormEventCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        switch cu.ToString(form["key"], "") </span>{
                        case "config_map", "shortcut":<span class="cov0" title="0">
                                if delete </span><span class="cov0" title="0">{
                                        configValue := cu.ToIM(form["data"], cu.IM{})
                                        modal := cu.IM{
                                                "warning_label":   client.Msg("inputbox_delete"),
                                                "warning_message": "",
                                                "next":            "config_delete",
                                                "code":            cu.ToString(configValue["code"], ""),
                                        }
                                        client.SetForm("warning", modal, 0, true)
                                }</span>
                                <span class="cov0" title="0">if cu.ToString(configValue["code"], "") == "" </span><span class="cov0" title="0">{
                                        if idx := slices.IndexFunc(configValues, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                                return cu.ToString(c["code"], "") == ""
                                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                                configValues = append(configValues[:idx], configValues[idx+1:]...)
                                                stateData["config_values"] = configValues
                                        }</span>
                                }
                        case "auth":<span class="cov0" title="0">
                                if delete </span><span class="cov0" title="0">{
                                        authValue := cu.ToIM(form["data"], cu.IM{})
                                        modal := cu.IM{
                                                "warning_label":   client.Msg("inputbox_delete"),
                                                "warning_message": "",
                                                "next":            "auth_delete",
                                                "code":            cu.ToString(authValue["code"], ""),
                                        }
                                        client.SetForm("warning", modal, 0, true)
                                }</span>
                        }
                        <span class="cov0" title="0">return evt, err</span>
                },

                ct.FormEventChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.formEventChange(evt)
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := eventMap[frmEvent]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>

        <span class="cov0" title="0">return evt, err</span>

}

func (s *SettingService) editorFieldTable(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        view := cu.ToString(stateData["view"], "")
        configValues := cu.ToIMA(stateData["config_values"], []cu.IM{})
        currencies := cu.ToIMA(stateData["currency"], []cu.IM{})
        taxes := cu.ToIMA(stateData["tax"], []cu.IM{})
        templates := cu.ToIMA(stateData["template"], []cu.IM{})

        values := cu.ToIM(evt.Value, cu.IM{})
        fieldName := cu.ToString(values["name"], "")

        updateMap := map[string]func(row cu.IM){
                "config_data": func(row cu.IM) </span><span class="cov0" title="0">{
                        configCode := cu.ToString(row["config_code"], "")
                        fieldName := cu.ToString(row["config_key"], "")
                        if idx := slices.IndexFunc(configValues, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == configCode
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                configData := cu.ToIM(configValues[idx]["data"], cu.IM{})
                                configData[fieldName] = row["config_value"]
                                configValues[idx]["data"] = configData
                                if configValues[idx], err = s.configUpdate(ds, configValues[idx]); err == nil </span><span class="cov0" title="0">{
                                        stateData["config_values"] = configValues
                                }</span>
                        }
                },
                "currency": func(row cu.IM) <span class="cov0" title="0">{
                        currencyCode := cu.ToString(row["code"], "")
                        if idx := slices.IndexFunc(currencies, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == currencyCode
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                currencyMeta := cu.ToIM(currencies[idx]["currency_meta"], cu.IM{})
                                currencyMeta["description"] = row["description"]
                                currencyMeta["digit"] = cu.ToInteger(row["digit"], 0)
                                currencyMeta["cash_round"] = cu.ToInteger(row["cash_round"], 0)
                                currencies[idx]["currency_meta"] = currencyMeta
                                if currencies[idx], err = s.currencyUpdate(ds, currencies[idx]); err == nil </span><span class="cov0" title="0">{
                                        stateData["currency"] = currencies
                                }</span>
                        }
                },
                "tax": func(row cu.IM) <span class="cov0" title="0">{
                        taxCode := cu.ToString(row["code"], "")
                        if idx := slices.IndexFunc(taxes, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["code"], "") == taxCode
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                taxMeta := cu.ToIM(taxes[idx]["tax_meta"], cu.IM{})
                                taxMeta["description"] = row["description"]
                                taxMeta["rate_value"] = cu.ToFloat(row["rate_value"], 0)
                                taxes[idx]["tax_meta"] = taxMeta
                                if taxes[idx], err = s.taxUpdate(ds, taxes[idx]); err == nil </span><span class="cov0" title="0">{
                                        stateData["tax"] = taxes
                                }</span>
                        }
                },
                "template": func(row cu.IM) <span class="cov0" title="0">{
                        reportKey := cu.ToString(row["report_key"], "")
                        if idx := slices.IndexFunc(templates, func(c cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(c["report_key"], "") == reportKey &amp;&amp; cu.ToInteger(c["id"], 0) == 0
                        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                                var id int64
                                if id, err = ds.ReportInstall(reportKey, cu.ToString(ds.Config["NT_REPORT_DIR"], "")); err == nil </span><span class="cov0" title="0">{
                                        templates[idx]["installed"] = true
                                        templates[idx]["id"] = cu.ToInteger(id, 0)
                                        stateData["template"] = templates
                                        modal := cu.IM{
                                                "info_label":   client.Msg("template_install_ok"),
                                                "info_message": "",
                                                "icon":         ct.IconCheck,
                                        }
                                        client.SetForm("info", modal, 0, true)
                                }</span>
                        }
                },
        }

        <span class="cov0" title="0">fieldMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.TableEventRowSelected: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        client.SetForm(cu.ToString(stateData["view"], ""),
                                cu.ToIM(valueData["row"], cu.IM{}),
                                cu.ToInteger(valueData["index"], 0), false)
                        return evt, nil
                }</span>,

                ct.TableEventFormUpdate: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        values := cu.ToIM(evt.Value, cu.IM{})
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        row := cu.ToIM(valueData["row"], cu.IM{})
                        if fn, ok := updateMap[view]; ok </span><span class="cov0" title="0">{
                                fn(row)
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                ct.TableEventFormDelete: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        values := cu.ToIM(evt.Value, cu.IM{})
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        row := cu.ToIM(valueData["row"], cu.IM{})
                        switch view </span>{
                        case "currency", "tax", "template":<span class="cov0" title="0">
                                if cu.ToInteger(row["id"], 0) &gt; 0 </span><span class="cov0" title="0">{
                                        modal := cu.IM{
                                                "warning_label":   client.Msg("inputbox_delete"),
                                                "warning_message": "",
                                                "next":            view + "_delete",
                                                "code":            cu.ToString(row["code"], ""),
                                        }
                                        client.SetForm("warning", modal, 0, true)
                                }</span>

                        }
                        <span class="cov0" title="0">return evt, err</span>
                },

                ct.TableEventAddItem: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        switch view </span>{
                        case "currency":<span class="cov0" title="0">
                                modal := cu.IM{
                                        "title":         client.Msg("currency_new"),
                                        "icon":          ct.IconDollar,
                                        "label":         client.Msg("currency_enter"),
                                        "placeholder":   "",
                                        "field_name":    "value",
                                        "default_value": "",
                                        "required":      false,
                                        "next":          "currency_add",
                                }
                                client.SetForm("input_string", modal, 0, true)</span>

                        case "tax":<span class="cov0" title="0">
                                modal := cu.IM{
                                        "title":         client.Msg("tax_new"),
                                        "icon":          ct.IconTicket,
                                        "label":         client.Msg("tax_enter"),
                                        "placeholder":   "",
                                        "field_name":    "value",
                                        "default_value": "",
                                        "required":      false,
                                        "next":          "tax_add",
                                }
                                client.SetForm("input_string", modal, 0, true)</span>
                        }
                        <span class="cov0" title="0">return evt, err</span>
                },
        }

        <span class="cov0" title="0">return fieldMap[fieldName]()</span>
}

func (s *SettingService) editorField(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, stateKey, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        user := client.Ticket.User
        setting := cu.ToIM(stateData["setting"], cu.IM{})
        configValues := cu.ToIMA(stateData["config_values"], []cu.IM{})

        values := cu.ToIM(evt.Value, cu.IM{})
        fieldName := cu.ToString(values["name"], "")
        value := cu.ToString(values["value"], "")

        configUpdate := func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                setting[fieldName] = value
                userConfig := cu.ToIM(user["auth_map"], cu.IM{})
                userConfig[fieldName] = value
                if err = s.update(ds, user, userConfig); err != nil </span><span class="cov0" title="0">{
                        return evt, err
                }</span>
                <span class="cov0" title="0">client.Ticket.User["auth_map"] = userConfig
                client.SetProperty(fieldName, value)
                stateData["setting"] = setting
                client.SetEditor(stateKey, cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">resultUpdate := func(dirty bool) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                setting[fieldName] = value
                stateData["setting"] = setting
                if dirty </span><span class="cov0" title="0">{
                        stateData["dirty"] = dirty
                }</span>
                <span class="cov0" title="0">client.SetEditor("setting", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">fieldMap := map[string]func() (re ct.ResponseEvent, err error){
                "theme": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        return configUpdate()
                }</span>,
                "lang": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return configUpdate()
                }</span>,
                "page_size": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return configUpdate()
                }</span>,
                "orientation": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return configUpdate()
                }</span>,
                "pagination": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return configUpdate()
                }</span>,
                "history": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return configUpdate()
                }</span>,
                "export_sep": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return configUpdate()
                }</span>,
                "password": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return resultUpdate(true)
                }</span>,
                "confirm": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return resultUpdate(true)
                }</span>,
                "change_password": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if err = s.password(ds, user, setting); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">setting["password"] = ""
                        setting["confirm"] = ""
                        stateData["setting"] = setting
                        stateData["dirty"] = false
                        client.SetEditor(stateKey, cu.ToString(stateData["view"], ""), stateData)
                        return s.cls.evtMsg(evt.Name, evt.TriggerName, client.Msg("setting_password_ok"), ct.ToastTypeSuccess, 5), nil</span>
                },
                "config_map": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        event := cu.ToString(cu.ToIM(evt.Value, cu.IM{})["event"], "")
                        evValue := cu.ToIM(cu.ToIM(evt.Value, cu.IM{})["value"], cu.IM{})
                        row := cu.ToIM(evValue["row"], cu.IM{})
                        index := cu.ToInteger(evValue["index"], 0)
                        switch event </span>{
                        case ct.ListEventEditItem:<span class="cov0" title="0">
                                client.SetForm("config_map", row, index, false)</span>

                        case ct.ListEventDelete:<span class="cov0" title="0">
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_delete"),
                                        "warning_message": "",
                                        "next":            "config_delete",
                                        "code":            cu.ToString(row["code"], ""),
                                }
                                client.SetForm("warning", modal, 0, true)</span>

                        case ct.ListEventAddItem:<span class="cov0" title="0">
                                configValue := cu.IM{
                                        "id":          0,
                                        "code":        "",
                                        "config_type": md.ConfigTypeMap.String(),
                                        "data": cu.IM{
                                                "field_name":  "",
                                                "field_type":  md.FieldTypeString.String(),
                                                "description": "",
                                                "tags":        []string{},
                                                "filter":      []md.MapFilter{},
                                        },
                                }
                                configValues = append(configValues, configValue)
                                stateData["config_values"] = configValues
                                client.SetForm("config_map", configValue, int64(len(configValues)-1), false)</span>
                        }
                        <span class="cov0" title="0">return evt, err</span>
                },
                "shortcut": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        event := cu.ToString(cu.ToIM(evt.Value, cu.IM{})["event"], "")
                        evValue := cu.ToIM(cu.ToIM(evt.Value, cu.IM{})["value"], cu.IM{})
                        row := cu.ToIM(evValue["row"], cu.IM{})
                        index := cu.ToInteger(evValue["index"], 0)
                        switch event </span>{
                        case ct.ListEventEditItem:<span class="cov0" title="0">
                                client.SetForm("shortcut", row, index, false)</span>

                        case ct.ListEventDelete:<span class="cov0" title="0">
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_delete"),
                                        "warning_message": "",
                                        "next":            "config_delete",
                                        "code":            cu.ToString(row["code"], ""),
                                }
                                client.SetForm("warning", modal, 0, true)</span>

                        case ct.ListEventAddItem:<span class="cov0" title="0">
                                configValue := cu.IM{
                                        "id":          0,
                                        "code":        "",
                                        "config_type": md.ConfigTypeShortcut.String(),
                                        "data": cu.IM{
                                                "shortcut_key": "",
                                                "method":       md.ShortcutMethodGET.String(),
                                                "description":  "",
                                                "func_name":    "",
                                                "address":      "",
                                                "modul":        "",
                                                "icon":         "",
                                                "fields":       []cu.IM{},
                                        },
                                }
                                configValues = append(configValues, configValue)
                                stateData["config_values"] = configValues
                                client.SetForm("shortcut", configValue, int64(len(configValues)-1), false)</span>
                        }
                        <span class="cov0" title="0">return evt, err</span>
                },

                "auth": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        event := cu.ToString(cu.ToIM(evt.Value, cu.IM{})["event"], "")
                        evValue := cu.ToIM(cu.ToIM(evt.Value, cu.IM{})["value"], cu.IM{})
                        row := cu.ToIM(evValue["row"], cu.IM{})
                        index := cu.ToInteger(evValue["index"], 0)
                        switch event </span>{
                        case ct.ListEventEditItem:<span class="cov0" title="0">
                                client.SetForm("auth", row, index, false)</span>

                        case ct.ListEventAddItem:<span class="cov0" title="0">
                                modal := cu.IM{
                                        "title":         client.Msg("auth_new"),
                                        "icon":          ct.IconUserLock,
                                        "label":         client.Msg("auth_enter"),
                                        "placeholder":   "",
                                        "field_name":    "value",
                                        "default_value": "",
                                        "required":      false,
                                        "next":          "auth_add",
                                }
                                client.SetForm("input_string", modal, 0, true)</span>
                        }
                        <span class="cov0" title="0">return evt, err</span>
                },

                ct.TableEventRowSelected: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.editorFieldTable(evt)
                }</span>,

                ct.TableEventFormUpdate: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.editorFieldTable(evt)
                }</span>,

                ct.TableEventFormDelete: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.editorFieldTable(evt)
                }</span>,

                ct.TableEventAddItem: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.editorFieldTable(evt)
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := fieldMap[fieldName]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">return evt, err</span>
}

func (s *SettingService) Response(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        switch evt.Name </span>{
        case ct.FormEventOK:<span class="cov0" title="0">
                return s.formNext(evt)</span>

        case ct.ClientEventForm:<span class="cov0" title="0">
                return s.formEvent(evt)</span>

        case ct.ClientEventSideMenu:<span class="cov0" title="0">
                return s.sideMenu(evt)</span>

        default:<span class="cov0" title="0">
                return s.editorField(evt)</span>
        }
}
</pre>
		
		<pre class="file" id="file8" style="display: none">package service

import (
        "fmt"
        "slices"
        "strings"
        "time"

        ct "github.com/nervatura/component/pkg/component"
        cu "github.com/nervatura/component/pkg/util"
        api "github.com/nervatura/nervatura/v6/pkg/api"
        md "github.com/nervatura/nervatura/v6/pkg/model"
        ut "github.com/nervatura/nervatura/v6/pkg/service/utils"
)

type ToolService struct {
        cls *ClientService
}

func NewToolService(cls *ClientService) *ToolService <span class="cov0" title="0">{
        return &amp;ToolService{
                cls: cls,
        }
}</span>

func (s *ToolService) Data(evt ct.ResponseEvent, params cu.IM) (data cu.IM, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        ds := s.cls.getDataStore(client.Ticket.Database)
        user := cu.ToIM(client.Ticket.User, cu.IM{})

        data = cu.IM{
                "tool":          cu.IM{},
                "config_map":    cu.IM{},
                "config_data":   cu.IM{},
                "config_report": cu.IM{},
                "user":          user,
                "dirty":         false,
                "editor_icon":   ct.IconWrench,
                "editor_title":  "",
        }

        if cu.ToString(params["tool_id"], "") != "" || cu.ToString(params["tool_code"], "") != "" </span><span class="cov0" title="0">{
                var tools []cu.IM = []cu.IM{}
                if tools, err = ds.StoreDataQuery(md.Query{
                        Fields: []string{"*"}, From: "tool",
                        Filters: []md.Filter{
                                {Field: "deleted", Comp: "==", Value: false},
                                {Field: "id", Comp: "==", Value: cu.ToInteger(params["tool_id"], 0)},
                                {Or: true, Field: "code", Comp: "==", Value: cu.ToString(params["tool_code"], "")},
                        },
                }, false); err != nil </span><span class="cov0" title="0">{
                        return data, err
                }</span>
                <span class="cov0" title="0">if len(tools) &gt; 0 </span><span class="cov0" title="0">{
                        data["tool"] = tools[0]
                        data["editor_title"] = cu.ToString(tools[0]["code"], "")
                }</span>
        }

        <span class="cov0" title="0">var rows []cu.IM = []cu.IM{}
        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_map",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_map"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"*"}, From: "config_data",
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_data"] = rows

        if rows, err = ds.StoreDataQuery(md.Query{
                Fields: []string{"id", "report_key", "report_name"}, From: "config_report",
                Filters: []md.Filter{
                        {Field: "report_type", Comp: "==", Value: "TOOL"},
                },
        }, false); err != nil </span><span class="cov0" title="0">{
                return data, err
        }</span>
        <span class="cov0" title="0">data["config_report"] = rows

        return data, err</span>
}

func (s *ToolService) update(ds *api.DataStore, data cu.IM) (editor cu.IM, err error) <span class="cov0" title="0">{
        var tool md.Tool = md.Tool{}
        ut.ConvertToType(data["tool"], &amp;tool)
        values := cu.IM{
                "description":  tool.Description,
                "product_code": tool.ProductCode,
        }
        if tool.Code != "" </span><span class="cov0" title="0">{
                values["code"] = tool.Code
        }</span>

        <span class="cov0" title="0">ut.ConvertByteToIMData(tool.Events, values, "events")
        ut.ConvertByteToIMData(tool.ToolMeta, values, "tool_meta")
        ut.ConvertByteToIMData(tool.ToolMap, values, "tool_map")

        var toolID int64
        newTool := (tool.Id == 0)
        update := md.Update{Values: values, Model: "tool"}
        if !newTool </span><span class="cov0" title="0">{
                update.IDKey = tool.Id
        }</span>
        <span class="cov0" title="0">if toolID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newTool </span><span class="cov0" title="0">{
                var tools []cu.IM = []cu.IM{}
                if tools, err = ds.StoreDataGet(cu.IM{"id": toolID, "model": "tool"}, true); err == nil </span><span class="cov0" title="0">{
                        data["tool"] = tools[0]
                        data["editor_title"] = cu.ToString(cu.ToIM(tools[0], cu.IM{})["code"], "")
                }</span>
        }
        <span class="cov0" title="0">return data, err</span>
}

func (s *ToolService) delete(ds *api.DataStore, toolID int64) (err error) <span class="cov0" title="0">{
        return ds.DataDelete("tool", toolID, "")
}</span>

func (s *ToolService) formNext(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        tool := cu.ToIM(stateData["tool"], cu.IM{})
        toolMeta := cu.ToIM(tool["tool_meta"], cu.IM{})
        toolMap := cu.ToIM(tool["tool_map"], cu.IM{})

        resultUpdate := func(dirty bool) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                tool["tool_meta"] = toolMeta
                tool["tool_map"] = toolMap
                stateData["tool"] = tool
                if dirty </span><span class="cov0" title="0">{
                        stateData["dirty"] = dirty
                }</span>
                <span class="cov0" title="0">client.SetEditor("tool", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})

        nextMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_cancel": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        client.ResetEditor()
                        return evt, err
                }</span>,

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if err = s.delete(ds, cu.ToInteger(tool["id"], 0)); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">client.ResetEditor()
                        return evt, err</span>
                },

                "product": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        params := cu.ToIM(stateData["params"], cu.IM{})
                        return s.cls.setEditor(evt, "product", params), nil
                }</span>,

                "editor_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(toolMeta["tags"])
                                if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        toolMeta["tags"] = tags
                                        return resultUpdate(true)
                                }</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "form_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tag := cu.ToString(frmValue["value"], "")
                        frmKey := cu.ToString(frmData["frm_key"], "")
                        frmIndex := cu.ToInteger(frmData["frm_index"], 0)
                        row := cu.ToIM(frmData["row"], cu.IM{})
                        metaName := ut.MetaName(row, "_meta")
                        rowField := cu.ToString(frmData["row_field"], "")
                        if tag != "" </span><span class="cov0" title="0">{
                                tags := ut.ToStringArray(row[rowField])
                                if metaName != "" </span><span class="cov0" title="0">{
                                        tags = ut.ToStringArray(cu.ToIM(row[metaName], cu.IM{})[rowField])
                                }</span>
                                <span class="cov0" title="0">if !slices.Contains(tags, tag) </span><span class="cov0" title="0">{
                                        tags = append(tags, tag)
                                        if metaName != "" </span><span class="cov0" title="0">{
                                                cu.ToIM(row[metaName], cu.IM{})[rowField] = tags
                                        }</span> else<span class="cov0" title="0"> {
                                                row[rowField] = tags
                                        }</span>
                                        <span class="cov0" title="0">client.SetForm(frmKey, row, frmIndex, false)
                                        return evt, nil</span>
                                }
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                "bookmark_add": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        label := cu.ToString(frmValue["value"], "")
                        bookmark := md.Bookmark{
                                BookmarkType: md.BookmarkTypeEditor,
                                Label:        label,
                                Key:          "tool",
                                Code:         cu.ToString(tool["code"], ""),
                                Filters:      []any{},
                                Columns:      map[string]bool{},
                                TimeStamp:    md.TimeDateTime{Time: time.Now()},
                        }
                        return s.cls.addBookmark(evt, bookmark), nil
                }</span>,

                "editor_map_value": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        code := cu.ToString(frmValue["value"], "")
                        model := cu.ToString(frmData["model"], "")
                        mapField := cu.ToString(frmData["map_field"], "")
                        if _, err := ds.GetDataByID(model, 0, code, true); err != nil </span><span class="cov0" title="0">{
                                frmData["label"] = fmt.Sprintf("%s: %s (%s)", client.Msg("invalid_code"), code, model)
                                frmData["default_value"] = code
                                frmData["invalid"] = true
                                client.SetForm("input_string", frmData, 0, true)
                                return evt, nil
                        }</span>
                        <span class="cov0" title="0">toolMap[mapField] = code
                        stateData["map_field"] = ""
                        return resultUpdate(true)</span>
                },
        }

        <span class="cov0" title="0">if fn, ok := nextMap[cu.ToString(frmData["next"], "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">return evt, err</span>
}

func (s *ToolService) formEvent(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        tool := cu.ToIM(stateData["tool"], cu.IM{})

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        frmKey := cu.ToString(form["key"], "")
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})
        frmEvent := cu.ToString(frmValues["event"], "")
        rows := cu.ToIMA(tool[frmKey], []cu.IM{})
        if srows, found := stateData[frmKey]; found &amp;&amp; (len(rows) == 0) </span><span class="cov0" title="0">{
                rows = cu.ToIMA(srows, []cu.IM{})
        }</span>
        <span class="cov0" title="0">delete := (cu.ToString(frmValue["form_delete"], "") != "")

        resultUpdate := func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                if _, found := tool[frmKey]; found </span><span class="cov0" title="0">{
                        tool[frmKey] = rows
                }</span> else<span class="cov0" title="0"> {
                        stateData[frmKey] = rows
                }</span>
                <span class="cov0" title="0">stateData["dirty"] = true
                return evt, err</span>
        }

        <span class="cov0" title="0">eventMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.FormEventOK: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        //rowMeta := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_meta")], cu.IM{})
                        //rowMap := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_map")], cu.IM{})
                        customValues := map[string]func(value any){
                                "base_tags": func(value any) </span><span class="cov0" title="0">{
                                        rows[frmIndex]["tags"] = value
                                }</span>,
                        }
                        <span class="cov0" title="0">return s.cls.editorFormOK(evt, rows, customValues)</span>
                },

                ct.FormEventCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if delete </span><span class="cov0" title="0">{
                                if _, found := stateData[frmKey]; found </span><span class="cov0" title="0">{
                                        deleteRows := cu.ToIMA(stateData[frmKey+"_delete"], []cu.IM{})
                                        deleteRows = append(deleteRows, rows[frmIndex])
                                        stateData[frmKey+"_delete"] = deleteRows
                                }</span>
                                <span class="cov0" title="0">rows = append(rows[:frmIndex], rows[frmIndex+1:]...)
                                return resultUpdate()</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },

                ct.FormEventChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        fieldName := cu.ToString(frmValues["name"], "")
                        switch fieldName </span>{
                        case "tags":<span class="cov0" title="0">
                                return s.cls.editorFormTags(cu.IM{"row_field": fieldName}, evt)</span>
                        default:<span class="cov0" title="0">
                                frmBaseValues[fieldName] = frmValues["value"]
                                cu.ToSM(evt.Header, cu.SM{})[ct.HeaderReswap] = ct.SwapNone</span>
                        }
                        <span class="cov0" title="0">return evt, nil</span>
                },
        }

        <span class="cov0" title="0">if len(rows) &gt; 0 &amp;&amp; frmIndex &lt; int64(len(rows)) </span><span class="cov0" title="0">{
                if fn, ok := eventMap[frmEvent]; ok </span><span class="cov0" title="0">{
                        return fn()
                }</span>
        }

        <span class="cov0" title="0">return evt, err</span>
}

func (s *ToolService) sideMenu(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        tool := cu.ToIM(stateData["tool"], cu.IM{})
        ds := s.cls.getDataStore(client.Ticket.Database)

        menuMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_save": func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        if stateData, err = s.update(ds, stateData); err != nil </span><span class="cov0" title="0">{
                                return evt, err
                        }</span>
                        <span class="cov0" title="0">stateData["dirty"] = false
                        client.SetEditor("tool", cu.ToString(stateData["view"], ""), stateData)
                        return evt, err</span>
                },

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("inputbox_delete"),
                                "warning_message": "",
                                "next":            "editor_delete",
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, err
                }</span>,

                "editor_cancel": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_dirty"),
                                        "warning_message": client.Msg("inputbox_drop"),
                                        "next":            "editor_cancel",
                                }
                                client.SetForm("warning", modal, 0, true)
                        }</span> else<span class="cov0" title="0"> {
                                client.ResetEditor()
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "editor_new": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.setEditor(evt, "tool",
                                cu.IM{
                                        "session_id": client.Ticket.SessionID,
                                }), nil
                }</span>,

                "editor_report": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.showReportSelector(evt, "TOOL", cu.ToString(tool["code"], ""))
                }</span>,

                "editor_bookmark": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "title":         client.Msg("bookmark_new"),
                                "icon":          ct.IconStar,
                                "label":         client.Msg("bookmark_enter"),
                                "placeholder":   "",
                                "field_name":    "value",
                                "default_value": "",
                                "required":      false,
                                "next":          "bookmark_add",
                        }
                        client.SetForm("input_string", modal, 0, true)
                        return evt, nil
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := menuMap[cu.ToString(evt.Value, "")]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>

        <span class="cov0" title="0">return evt, err</span>
}

func (s *ToolService) editorField(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        tool := cu.ToIM(stateData["tool"], cu.IM{})
        toolMeta := cu.ToIM(tool["tool_meta"], cu.IM{})
        toolMap := cu.ToIM(tool["tool_map"], cu.IM{})

        resultUpdate := func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                tool["tool_meta"] = toolMeta
                tool["tool_map"] = toolMap
                stateData["tool"] = tool
                if cu.ToBoolean(params["dirty"], false) </span><span class="cov0" title="0">{
                        stateData["dirty"] = true
                }</span>
                <span class="cov0" title="0">client.SetEditor("tool", cu.ToString(stateData["view"], ""), stateData)
                return evt, err</span>
        }

        <span class="cov0" title="0">values := cu.ToIM(evt.Value, cu.IM{})
        fieldName := cu.ToString(values["name"], "")

        value := cu.ToString(values["value"], "")

        fieldMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.TableEventRowSelected: func() (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        client.SetForm(cu.ToString(stateData["view"], ""), cu.ToIM(valueData["row"], cu.IM{}), cu.ToInteger(valueData["index"], 0), false)
                        return evt, nil
                }</span>,

                ct.TableEventAddItem: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        view := cu.ToString(stateData["view"], "")
                        typeMap := map[string]func() cu.IM{
                                "events": func() cu.IM </span><span class="cov0" title="0">{
                                        var event cu.IM
                                        ut.ConvertToType(md.Event{
                                                Tags:     []string{},
                                                EventMap: cu.IM{},
                                        }, &amp;event)
                                        return event
                                }</span>,
                        }
                        <span class="cov0" title="0">if slices.Contains([]string{"events"}, view) </span><span class="cov0" title="0">{
                                getBase := func() (base cu.IM) </span><span class="cov0" title="0">{
                                        if _, found := tool[view]; found </span><span class="cov0" title="0">{
                                                return tool
                                        }</span>
                                        <span class="cov0" title="0">return stateData</span>
                                }
                                <span class="cov0" title="0">base := getBase()
                                rows := cu.ToIMA(base[view], []cu.IM{})
                                rows = append(rows, typeMap[view]())
                                base[view] = rows
                                client.SetForm(view, cu.MergeIM(typeMap[view](), cu.IM{}), cu.ToInteger(len(rows)-1, 0), false)
                                return evt, nil</span>
                        }
                        <span class="cov0" title="0">return s.cls.addMapField(evt, toolMap, resultUpdate)</span>
                },

                ct.TableEventFormDelete: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        valueData := cu.ToIM(values["value"], cu.IM{})
                        row := cu.ToIM(valueData["row"], cu.IM{})
                        fieldName := cu.ToString(row["field_name"], "")
                        delete(toolMap, fieldName)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                ct.TableEventFormUpdate: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.updateMapField(evt, toolMap, resultUpdate)
                }</span>,

                ct.TableEventFormChange: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                ct.TableEventFormCancel: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return evt, nil
                }</span>,

                "map_field": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        stateData["map_field"] = value
                        return resultUpdate(cu.IM{"dirty": false})
                }</span>,

                "queue": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.ToIM(client.Data["modal"], cu.IM{})
                        modalData := cu.ToIM(modal["data"], cu.IM{})
                        if err = s.cls.insertPrintQueue(ds, modalData); err == nil </span><span class="cov0" title="0">{
                                return s.cls.evtMsg(evt.Name, evt.TriggerName, client.Msg("report_add_queue"), ct.ToastTypeSuccess, 5), nil
                        }</span>
                        <span class="cov0" title="0">return evt, err</span>
                },

                "tags": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorTags(evt, toolMeta, resultUpdate)
                }</span>,

                "description": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        tool[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "product_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorCodeSelector(evt, "tool", strings.Split(fieldName, "_")[0], tool, resultUpdate)
                }</span>,

                "notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        toolMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "serial_number": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        toolMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "inactive": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        toolMeta[fieldName] = cu.ToBoolean(value, false)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,
        }

        <span class="cov0" title="0">if fn, ok := fieldMap[fieldName]; ok </span><span class="cov0" title="0">{
                return fn()
        }</span>
        <span class="cov0" title="0">if slices.Contains([]string{"orientation", "template", "paper_size", "copy"}, fieldName) </span><span class="cov0" title="0">{
                modal := cu.ToIM(client.Data["modal"], cu.IM{})
                modalData := cu.ToIM(modal["data"], cu.IM{})
                modalData[fieldName] = value
                client.SetForm("report", modalData, 0, true)
                return evt, nil
        }</span>
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *ToolService) Response(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        switch evt.Name </span>{
        case ct.FormEventOK:<span class="cov0" title="0">
                return s.formNext(evt)</span>

        case ct.ClientEventForm:<span class="cov0" title="0">
                return s.formEvent(evt)</span>

        case ct.ClientEventSideMenu:<span class="cov0" title="0">
                return s.sideMenu(evt)</span>

        default:<span class="cov0" title="0">
                return s.editorField(evt)</span>
        }
}
</pre>
		
		<pre class="file" id="file9" style="display: none">package service

import (
        "errors"
        "fmt"
        "math"
        "slices"
        "strings"
        "time"

        ct "github.com/nervatura/component/pkg/component"
        cu "github.com/nervatura/component/pkg/util"
        api "github.com/nervatura/nervatura/v6/pkg/api"
        cp "github.com/nervatura/nervatura/v6/pkg/component/client/component"
        md "github.com/nervatura/nervatura/v6/pkg/model"
        ut "github.com/nervatura/nervatura/v6/pkg/service/utils"
)

type TransService struct {
        cls *ClientService
}

func NewTransService(cls *ClientService) *TransService <span class="cov0" title="0">{
        return &amp;TransService{
                cls: cls,
        }
}</span>

var transRowTypeMap = map[string]func(stateData cu.IM) cu.IM{
        "items": func(stateData cu.IM) cu.IM <span class="cov0" title="0">{
                var item cu.IM
                ut.ConvertToType(md.Item{
                        //TransCode: cu.ToString(trans["code"], ""),
                        TaxCode: cu.ToString(cu.ToIMA(stateData["tax_codes"], []cu.IM{})[0]["code"], ""),
                        ItemMeta: md.ItemMeta{
                                Qty:  1,
                                Tags: []string{},
                        },
                        ItemMap: cu.IM{},
                }, &amp;item)
                return item
        }</span>,
        "payments": func(stateData cu.IM) cu.IM <span class="cov8" title="1">{
                var payment cu.IM
                ut.ConvertToType(md.Payment{
                        //TransCode: cu.ToString(trans["code"], ""),
                        PaidDate: md.TimeDate{Time: time.Now()},
                        PaymentMeta: md.PaymentMeta{
                                Amount: 0,
                                Tags:   []string{},
                        },
                        PaymentMap: cu.IM{},
                }, &amp;payment)
                return payment
        }</span>,
        "movements": func(stateData cu.IM) cu.IM <span class="cov0" title="0">{
                var movement cu.IM
                ut.ConvertToType(md.Movement{
                        MovementType: md.MovementType(md.MovementTypeHead),
                        ShippingTime: md.TimeDateTime{Time: time.Now()},
                        MovementMeta: md.MovementMeta{
                                Qty:    0,
                                Notes:  "",
                                Shared: false,
                                Tags:   []string{},
                        },
                        MovementMap: cu.IM{},
                }, &amp;movement)
                return movement
        }</span>,
        "link": func(stateData cu.IM) cu.IM <span class="cov0" title="0">{
                var link cu.IM
                ut.ConvertToType(md.Link{
                        LinkType1: md.LinkType(md.LinkTypePayment),
                        LinkType2: md.LinkType(md.LinkTypeTrans),
                        LinkMeta: md.LinkMeta{
                                Amount: 0,
                                Qty:    0,
                                Rate:   1,
                                Tags:   []string{},
                        },
                        LinkMap: cu.IM{},
                }, &amp;link)
                return link
        }</span>,
}

var transDataQueryBase = map[string]func(trans cu.IM) ([]string, md.Query){
        "items": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{}, md.Query{
                        Fields: []string{"*"}, From: "item",
                        Filters: []md.Filter{
                                {Field: "trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                {Field: "deleted", Comp: "==", Value: false},
                        },
                }
        }</span>,
        "movements": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{}, md.Query{
                        Fields: []string{"*"}, From: "movement",
                        Filters: []md.Filter{
                                {Field: "trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                {Field: "deleted", Comp: "==", Value: false},
                        },
                }
        }</span>,
        "payments": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{}, md.Query{
                        Fields: []string{"*"}, From: "payment",
                        Filters: []md.Filter{
                                {Field: "trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                {Field: "deleted", Comp: "==", Value: false},
                        },
                }
        }</span>,
        "payment_link": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                transType := cu.ToString(trans["trans_type"], "")
                query := md.Query{
                        Fields: []string{"l.*", "pl.place_name", "pl.currency_code", "pt.trans_type",
                                "pt.direction", "pt.code as pt_code", "pm.paid_date", "it.currency_code as invoice_curr"},
                        From: `link l inner join payment_view pm on l.link_code_1 = pm.code inner join trans_view it on l.link_code_2 = it.code 
                        inner join trans_view pt on pm.trans_code = pt.code inner join place pl on pt.place_code = pl.code`,
                        Filters: []md.Filter{
                                {Field: "l.link_type_1", Comp: "==", Value: md.LinkTypePayment.String()},
                                {Field: "l.link_type_2", Comp: "==", Value: md.LinkTypeTrans.String()},
                                {Field: "it.trans_type", Comp: "in", Value: fmt.Sprintf("%s,%s",
                                        md.TransTypeInvoice.String(), md.TransTypeReceipt.String())},
                                {Field: "it.deleted", Comp: "==", Value: false},
                                {Field: "l.deleted", Comp: "==", Value: false},
                        },
                        OrderBy: []string{"pm.id"},
                }
                if slices.Contains([]string{md.TransTypeBank.String(), md.TransTypeCash.String()}, transType) </span><span class="cov8" title="1">{
                        query.Filters = append(query.Filters, md.Filter{Field: "pm.trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")})
                }</span>
                <span class="cov8" title="1">if slices.Contains([]string{md.TransTypeInvoice.String(), md.TransTypeReceipt.String()}, transType) </span><span class="cov8" title="1">{
                        query.Filters = append(query.Filters, md.Filter{Field: "l.link_code_2", Comp: "==", Value: cu.ToString(trans["code"], "")})
                }</span>
                <span class="cov8" title="1">return []string{md.TransTypeInvoice.String(), md.TransTypeReceipt.String(),
                        md.TransTypeBank.String(), md.TransTypeCash.String()}, query</span>
        },
        "trans_cancellation": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{}, md.Query{
                        Fields: []string{"*"}, From: "trans_view",
                        Filters: []md.Filter{
                                {Field: "status", Comp: "==", Value: md.TransStatusCancellation.String()},
                                {Field: "trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                {Field: "deleted", Comp: "==", Value: true},
                        },
                }
        }</span>,
        "transitem_invoice": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{md.TransTypeOrder.String(), md.TransTypeWorksheet.String(), md.TransTypeRent.String()},
                        md.Query{
                                Fields: []string{"i.*", "t.id as trans_id", "t.trans_date", "t.currency_code"},
                                From:   "trans t inner join item i on i.trans_code = t.code",
                                Filters: []md.Filter{
                                        {Field: "t.trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                        {Field: "t.trans_type", Comp: "in", Value: fmt.Sprintf("%s,%s",
                                                md.TransTypeInvoice.String(), md.TransTypeReceipt.String())},
                                        {Field: "t.direction", Comp: "==", Value: cu.ToString(trans["direction"], "")},
                                        {Field: "t.deleted", Comp: "==", Value: false},
                                        {Field: "i.deleted", Comp: "==", Value: false},
                                },
                        }
        }</span>,
        "element_count": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{}, md.Query{
                        Fields: []string{"p.*"},
                        From:   "item i inner join product p on p.code = i.product_code",
                        Filters: []md.Filter{
                                {Field: "i.trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                {Field: "p.product_type", Comp: "==", Value: md.ProductTypeItem.String()},
                                {Field: "p.deleted", Comp: "==", Value: false},
                                {Field: "i.deleted", Comp: "==", Value: false},
                        },
                }
        }</span>,
        "config_report": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                transType := strings.TrimPrefix(cu.ToString(trans["trans_type"], ""), "TRANS_")
                return []string{}, md.Query{
                        Fields: []string{"id", "report_key", "report_name"}, From: "config_report",
                        Filters: []md.Filter{
                                {Field: "report_type", Comp: "==", Value: "TRANS"},
                                {Field: "trans_type", Comp: "==", Value: transType},
                                {Field: "direction", Comp: "==", Value: trans["direction"]},
                        },
                }
        }</span>,
        "movement_inventory": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{md.TransTypeDelivery.String(), md.TransTypeInventory.String(), md.TransTypeProduction.String()},
                        md.Query{
                                Fields: []string{"*"},
                                From:   "movement_inventory",
                                Filters: []md.Filter{
                                        {Field: "trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                },
                        }
        }</span>,
        "movement_waybill": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{md.TransTypeWaybill.String()},
                        md.Query{
                                Fields: []string{"*"},
                                From:   "movement_waybill",
                                Filters: []md.Filter{
                                        {Field: "trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                },
                        }
        }</span>,
        "movement_formula": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{md.TransTypeFormula.String()},
                        md.Query{
                                Fields: []string{"*"},
                                From:   "movement_formula",
                                Filters: []md.Filter{
                                        {Field: "trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                },
                        }
        }</span>,
        "transitem_shipping": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{md.TransTypeOrder.String(), md.TransTypeWorksheet.String(), md.TransTypeRent.String()},
                        md.Query{
                                Fields: []string{
                                        "i.id", "i.code", "i.description", "i.qty", "mv.trans_code",
                                        "mv.shipping_time as shipping_date", "mv.qty as shipping_qty", "pr.product_name",
                                        "'trans' as editor",
                                },
                                From: `item_view i inner join movement_view mv on mv.item_code = i.code inner join product pr on pr.code = mv.product_code`,
                                Filters: []md.Filter{
                                        {Field: "i.trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                },
                        }
        }</span>,
        "tool_movement": func(trans cu.IM) ([]string, md.Query) <span class="cov8" title="1">{
                return []string{
                                md.TransTypeOrder.String(), md.TransTypeWorksheet.String(), md.TransTypeRent.String(),
                                md.TransTypeInvoice.String(), md.TransTypeReceipt.String()},
                        md.Query{
                                Fields: []string{
                                        "mv.id", "t.code as trans_code", "t.direction", "mv.shipping_time", "tl.serial_number", "tl.description",
                                        "'trans' as editor",
                                },
                                From: `trans_view t inner join movement_view mv on mv.trans_code = t.code inner join tool_view tl on tl.code = mv.tool_code`,
                                Filters: []md.Filter{
                                        {Field: "t.trans_type", Comp: "==", Value: md.TransTypeWaybill.String()},
                                        {Field: "t.trans_code", Comp: "==", Value: cu.ToString(trans["code"], "")},
                                },
                        }
        }</span>,
}

var transDataQueryExt = map[string]md.Query{
        "config_map": {
                Fields: []string{"*"}, From: "config_map",
        },
        "config_data": {
                Fields: []string{"*"}, From: "config_data",
        },
        "tax_codes": {
                Fields: []string{"code", "description", "rate_value"}, From: "tax_view",
                OrderBy: []string{"code"},
        },
        "currencies": {
                Fields: []string{"code", "description", "digit"}, From: "currency_view",
                OrderBy: []string{"code"},
        },
        "places": {
                Fields: []string{"code", "place_type", "place_name", "currency_code", "inactive"}, From: "place_view",
                OrderBy: []string{"code"},
        },
}

func (s *TransService) dataDefault(trans cu.IM, configData []cu.IM) (data cu.IM) <span class="cov8" title="1">{
        transMeta := cu.ToIM(trans["trans_meta"], cu.IM{})
        transType := cu.ToString(trans["trans_type"], "")
        valueMap := map[string]func(value string){
                "default_taxcode": func(value string) </span><span class="cov8" title="1">{
                        trans["tax_code"] = value
                }</span>,
                "default_currency": func(value string) <span class="cov8" title="1">{
                        if cp.TransIsItem(transType) </span><span class="cov8" title="1">{
                                trans["currency_code"] = value
                        }</span>
                },
                "default_deadline": func(value string) <span class="cov8" title="1">{
                        if transType == md.TransTypeInvoice.String() </span><span class="cov8" title="1">{
                                transMeta["due_time"] = md.TimeDateTime{Time: time.Now().AddDate(0, 0, int(cu.ToInteger(value, 0)))}
                        }</span>
                        <span class="cov8" title="1">if !slices.Contains([]string{
                                md.TransTypeInvoice.String(), md.TransTypeReceipt.String()}, transType) </span><span class="cov8" title="1">{
                                transMeta["rate"] = cu.ToInteger(value, 0)
                        }</span>
                },
                "default_paidtype": func(value string) <span class="cov8" title="1">{
                        if cp.TransIsItem(transType) </span><span class="cov8" title="1">{
                                transMeta["paid_type"] = value
                        }</span>
                },
                "default_bank": func(value string) <span class="cov8" title="1">{
                        if transType == md.TransTypeBank.String() </span><span class="cov8" title="1">{
                                trans["place_code"] = value
                        }</span>
                },
                "default_chest": func(value string) <span class="cov8" title="1">{
                        if transType == md.TransTypeCash.String() </span><span class="cov8" title="1">{
                                trans["place_code"] = value
                        }</span>
                },
        }
        <span class="cov8" title="1">for _, cf := range configData </span><span class="cov8" title="1">{
                if fn, ok := valueMap[cu.ToString(cf["config_key"], "")]; ok </span><span class="cov8" title="1">{
                        fn(cu.ToString(cf["config_value"], ""))
                }</span>
        }
        <span class="cov8" title="1">trans["trans_meta"] = transMeta
        return trans</span>
}

func (s *TransService) Data(evt ct.ResponseEvent, params cu.IM) (data cu.IM, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        ds := s.cls.getDataStore(client.Ticket.Database)
        user := cu.ToIM(client.Ticket.User, cu.IM{})

        data = cu.IM{
                "trans": cu.IM{
                        "trans_type": cu.ToString(params["trans_type"], md.TransType(0).String()),
                        "direction":  cu.ToString(params["direction"], md.Direction(0).String()),
                        "trans_date": md.TimeDateTime{Time: time.Now()}.Format(time.DateOnly),
                        "trans_code": cu.ToString(params["ref_trans_code"], ""),
                        "trans_meta": cu.IM{
                                "status":      md.TransStatusNormal.String(),
                                "trans_state": md.TransStateOK.String(),
                                "paid_type":   md.PaidTypeOnline.String(),
                                "tags":        []string{},
                                "worksheet":   cu.IM{},
                                "rent":        cu.IM{},
                                "invoice":     cu.IM{},
                        },
                        "trans_map": cu.IM{},
                },
                "items":              []cu.IM{},
                "movements":          []cu.IM{},
                "payments":           []cu.IM{},
                "payment_link":       []cu.IM{},
                "config_map":         []cu.IM{},
                "config_data":        []cu.IM{},
                "config_report":      []cu.IM{},
                "tax_codes":          []cu.IM{},
                "currencies":         []cu.IM{},
                "places":             []cu.IM{},
                "transitem_invoice":  []cu.IM{},
                "trans_cancellation": []cu.IM{},
                "element_count":      []cu.IM{},
                "movement_inventory": []cu.IM{},
                "movement_waybill":   []cu.IM{},
                "movement_formula":   []cu.IM{},
                "transitem_shipping": []cu.IM{},
                "user":               user,
                "dirty":              false,
                "editor_icon":        cu.ToString(params["editor_icon"], ct.IconFileText),
                "editor_title":       cu.ToString(params["editor_title"], ""),
                "customer_name":      "",
                "project_name":       "",
                "place_name":         "",
        }
        if cu.ToString(params["trans_type"], md.TransType(0).String()) == md.TransTypeCash.String() </span><span class="cov8" title="1">{
                data["payments"] = []cu.IM{transRowTypeMap["payments"](data)}
        }</span>

        <span class="cov8" title="1">var rows []cu.IM = []cu.IM{}
        if cu.ToString(params["trans_id"], "") != "" || cu.ToString(params["trans_code"], "") != "" </span><span class="cov8" title="1">{
                var trans []cu.IM = []cu.IM{}
                if trans, err = ds.StoreDataQuery(md.Query{
                        Fields: []string{"*"}, From: "trans",
                        Filters: []md.Filter{
                                //{Field: "deleted", Comp: "==", Value: false},
                                {Field: "id", Comp: "==", Value: cu.ToInteger(params["trans_id"], 0)},
                                {Or: true, Field: "code", Comp: "==", Value: cu.ToString(params["trans_code"], "")},
                        },
                }, false); err != nil </span><span class="cov8" title="1">{
                        return data, err
                }</span>
                <span class="cov8" title="1">if len(trans) &gt; 0 </span><span class="cov8" title="1">{
                        data["trans"] = trans[0]
                        transType := cu.ToString(trans[0]["trans_type"], "")
                        data["editor_title"] = cu.ToString(trans[0]["code"], "")
                        data["editor_icon"] = cp.TransTypeIcon(transType)
                        data["customer_name"] = s.cls.codeName(ds, cu.ToString(trans[0]["customer_code"], ""), "customer")

                        for key, query := range transDataQueryBase </span><span class="cov8" title="1">{
                                if tt, qr := query(trans[0]); len(tt) == 0 || slices.Contains(tt, transType) </span><span class="cov8" title="1">{
                                        if rows, err = ds.StoreDataQuery(qr, false); err != nil </span><span class="cov8" title="1">{
                                                return data, err
                                        }</span>
                                        <span class="cov8" title="1">data[key] = rows</span>
                                }
                        }
                }
        }

        <span class="cov8" title="1">trans := cu.ToIM(data["trans"], cu.IM{})
        for key, query := range transDataQueryExt </span><span class="cov8" title="1">{
                if rows, err = ds.StoreDataQuery(query, false); err != nil </span><span class="cov8" title="1">{
                        return data, err
                }</span>
                <span class="cov8" title="1">data[key] = rows</span>
        }

        <span class="cov8" title="1">if cu.ToInteger(trans["id"], 0) == 0 </span><span class="cov8" title="1">{
                data["trans"] = s.dataDefault(trans, cu.ToIMA(data["config_data"], []cu.IM{}))
        }</span>

        <span class="cov8" title="1">return data, err</span>
}

func (s *TransService) Response(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        switch evt.Name </span>{
        case ct.FormEventOK:<span class="cov8" title="1">
                return s.formNext(evt)</span>

        case ct.ClientEventForm:<span class="cov8" title="1">
                return s.formEvent(evt)</span>

        case ct.ClientEventSideMenu:<span class="cov8" title="1">
                return s.sideMenu(evt)</span>

        default:<span class="cov8" title="1">
                return s.editorField(evt)</span>
        }
}

func (s *TransService) updateItems(ds *api.DataStore, data cu.IM, transCode string) (err error) <span class="cov0" title="0">{
        for _, it := range cu.ToIMA(data["items"], []cu.IM{}) </span><span class="cov0" title="0">{
                var item md.Item = md.Item{
                        TransCode: transCode,
                        ItemMeta: md.ItemMeta{
                                Tags: []string{},
                        },
                        ItemMap: cu.IM{},
                }
                if err = ut.ConvertToType(it, &amp;item); err == nil </span><span class="cov0" title="0">{
                        values := cu.IM{
                                "trans_code":   transCode,
                                "product_code": item.ProductCode,
                                "tax_code":     item.TaxCode,
                        }
                        ut.ConvertByteToIMData(item.ItemMeta, values, "item_meta")
                        ut.ConvertByteToIMData(item.ItemMap, values, "item_map")

                        itemID := item.Id
                        update := md.Update{Values: values, Model: "item"}
                        if itemID &gt; 0 </span><span class="cov0" title="0">{
                                update.IDKey = itemID
                        }</span>
                        <span class="cov0" title="0">if itemID, err = ds.StoreDataUpdate(update); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                        <span class="cov0" title="0">it["id"] = itemID</span>
                }
        }
        <span class="cov0" title="0">return err</span>
}

func (s *TransService) updatePayments(ds *api.DataStore, data cu.IM, transCode string) (err error) <span class="cov0" title="0">{
        for _, it := range cu.ToIMA(data["payments"], []cu.IM{}) </span><span class="cov0" title="0">{
                var payment md.Payment = md.Payment{
                        TransCode: transCode,
                        PaidDate:  md.TimeDate{Time: time.Now()},
                        PaymentMeta: md.PaymentMeta{
                                Tags: []string{},
                        },
                        PaymentMap: cu.IM{},
                }
                if err = ut.ConvertToType(it, &amp;payment); err == nil </span><span class="cov0" title="0">{
                        values := cu.IM{
                                "trans_code": transCode,
                                "paid_date":  payment.PaidDate.String(),
                        }
                        ut.ConvertByteToIMData(payment.PaymentMeta, values, "payment_meta")
                        ut.ConvertByteToIMData(payment.PaymentMap, values, "payment_map")

                        paymentID := payment.Id
                        update := md.Update{Values: values, Model: "payment"}
                        if paymentID &gt; 0 </span><span class="cov0" title="0">{
                                update.IDKey = paymentID
                        }</span>
                        <span class="cov0" title="0">if paymentID, err = ds.StoreDataUpdate(update); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                        <span class="cov0" title="0">it["id"] = paymentID</span>
                }
        }
        <span class="cov0" title="0">return err</span>
}

var movementUpdateValidate = []func(trans md.Trans, movement md.Movement, data cu.IM, msgFunc func(labelID string) string) (bool, error){
        func(trans md.Trans, movement md.Movement, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov0" title="0">{
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("place_name_movement")
                return trans.TransType == md.TransTypeDelivery &amp;&amp; trans.Direction != md.DirectionTransfer &amp;&amp;
                        movement.PlaceCode == "", errors.New(errMsg)
        }</span>,
        func(trans md.Trans, movement md.Movement, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov0" title="0">{
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("place_name_target")
                return trans.TransType == md.TransTypeDelivery &amp;&amp; trans.Direction == md.DirectionTransfer &amp;&amp;
                        movement.PlaceCode == "", errors.New(errMsg)
        }</span>,
        /*
                func(trans md.Trans, movement md.Movement, data cu.IM, msgFunc func(labelID string) string) (bool, error) {
                        errMsg := msgFunc("movement_transfer_error")
                        return trans.TransType == md.TransTypeDelivery &amp;&amp; trans.Direction == md.DirectionTransfer &amp;&amp;
                                        movement.PlaceCode == trans.PlaceCode,
                                errors.New(errMsg)
                },
        */
        func(trans md.Trans, movement md.Movement, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov0" title="0">{
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("product_code")
                return slices.Contains([]string{
                                md.TransTypeDelivery.String(), md.TransTypeFormula.String(), md.TransTypeProduction.String(),
                                md.TransTypeInventory.String()}, trans.TransType.String()) &amp;&amp;
                                movement.ProductCode == "",
                        errors.New(errMsg)
        }</span>,
        func(trans md.Trans, movement md.Movement, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov0" title="0">{
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("place_name_movement")
                return trans.TransType == md.TransTypeProduction &amp;&amp; movement.PlaceCode == "",
                        errors.New(errMsg)
        }</span>,
        func(trans md.Trans, movement md.Movement, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov0" title="0">{
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("tool_code")
                return trans.TransType == md.TransTypeWaybill &amp;&amp; movement.ToolCode == "",
                        errors.New(errMsg)
        }</span>,
}

func (s *TransService) updateMovements(ds *api.DataStore, data cu.IM, trans md.Trans, msgFunc func(labelID string) string) (err error) <span class="cov0" title="0">{
        transferPair := func(movement md.Movement) (baseMovement, targetMovement md.Movement, isNewTransfer bool) </span><span class="cov0" title="0">{
                isNewTransfer = (trans.TransType == md.TransTypeDelivery) &amp;&amp; (trans.Direction == md.DirectionTransfer) &amp;&amp; (movement.Id &lt; 0)
                if isNewTransfer </span><span class="cov0" title="0">{
                        targetMovement = md.Movement{}
                        ut.ConvertToType(movement, &amp;targetMovement)
                        movement.MovementMeta.Qty = -movement.MovementMeta.Qty
                        movement.PlaceCode = trans.PlaceCode
                        return movement, targetMovement, isNewTransfer
                }</span>
                <span class="cov0" title="0">return movement, targetMovement, isNewTransfer</span>
        }

        <span class="cov0" title="0">updateMovement := func(movement md.Movement) (movementID int64, err error) </span><span class="cov0" title="0">{
                values := cu.IM{
                        "movement_type": movement.MovementType.String(),
                        "shipping_time": movement.ShippingTime.String(),
                        "trans_code":    trans.Code,
                }

                // Optional fields
                optionalFields := map[string]string{
                        "product_code":  movement.ProductCode,
                        "tool_code":     movement.ToolCode,
                        "place_code":    movement.PlaceCode,
                        "item_code":     movement.ItemCode,
                        "movement_code": movement.MovementCode,
                }

                for key, value := range optionalFields </span><span class="cov0" title="0">{
                        if value != "" </span><span class="cov0" title="0">{
                                values[key] = value
                        }</span>
                }

                <span class="cov0" title="0">ut.ConvertByteToIMData(movement.MovementMeta, values, "movement_meta")
                ut.ConvertByteToIMData(movement.MovementMap, values, "movement_map")

                update := md.Update{Values: values, Model: "movement"}
                if movement.Id &gt; 0 </span><span class="cov0" title="0">{
                        update.IDKey = movement.Id
                }</span>
                <span class="cov0" title="0">return ds.StoreDataUpdate(update)</span>
        }

        <span class="cov0" title="0">for _, mv := range cu.ToIMA(data["movements"], []cu.IM{}) </span><span class="cov0" title="0">{
                var movement md.Movement = md.Movement{
                        TransCode: trans.TransCode,
                        MovementMeta: md.MovementMeta{
                                Tags: []string{},
                        },
                        MovementMap: cu.IM{},
                }
                if err = ut.ConvertToType(mv, &amp;movement); err == nil </span><span class="cov0" title="0">{

                        //validate movement data
                        for _, validate := range movementUpdateValidate </span><span class="cov0" title="0">{
                                if invalid, err := validate(trans, movement, data, msgFunc); invalid </span><span class="cov0" title="0">{
                                        return err
                                }</span>
                        }

                        <span class="cov0" title="0">movement, targetMovement, isNewTransfer := transferPair(movement)
                        if mv["id"], err = updateMovement(movement); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                        <span class="cov0" title="0">if isNewTransfer </span><span class="cov0" title="0">{
                                var rows []cu.IM
                                if rows, err = ds.StoreDataGet(cu.IM{"id": mv["id"], "model": "movement"}, true); err == nil </span><span class="cov0" title="0">{
                                        targetMovement.MovementCode = cu.ToString(rows[0]["code"], "")
                                        if _, err = updateMovement(targetMovement); err != nil </span><span class="cov0" title="0">{
                                                return err
                                        }</span>
                                }
                        }
                }
        }
        <span class="cov0" title="0">return err</span>
}

func (s *TransService) updateLinks(ds *api.DataStore, data cu.IM) (err error) <span class="cov0" title="0">{
        for _, ln := range cu.ToIMA(data["payment_link"], []cu.IM{}) </span><span class="cov0" title="0">{
                var link md.Link = md.Link{
                        LinkType1: md.LinkType(md.LinkTypePayment),
                        LinkType2: md.LinkType(md.LinkTypeTrans),
                        LinkMeta: md.LinkMeta{
                                Tags: []string{},
                        },
                        LinkMap: cu.IM{},
                }
                if err = ut.ConvertToType(ln, &amp;link); err == nil </span><span class="cov0" title="0">{
                        values := cu.IM{
                                "link_type_1": link.LinkType1.String(),
                                "link_code_1": link.LinkCode1,
                                "link_type_2": link.LinkType2.String(),
                                "link_code_2": link.LinkCode2,
                        }
                        ut.ConvertByteToIMData(link.LinkMeta, values, "link_meta")
                        ut.ConvertByteToIMData(link.LinkMap, values, "link_map")

                        linkID := link.Id
                        update := md.Update{Values: values, Model: "link"}
                        if linkID &gt; 0 </span><span class="cov0" title="0">{
                                update.IDKey = linkID
                        }</span>
                        <span class="cov0" title="0">if linkID, err = ds.StoreDataUpdate(update); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                        <span class="cov0" title="0">ln["id"] = linkID</span>
                }
        }
        <span class="cov0" title="0">return err</span>
}

func (s *TransService) updateDeleteRows(ds *api.DataStore, data cu.IM) (err error) <span class="cov0" title="0">{
        deleteRows := func(model, deleteKey string) (err error) </span><span class="cov0" title="0">{
                for _, it := range cu.ToIMA(data[deleteKey], []cu.IM{}) </span><span class="cov0" title="0">{
                        if err = ds.DataDelete(model, cu.ToInteger(it["id"], 0), ""); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                }
                <span class="cov0" title="0">return err</span>
        }

        <span class="cov0" title="0">deleteMap := cu.SM{
                "items_delete":        "item",
                "payments_delete":     "payment",
                "payment_link_delete": "link",
                "movements_delete":    "movement",
        }

        for deleteKey, model := range deleteMap </span><span class="cov0" title="0">{
                if err = deleteRows(model, deleteKey); err != nil </span><span class="cov0" title="0">{
                        return err
                }</span>
        }
        <span class="cov0" title="0">return err</span>
}

var transUpdateValidate = []func(trans md.Trans, data cu.IM, msgFunc func(labelID string) string) (bool, error){
        func(trans md.Trans, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov8" title="1">{
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("customer_name")
                return cp.TransIsItem(trans.TransType.String()) &amp;&amp; trans.CustomerCode == "",
                        errors.New(errMsg)
        }</span>,
        func(trans md.Trans, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov0" title="0">{
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("place_name_payment")
                return (trans.TransType == md.TransTypeCash || trans.TransType == md.TransTypeBank) &amp;&amp; trans.PlaceCode == "",
                        errors.New(errMsg)
        }</span>,
        func(trans md.Trans, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov0" title="0">{
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("place_name_movement")
                return (trans.TransType == md.TransTypeInventory || trans.TransType == md.TransTypeProduction ||
                                (trans.TransType == md.TransTypeDelivery &amp;&amp; trans.Direction == md.DirectionTransfer)) &amp;&amp; trans.PlaceCode == "",
                        errors.New(errMsg)
        }</span>,
        func(trans md.Trans, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov0" title="0">{
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("due_time")
                return trans.TransType == md.TransTypeProduction &amp;&amp; trans.TransMeta.DueTime.Time.IsZero(),
                        errors.New(errMsg)
        }</span>,
        func(trans md.Trans, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov0" title="0">{
                movements := cu.ToIMA(data["movements"], []cu.IM{})
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("product_code")
                return (trans.TransType == md.TransTypeProduction || trans.TransType == md.TransTypeFormula) &amp;&amp;
                                (len(movements) == 0 || cu.ToString(movements[0]["product_code"], "") == ""),
                        errors.New(errMsg)
        }</span>,
        func(trans md.Trans, data cu.IM, msgFunc func(labelID string) string) (bool, error) <span class="cov0" title="0">{
                errMsg := msgFunc("missing_required_field") + ": " + msgFunc("trans_code") + " or " + msgFunc("customer_name") + " or " + msgFunc("employee_code")
                return trans.TransType == md.TransTypeWaybill &amp;&amp; trans.TransCode == "" &amp;&amp; trans.CustomerCode == "" &amp;&amp; trans.EmployeeCode == "",
                        errors.New(errMsg)
        }</span>,
}

func (s *TransService) update(ds *api.DataStore, data cu.IM, msgFunc func(labelID string) string) (transID int64, err error) <span class="cov8" title="1">{
        user := cu.ToIM(data["user"], cu.IM{})
        var trans md.Trans = md.Trans{}
        ut.ConvertToType(data["trans"], &amp;trans)

        for _, validate := range transUpdateValidate </span><span class="cov8" title="1">{
                if invalid, err := validate(trans, data, msgFunc); invalid </span><span class="cov8" title="1">{
                        return 0, err
                }</span>
        }

        <span class="cov0" title="0">values := cu.IM{
                "trans_type":    trans.TransType.String(),
                "direction":     trans.Direction.String(),
                "trans_date":    trans.TransDate.String(),
                "customer_code": nil,
                "employee_code": nil,
                "project_code":  nil,
                "place_code":    nil,
                "trans_code":    nil,
                "currency_code": nil,
        }

        // Optional fields
        optionalFields := map[string]string{
                "code":          trans.Code,
                "customer_code": trans.CustomerCode,
                "employee_code": trans.EmployeeCode,
                "project_code":  trans.ProjectCode,
                "place_code":    trans.PlaceCode,
                "trans_code":    trans.TransCode,
                "currency_code": trans.CurrencyCode,
        }

        for key, value := range optionalFields </span><span class="cov0" title="0">{
                if value != "" </span><span class="cov0" title="0">{
                        values[key] = value
                }</span>
        }

        <span class="cov0" title="0">ut.ConvertByteToIMData(trans.TransMeta, values, "trans_meta")
        ut.ConvertByteToIMData(trans.TransMap, values, "trans_map")

        //var transID int64
        newTrans := (trans.Id == 0)
        update := md.Update{Values: values, Model: "trans"}
        if !newTrans </span><span class="cov0" title="0">{
                update.IDKey = trans.Id
        }</span> else<span class="cov0" title="0"> {
                values["auth_code"] = user["code"]
        }</span>
        <span class="cov0" title="0">if transID, err = ds.StoreDataUpdate(update); err == nil &amp;&amp; newTrans </span><span class="cov0" title="0">{
                var rows []cu.IM = []cu.IM{}
                if rows, err = ds.StoreDataGet(cu.IM{"id": transID, "model": "trans"}, true); err == nil </span><span class="cov0" title="0">{
                        data["trans"] = rows[0]
                        trans.Code = cu.ToString(cu.ToIM(rows[0], cu.IM{})["code"], "")
                        data["editor_title"] = trans.Code
                }</span>
        }

        <span class="cov0" title="0">if err = s.updateItems(ds, data, trans.Code); err != nil </span><span class="cov0" title="0">{
                return transID, err
        }</span>

        <span class="cov0" title="0">if err = s.updatePayments(ds, data, trans.Code); err != nil </span><span class="cov0" title="0">{
                return transID, err
        }</span>

        <span class="cov0" title="0">if err = s.updateLinks(ds, data); err != nil </span><span class="cov0" title="0">{
                return transID, err
        }</span>

        <span class="cov0" title="0">if err = s.updateMovements(ds, data, trans, msgFunc); err != nil </span><span class="cov0" title="0">{
                return transID, err
        }</span>

        <span class="cov0" title="0">err = s.updateDeleteRows(ds, data)

        return transID, err</span>
}

func (s *TransService) delete(ds *api.DataStore, transID int64) (err error) <span class="cov8" title="1">{
        return ds.DataDelete("trans", transID, "")
}</span>

func (s *TransService) formNext(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        view := cu.ToString(stateData["view"], "")
        ds := s.cls.getDataStore(client.Ticket.Database)

        trans := cu.ToIM(stateData["trans"], cu.IM{})
        transMeta := cu.ToIM(trans["trans_meta"], cu.IM{})
        transMap := cu.ToIM(trans["trans_map"], cu.IM{})

        resultUpdate := func(dirty bool) (re ct.ResponseEvent, err error) </span><span class="cov8" title="1">{
                trans["trans_meta"] = transMeta
                trans["trans_map"] = transMap
                stateData["trans"] = trans
                if dirty </span><span class="cov8" title="1">{
                        stateData["dirty"] = dirty
                }</span>
                <span class="cov8" title="1">client.SetEditor("trans", view, stateData)
                return evt, err</span>
        }

        <span class="cov8" title="1">frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})

        nextMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_cancel": func() (re ct.ResponseEvent, err error) </span><span class="cov8" title="1">{
                        client.ResetEditor()
                        return evt, err
                }</span>,

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        if err = s.delete(ds, cu.ToInteger(trans["id"], 0)); err != nil </span><span class="cov8" title="1">{
                                return evt, err
                        }</span>
                        <span class="cov8" title="1">client.ResetEditor()
                        return evt, err</span>
                },

                "transitem_new": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return s.cls.setEditor(evt, "trans", cu.IM{
                                "session_id":   client.Ticket.SessionID,
                                "trans_type":   frmValue["create_trans_type"],
                                "direction":    frmValue["create_direction"],
                                "editor_title": client.Msg("transitem_title"),
                                "editor_icon":  ct.IconFileText,
                        }), nil
                }</span>,

                "transpayment_new": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        transType := cu.ToString(frmValue["create_trans_type"], "")
                        direction := cu.ToString(frmValue["create_direction"], "")
                        if transType == md.TransTypeBank.String() </span><span class="cov8" title="1">{
                                direction = md.DirectionTransfer.String()
                        }</span>
                        <span class="cov8" title="1">return s.cls.setEditor(evt, "trans", cu.IM{
                                "session_id":   client.Ticket.SessionID,
                                "trans_type":   transType,
                                "direction":    direction,
                                "editor_title": client.Msg("transpayment_title"),
                                "editor_icon":  ct.IconMoney,
                        }), nil</span>
                },

                "transmovement_new": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        transType := cu.ToString(frmValue["create_trans_type"], "")
                        direction := cu.ToString(frmValue["create_direction"], md.DirectionTransfer.String())
                        return s.cls.setEditor(evt, "trans", cu.IM{
                                "session_id":   client.Ticket.SessionID,
                                "trans_type":   transType,
                                "direction":    direction,
                                "editor_title": client.Msg(strings.ToLower(transType + "_new")),
                                "editor_icon":  cp.TransTypeIcon(transType),
                        }), nil
                }</span>,

                "trans_create": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return s.createData(evt, frmValue)
                }</span>,

                "trans_copy": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return s.createData(evt, cu.IM{
                                "status": md.TransStatusNormal.String(),
                        })
                }</span>,

                "trans_corrective": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.createData(evt, cu.IM{
                                "status": md.TransStatusAmendment.String(),
                        })
                }</span>,

                "trans_cancellation": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.createData(evt, cu.IM{
                                "status": md.TransStatusCancellation.String(),
                        })
                }</span>,

                "customer": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        params := cu.ToIM(stateData["params"], cu.IM{})
                        return s.cls.setEditor(evt, "customer", params), nil
                }</span>,

                "trans": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        params := cu.ToIM(stateData["params"], cu.IM{})
                        return s.cls.setEditor(evt, "trans", params), nil
                }</span>,

                "shipping": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        //params := cu.ToIM(stateData["params"], cu.IM{})
                        //return s.cls.setEditor(evt, "shipping", params), nil
                        return evt, nil
                }</span>,

                "employee": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        params := cu.ToIM(stateData["params"], cu.IM{})
                        return s.cls.setEditor(evt, "employee", params), nil
                }</span>,

                "project": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        params := cu.ToIM(stateData["params"], cu.IM{})
                        return s.cls.setEditor(evt, "project", params), nil
                }</span>,

                "product": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        params := cu.ToIM(stateData["params"], cu.IM{})
                        return s.cls.setEditor(evt, "product", params), nil
                }</span>,

                "editor_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        tag := cu.ToString(frmValue["value"], "")
                        if tag != "" </span><span class="cov8" title="1">{
                                tags := ut.ToStringArray(transMeta["tags"])
                                if !slices.Contains(tags, tag) </span><span class="cov8" title="1">{
                                        tags = append(tags, tag)
                                        transMeta["tags"] = tags
                                        return resultUpdate(true)
                                }</span>
                        }
                        <span class="cov8" title="1">return evt, nil</span>
                },

                "form_add_tag": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        tag := cu.ToString(frmValue["value"], "")
                        frmKey := cu.ToString(frmData["frm_key"], "")
                        frmIndex := cu.ToInteger(frmData["frm_index"], 0)
                        row := cu.ToIM(frmData["row"], cu.IM{})
                        metaName := ut.MetaName(row, "_meta")
                        rowField := cu.ToString(frmData["row_field"], "")
                        if tag != "" </span><span class="cov8" title="1">{
                                tags := ut.ToStringArray(row[rowField])
                                if metaName != "" </span><span class="cov8" title="1">{
                                        tags = ut.ToStringArray(cu.ToIM(row[metaName], cu.IM{})[rowField])
                                }</span>
                                <span class="cov8" title="1">if !slices.Contains(tags, tag) </span><span class="cov8" title="1">{
                                        tags = append(tags, tag)
                                        if metaName != "" </span><span class="cov8" title="1">{
                                                cu.ToIM(row[metaName], cu.IM{})[rowField] = tags
                                        }</span> else<span class="cov8" title="1"> {
                                                row[rowField] = tags
                                        }</span>
                                        <span class="cov8" title="1">client.SetForm(frmKey, row, frmIndex, false)
                                        return evt, nil</span>
                                }
                        }
                        <span class="cov8" title="1">return evt, nil</span>
                },

                "bookmark_add": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        label := cu.ToString(frmValue["value"], "")
                        bookmark := md.Bookmark{
                                BookmarkType: md.BookmarkTypeEditor,
                                Label:        label,
                                Key:          "trans",
                                Code:         cu.ToString(trans["code"], ""),
                                Filters:      []any{},
                                Columns:      map[string]bool{},
                                TimeStamp:    md.TimeDateTime{Time: time.Now()},
                        }
                        return s.cls.addBookmark(evt, bookmark), nil
                }</span>,

                "editor_map_value": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        code := cu.ToString(frmValue["value"], "")
                        model := cu.ToString(frmData["model"], "")
                        mapField := cu.ToString(frmData["map_field"], "")
                        if _, err := ds.GetDataByID(model, 0, code, true); err != nil </span><span class="cov8" title="1">{
                                frmData["label"] = fmt.Sprintf("%s: %s (%s)", client.Msg("invalid_code"), code, model)
                                frmData["default_value"] = code
                                frmData["invalid"] = true
                                client.SetForm("input_string", frmData, 0, true)
                                return evt, nil
                        }</span>
                        <span class="cov8" title="1">transMap[mapField] = code
                        stateData["map_field"] = ""
                        return resultUpdate(true)</span>
                },
        }

        <span class="cov8" title="1">if fn, ok := nextMap[cu.ToString(frmData["next"], "")]; ok </span><span class="cov8" title="1">{
                return fn()
        }</span>
        <span class="cov8" title="1">return evt, err</span>
}

func (s *TransService) getProductPrice(ds *api.DataStore, options cu.IM) (price float64, discount float64) <span class="cov0" title="0">{
        if results, err := ds.ProductPrice(options); err == nil </span><span class="cov0" title="0">{
                price = cu.ToFloat(results["price"], 0)
                discount = cu.ToFloat(results["discount"], 0)
        }</span>
        <span class="cov0" title="0">return price, discount</span>
}

func (s *TransService) roundFloat(val float64, precision uint) float64 <span class="cov0" title="0">{
        ratio := math.Pow(10, float64(precision))
        return math.Round(val*ratio) / ratio
}</span>

func (s *TransService) taxRate(taxCodes []cu.IM, taxCode string) (rate float64) <span class="cov0" title="0">{
        if idx := slices.IndexFunc(taxCodes, func(c cu.IM) bool </span><span class="cov0" title="0">{
                return cu.ToString(c["code"], "") == taxCode
        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                return cu.ToFloat(taxCodes[idx]["rate_value"], 0)
        }</span>
        <span class="cov0" title="0">return rate</span>
}

func (s *TransService) currencyDigit(currencies []cu.IM, currencyCode string) (digit int64) <span class="cov8" title="1">{
        if idx := slices.IndexFunc(currencies, func(c cu.IM) bool </span><span class="cov0" title="0">{
                return cu.ToString(c["code"], "") == currencyCode
        }</span>); idx &gt; int(-1) <span class="cov0" title="0">{
                return cu.ToInteger(currencies[idx]["digit"], 0)
        }</span>
        <span class="cov8" title="1">return digit</span>
}

func (s *TransService) calcItemPrice(calcMode string, value float64, stateData, formRow cu.IM) cu.IM <span class="cov0" title="0">{
        trans := cu.ToIM(stateData["trans"], cu.IM{})
        taxCodes := cu.ToIMA(stateData["tax_codes"], []cu.IM{})
        rate := s.taxRate(taxCodes, cu.ToString(formRow["tax_code"], ""))
        currencies := cu.ToIMA(stateData["currencies"], []cu.IM{})
        digit := uint(s.currencyDigit(currencies, cu.ToString(trans["currency_code"], "")))
        itemRow := cu.ToIM(formRow["item_meta"], cu.IM{})

        var netAmount, vatAmount, amount, fxPrice float64
        switch calcMode </span>{
        case "net_amount":<span class="cov0" title="0">
                netAmount = value
                if cu.ToFloat(itemRow["qty"], 0) != 0 </span><span class="cov0" title="0">{
                        fxPrice = s.roundFloat(netAmount/(1-cu.ToFloat(itemRow["discount"], 0)/100)/cu.ToFloat(itemRow["qty"], 0), digit)
                        vatAmount = s.roundFloat(netAmount*rate, digit)
                }</span>
                <span class="cov0" title="0">amount = s.roundFloat(netAmount+vatAmount, digit)</span>

        case "amount":<span class="cov0" title="0">
                amount = value
                if cu.ToFloat(itemRow["qty"], 0) != 0 </span><span class="cov0" title="0">{
                        netAmount = s.roundFloat(amount/(1+rate), digit)
                        vatAmount = s.roundFloat(amount-netAmount, digit)
                        fxPrice = s.roundFloat(netAmount/(1-cu.ToFloat(itemRow["discount"], 0)/100)/cu.ToFloat(itemRow["qty"], 0), digit)
                }</span>

        case "fx_price":<span class="cov0" title="0">
                fxPrice = value
                netAmount = s.roundFloat(fxPrice*(1-cu.ToFloat(itemRow["discount"], 0)/100)*cu.ToFloat(itemRow["qty"], 0), digit)
                vatAmount = s.roundFloat(fxPrice*(1-cu.ToFloat(itemRow["discount"], 0)/100)*cu.ToFloat(itemRow["qty"], 0)*rate, digit)
                amount = s.roundFloat(netAmount+vatAmount, digit)</span>
        }

        <span class="cov0" title="0">return cu.IM{
                "net_amount": netAmount, "vat_amount": vatAmount, "amount": amount, "fx_price": fxPrice,
        }</span>
}

func (s *TransService) formEventChangeSelector(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        trans := cu.ToIM(stateData["trans"], cu.IM{})

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})

        fieldName := cu.ToString(frmValues["name"], "")
        itemMeta := cu.ToIM(frmBaseValues["item_meta"], cu.IM{})

        setPriceValues := func(calcMode string, value float64) </span><span class="cov0" title="0">{
                priceValues := s.calcItemPrice(calcMode, value, stateData, frmBaseValues)
                itemMeta["net_amount"] = priceValues["net_amount"]
                itemMeta["vat_amount"] = priceValues["vat_amount"]
                itemMeta["amount"] = priceValues["amount"]
                itemMeta["fx_price"] = priceValues["fx_price"]
                frmBaseValues["item_meta"] = itemMeta
        }</span>
        <span class="cov0" title="0">switch fieldName </span>{
        case "product_code":<span class="cov0" title="0">
                return s.cls.editorCodeSelector(evt, "trans", strings.Split(fieldName, "_")[0], frmBaseValues,
                        func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                                if cu.ToString(params["event"], "") == ct.SelectorEventSelected </span><span class="cov0" title="0">{
                                        selectedValues := cu.ToIM(params["values"], cu.IM{})
                                        frmBaseValues["product_name"] = selectedValues["product_name"]
                                        frmBaseValues["product_unit"] = selectedValues["unit"]
                                        if _, found := frmBaseValues["item_meta"]; found </span><span class="cov0" title="0">{
                                                itemMeta["unit"] = selectedValues["unit"]
                                                itemMeta["description"] = selectedValues["product_name"]
                                                itemMeta["fx_price"], itemMeta["discount"] = s.getProductPrice(ds,
                                                        cu.IM{"currency_code": trans["currency_code"],
                                                                "product_code":  frmBaseValues["product_code"],
                                                                "customer_code": trans["customer_code"],
                                                                "qty":           itemMeta["qty"]})
                                                frmBaseValues["tax_code"] = cu.ToIM(params["values"], cu.IM{})["tax_code"]
                                                frmBaseValues["item_meta"] = itemMeta
                                                setPriceValues("fx_price", cu.ToFloat(itemMeta["fx_price"], 0))
                                        }</span>
                                }
                                <span class="cov0" title="0">client.SetForm(cu.ToString(form["key"], ""),
                                        cu.MergeIM(frmBaseValues,
                                                cu.IM{"product_selector": stateData["product_selector"]}),
                                        cu.ToInteger(form["index"], 0), false)
                                return evt, nil</span>
                        })

        case "tool_code":<span class="cov0" title="0">
                return s.cls.editorCodeSelector(evt, "trans", strings.Split(fieldName, "_")[0], frmBaseValues,
                        func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                                if cu.ToString(params["event"], "") == ct.SelectorEventSelected </span><span class="cov0" title="0">{
                                        selectedValues := cu.ToIM(params["values"], cu.IM{})
                                        frmBaseValues["tool_description"] = selectedValues["description"]
                                        frmBaseValues["serial_number"] = selectedValues["serial_number"]
                                }</span>
                                <span class="cov0" title="0">client.SetForm(cu.ToString(form["key"], ""),
                                        cu.MergeIM(frmBaseValues,
                                                cu.IM{"tool_selector": stateData["tool_selector"]}),
                                        cu.ToInteger(form["index"], 0), false)
                                return evt, nil</span>
                        })

        case "invoice_code":<span class="cov0" title="0">
                return s.cls.editorCodeSelector(evt, "trans", strings.Split(fieldName, "_")[0], frmBaseValues,
                        func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                                if cu.ToString(params["event"], "") == ct.SelectorEventSelected </span><span class="cov0" title="0">{
                                        selectedValues := cu.ToIM(params["values"], cu.IM{})
                                        frmBaseValues["link_code_2"] = selectedValues["code"]
                                        frmBaseValues["currency_code"] = strings.Split(cu.ToString(selectedValues["currency_code"], ""), "/")[0] + "/" + cu.ToString(selectedValues["currency_code"], "")
                                        frmBaseValues["invoice_curr"] = selectedValues["currency_code"]
                                }</span>
                                <span class="cov0" title="0">client.SetForm(cu.ToString(form["key"], ""),
                                        cu.MergeIM(frmBaseValues,
                                                cu.IM{"invoice_selector": stateData["invoice_selector"]}),
                                        cu.ToInteger(form["index"], 0), false)
                                return evt, nil</span>
                        })
        }
        <span class="cov0" title="0">return evt, nil</span>
}

func (s *TransService) formEventChange(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmBaseValues := cu.ToIM(form["data"], cu.IM{})

        fieldName := cu.ToString(frmValues["name"], "")
        itemMeta := cu.ToIM(frmBaseValues["item_meta"], cu.IM{})
        linkMeta := cu.ToIM(frmBaseValues["link_meta"], cu.IM{})
        movementMeta := cu.ToIM(frmBaseValues["movement_meta"], cu.IM{})

        setPriceValues := func(calcMode string, value float64) </span><span class="cov0" title="0">{
                priceValues := s.calcItemPrice(calcMode, value, stateData, frmBaseValues)
                itemMeta["net_amount"] = priceValues["net_amount"]
                itemMeta["vat_amount"] = priceValues["vat_amount"]
                itemMeta["amount"] = priceValues["amount"]
                itemMeta["fx_price"] = priceValues["fx_price"]
                frmBaseValues["item_meta"] = itemMeta
        }</span>
        <span class="cov8" title="1">switch fieldName </span>{
        case "tags":<span class="cov8" title="1">
                return s.cls.editorFormTags(cu.IM{"row_field": fieldName}, evt)</span>
        case "product_code":<span class="cov0" title="0">
                return s.formEventChangeSelector(evt)</span>

        case "tool_code":<span class="cov0" title="0">
                return s.formEventChangeSelector(evt)</span>

        case "invoice_code":<span class="cov0" title="0">
                return s.formEventChangeSelector(evt)</span>

        case "qty", "discount", "tax_code":<span class="cov0" title="0">
                if fieldName != "tax_code" </span><span class="cov0" title="0">{
                        itemMeta[fieldName] = cu.ToFloat(frmValues["value"], 0)
                        frmBaseValues["item_meta"] = itemMeta
                }</span> else<span class="cov0" title="0"> {
                        frmBaseValues[fieldName] = frmValues["value"]
                }</span>
                <span class="cov0" title="0">setPriceValues("fx_price", cu.ToFloat(itemMeta["fx_price"], 0))
                return s.cls.editorCodeSelector(evt, "trans", strings.Split(fieldName, "_")[0], frmBaseValues,
                        func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                                client.SetForm(cu.ToString(form["key"], ""), frmBaseValues, cu.ToInteger(form["index"], 0), false)
                                return evt, nil
                        }</span>)

        case "amount", "net_amount", "fx_price":<span class="cov0" title="0">
                setPriceValues(fieldName, cu.ToFloat(frmValues["value"], 0))
                return s.cls.editorCodeSelector(evt, "trans", strings.Split(fieldName, "_")[0], frmBaseValues,
                        func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                                client.SetForm(cu.ToString(form["key"], ""), frmBaseValues, cu.ToInteger(form["index"], 0), false)
                                return evt, nil
                        }</span>)

        case "place_code":<span class="cov0" title="0">
                frmBaseValues[fieldName] = frmValues["value"]
                client.SetForm(cu.ToString(form["key"], ""), frmBaseValues, cu.ToInteger(form["index"], 0), false)</span>

        case "own_stock":<span class="cov0" title="0">
                itemMeta[fieldName] = cu.ToFloat(frmValues["value"], 0)
                frmBaseValues["item_meta"] = itemMeta
                cu.ToSM(evt.Header, cu.SM{})[ct.HeaderReswap] = ct.SwapNone</span>

        case "deposit":<span class="cov0" title="0">
                itemMeta[fieldName] = cu.ToBoolean(frmValues["value"], false)
                frmBaseValues["item_meta"] = itemMeta
                cu.ToSM(evt.Header, cu.SM{})[ct.HeaderReswap] = ct.SwapNone</span>

        case "shared":<span class="cov0" title="0">
                movementMeta[fieldName] = cu.ToBoolean(frmValues["value"], false)
                frmBaseValues["movement_meta"] = movementMeta
                client.SetForm(cu.ToString(form["key"], ""), frmBaseValues, cu.ToInteger(form["index"], 0), false)</span>

        case "link_amount", "link_rate":<span class="cov0" title="0">
                linkMeta[strings.Split(fieldName, "_")[1]] = cu.ToFloat(frmValues["value"], 0)
                frmBaseValues["link_meta"] = linkMeta
                client.SetForm(cu.ToString(form["key"], ""), frmBaseValues, cu.ToInteger(form["index"], 0), false)</span>

        default:<span class="cov8" title="1">
                frmBaseValues[fieldName] = frmValues["value"]
                cu.ToSM(evt.Header, cu.SM{})[ct.HeaderReswap] = ct.SwapNone</span>
        }
        <span class="cov8" title="1">return evt, nil</span>
}

func (s *TransService) formEvent(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        trans := cu.ToIM(stateData["trans"], cu.IM{})

        frmValues := cu.ToIM(evt.Value, cu.IM{})
        frmValue := cu.ToIM(frmValues["value"], cu.IM{})
        frmData := cu.ToIM(frmValues["data"], cu.IM{})
        form := cu.ToIM(frmData["form"], cu.IM{})
        frmIndex := cu.ToInteger(form["index"], 0)
        frmKey := cu.ToString(form["key"], "")
        frmEvent := cu.ToString(frmValues["event"], "")
        rows := cu.ToIMA(trans[frmKey], []cu.IM{})
        if srows, found := stateData[frmKey]; found &amp;&amp; (len(rows) == 0) </span><span class="cov8" title="1">{
                rows = cu.ToIMA(srows, []cu.IM{})
        }</span>
        <span class="cov8" title="1">delete := (cu.ToString(frmValue["form_delete"], "") != "")

        resultUpdate := func() (re ct.ResponseEvent, err error) </span><span class="cov8" title="1">{
                if _, found := trans[frmKey]; found </span><span class="cov8" title="1">{
                        trans[frmKey] = rows
                }</span> else<span class="cov8" title="1"> {
                        stateData[frmKey] = rows
                }</span>
                <span class="cov8" title="1">stateData["dirty"] = true
                return evt, err</span>
        }

        <span class="cov8" title="1">eventMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.FormEventOK: func() (re ct.ResponseEvent, err error) </span><span class="cov8" title="1">{
                        rowMeta := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_meta")], cu.IM{})
                        //rowMap := cu.ToIM(rows[frmIndex][ut.MetaName(rows[frmIndex], "_map")], cu.IM{})
                        customValues := map[string]func(value any){
                                "frm_amount": func(value any) </span><span class="cov0" title="0">{
                                        rowMeta["amount"] = cu.ToFloat(value, 0)
                                }</span>,
                                "frm_net_amount": func(value any) <span class="cov0" title="0">{
                                        rowMeta["net_amount"] = cu.ToFloat(value, 0)
                                }</span>,
                                "frm_vat_amount": func(value any) <span class="cov0" title="0">{
                                        rowMeta["vat_amount"] = cu.ToFloat(value, 0)
                                }</span>,
                                "frm_fx_price": func(value any) <span class="cov0" title="0">{
                                        rowMeta["fx_price"] = cu.ToFloat(value, 0)
                                }</span>,
                                "frm_qty": func(value any) <span class="cov0" title="0">{
                                        rowMeta["qty"] = cu.ToFloat(value, 0)
                                }</span>,
                                "frm_discount": func(value any) <span class="cov0" title="0">{
                                        rowMeta["discount"] = cu.ToFloat(value, 0)
                                }</span>,
                                "frm_own_stock": func(value any) <span class="cov0" title="0">{
                                        rowMeta["own_stock"] = cu.ToFloat(value, 0)
                                }</span>,
                                "frm_description": func(value any) <span class="cov0" title="0">{
                                        rowMeta["description"] = value
                                }</span>,
                                "frm_unit": func(value any) <span class="cov0" title="0">{
                                        rowMeta["unit"] = value
                                }</span>,
                                "frm_notes": func(value any) <span class="cov0" title="0">{
                                        rowMeta["notes"] = value
                                }</span>,
                                "frm_link_amount": func(value any) <span class="cov0" title="0">{
                                        rowMeta["amount"] = cu.ToFloat(value, 0)
                                }</span>,
                                "frm_link_rate": func(value any) <span class="cov0" title="0">{
                                        rowMeta["rate"] = cu.ToFloat(value, 0)
                                }</span>,
                                "frm_shared": func(value any) <span class="cov0" title="0">{
                                        rowMeta["shared"] = cu.ToBoolean(value, false)
                                }</span>,

                                "base_item_meta": func(value any) <span class="cov0" title="0">{
                                        rowMeta["tags"] = cu.ToIM(value, cu.IM{})["tags"]
                                        rowMeta["deposit"] = cu.ToBoolean(cu.ToIM(value, cu.IM{})["deposit"], false)
                                }</span>,
                                "base_product_code": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["product_code"] = value
                                }</span>,
                                "base_product_name": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["product_name"] = value
                                }</span>,
                                "base_product_unit": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["product_unit"] = value
                                }</span>,
                                "base_tool_code": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["tool_code"] = value
                                }</span>,
                                "base_tool_description": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["tool_description"] = value
                                }</span>,
                                "base_serial_number": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["serial_number"] = value
                                }</span>,
                                "base_tax_code": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["tax_code"] = value
                                }</span>,
                                "base_place_code": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["place_code"] = value
                                }</span>,
                                "base_tags": func(value any) <span class="cov8" title="1">{
                                        rows[frmIndex]["tags"] = value
                                }</span>,
                                "base_link_code_2": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["link_code_2"] = value
                                }</span>,
                                "base_invoice_curr": func(value any) <span class="cov0" title="0">{
                                        rows[frmIndex]["invoice_curr"] = value
                                }</span>,
                        }
                        <span class="cov8" title="1">return s.cls.editorFormOK(evt, rows, customValues)</span>
                },

                ct.FormEventCancel: func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        if delete </span><span class="cov8" title="1">{
                                row := rows[frmIndex]
                                rowId := cu.ToInteger(row["id"], 0)
                                refCode := cu.ToString(row["movement_code"], "")
                                if _, found := stateData[frmKey]; found &amp;&amp; rowId &gt; 0 </span><span class="cov8" title="1">{
                                        deleteRows := cu.ToIMA(stateData[frmKey+"_delete"], []cu.IM{})
                                        deleteRows = append(deleteRows, rows[frmIndex])
                                        if refCode != "" </span><span class="cov0" title="0">{
                                                if idx := slices.IndexFunc(rows, func(refRow cu.IM) bool </span><span class="cov0" title="0">{
                                                        return cu.ToString(refRow["code"], "") == refCode
                                                }</span>); idx &gt; -1 <span class="cov0" title="0">{
                                                        deleteRows = append(deleteRows, rows[idx])
                                                }</span>
                                        }
                                        <span class="cov8" title="1">stateData[frmKey+"_delete"] = deleteRows</span>
                                }
                                <span class="cov8" title="1">rows = append(rows[:frmIndex], rows[frmIndex+1:]...)
                                return resultUpdate()</span>
                        }
                        <span class="cov8" title="1">return evt, err</span>
                },

                ct.FormEventChange: func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return s.formEventChange(evt)
                }</span>,
        }

        <span class="cov8" title="1">if len(rows) &gt; 0 &amp;&amp; frmIndex &lt; int64(len(rows)) </span><span class="cov8" title="1">{
                if fn, ok := eventMap[frmEvent]; ok </span><span class="cov8" title="1">{
                        return fn()
                }</span>
        }

        <span class="cov8" title="1">return evt, err</span>
}

func (s *TransService) sideMenu(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        view := cu.ToString(stateData["view"], "")
        trans := cu.ToIM(stateData["trans"], cu.IM{})
        transMeta := cu.ToIM(trans["trans_meta"], cu.IM{})
        user := cu.ToIM(stateData["user"], cu.IM{})
        ds := s.cls.getDataStore(client.Ticket.Database)

        menuMap := map[string]func() (re ct.ResponseEvent, err error){
                "editor_save": func() (re ct.ResponseEvent, err error) </span><span class="cov8" title="1">{
                        var transID int64
                        if transID, err = s.update(ds, stateData, client.Msg); err != nil </span><span class="cov8" title="1">{
                                return evt, err
                        }</span>
                        //stateData["dirty"] = false
                        //client.SetEditor("trans", view, stateData)
                        //return evt, err
                        <span class="cov0" title="0">return s.cls.setEditor(evt, "trans", cu.IM{
                                "editor_view": view,
                                "trans_id":    transID,
                                "session_id":  client.Ticket.SessionID,
                        }), nil</span>
                },

                "editor_delete": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("inputbox_delete"),
                                "warning_message": "",
                                "next":            "editor_delete",
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, err
                }</span>,

                "editor_cancel": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        dirty := cu.ToBoolean(stateData["dirty"], false)
                        readonly := (cu.ToString(user["user_group"], "") == md.UserGroupGuest.String()) ||
                                cu.ToBoolean(trans["deleted"], false) ||
                                (cu.ToBoolean(transMeta["closed"], false) &amp;&amp; !dirty)
                        if dirty &amp;&amp; !readonly </span><span class="cov8" title="1">{
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_dirty"),
                                        "warning_message": client.Msg("inputbox_drop"),
                                        "next":            "editor_cancel",
                                }
                                client.SetForm("warning", modal, 0, true)
                        }</span> else<span class="cov8" title="1"> {
                                client.ResetEditor()
                        }</span>
                        <span class="cov8" title="1">return evt, err</span>
                },

                "transitem_new": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        params := cu.IM{
                                "session_id":   client.Ticket.SessionID,
                                "trans_type":   trans["trans_type"],
                                "direction":    trans["direction"],
                                "editor_title": client.Msg(strings.ToLower(cu.ToString(trans["trans_type"], "") + "_new")),
                                "editor_icon":  ct.IconFileText,
                        }
                        return s.cls.setEditor(evt, "trans", params), nil
                }</span>,

                "transpayment_new": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        params := cu.IM{
                                "session_id":   client.Ticket.SessionID,
                                "trans_type":   trans["trans_type"],
                                "direction":    trans["direction"],
                                "editor_title": client.Msg(strings.ToLower(cu.ToString(trans["trans_type"], "") + "_new")),
                                "editor_icon":  ct.IconMoney,
                        }
                        return s.cls.setEditor(evt, "trans", params), nil
                }</span>,

                "transmovement_new": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        params := cu.IM{
                                "session_id":   client.Ticket.SessionID,
                                "trans_type":   trans["trans_type"],
                                "direction":    trans["direction"],
                                "editor_title": client.Msg(strings.ToLower(cu.ToString(trans["trans_type"], "") + "_new")),
                                "editor_icon":  cp.TransTypeIcon(cu.ToString(trans["trans_type"], "")),
                        }
                        return s.cls.setEditor(evt, "trans", params), nil
                }</span>,

                "trans_copy": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("trans_copy_text"),
                                "warning_message": client.Msg("inputbox_delete_info"),
                                "next":            "trans_copy",
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, err
                }</span>,

                "trans_corrective": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("trans_copy_text"),
                                "warning_message": client.Msg("inputbox_delete_info"),
                                "next":            "trans_corrective",
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, err
                }</span>,

                "trans_cancellation": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("trans_copy_text"),
                                "warning_message": client.Msg("inputbox_delete_info"),
                                "next":            "trans_cancellation",
                        }
                        client.SetForm("warning", modal, 0, true)
                        return evt, err
                }</span>,

                "trans_create": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        elementCount := cu.ToIMA(stateData["element_count"], []cu.IM{})
                        return s.createModal(evt,
                                cu.IM{"state_key": trans["trans_type"], "create_direction": trans["direction"],
                                        "show_delivery": len(elementCount) &gt; 0, "next": "trans_create"}), nil
                }</span>,

                "payment_link_add": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        payments := cu.ToIMA(stateData["payments"], []cu.IM{})
                        cashPayment := cu.ToIM(payments[0], cu.IM{})
                        cashPaymentMeta := cu.ToIM(cashPayment["payment_meta"], cu.IM{})
                        return s.linkAdd(evt,
                                cu.IM{"view": "payment_link", "code1": cu.ToString(cashPayment["code"], ""), "code2": "",
                                        "amount": math.Abs(cu.ToFloat(cashPaymentMeta["amount"], 0))})
                }</span>,

                "editor_report": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return s.cls.showReportSelector(evt, "TRANS", cu.ToString(trans["code"], ""))
                }</span>,

                "editor_bookmark": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        modal := cu.IM{
                                "title":         client.Msg("bookmark_new"),
                                "icon":          ct.IconStar,
                                "label":         client.Msg("bookmark_enter"),
                                "placeholder":   "",
                                "field_name":    "value",
                                "default_value": "",
                                "required":      false,
                                "next":          "bookmark_add",
                        }
                        client.SetForm("input_string", modal, 0, true)
                        return evt, nil
                }</span>,
        }

        <span class="cov8" title="1">if fn, ok := menuMap[cu.ToString(evt.Value, "")]; ok </span><span class="cov8" title="1">{
                return fn()
        }</span>

        <span class="cov8" title="1">return evt, err</span>
}

func (s *TransService) editorFieldExternal(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        view := cu.ToString(stateData["view"], "")
        trans := cu.ToIM(stateData["trans"], cu.IM{})
        transType := cu.ToString(trans["trans_type"], "")
        direction := cu.ToString(trans["direction"], "")

        var mName string
        var rows []cu.IM = []cu.IM{}
        var row cu.IM = cu.IM{}
        var rowIndex int = 0
        switch transType </span>{
        case md.TransTypeCash.String():<span class="cov0" title="0">
                mName = "payments"
                rows = cu.ToIMA(stateData["payments"], []cu.IM{})
                if len(rows) == 0 </span><span class="cov0" title="0">{
                        rows = append(rows, transRowTypeMap["payments"](stateData))
                }</span>
                <span class="cov0" title="0">row = rows[0]</span>

        case md.TransTypeFormula.String():<span class="cov0" title="0">
                mName = "movements"
                rows = cu.ToIMA(stateData["movements"], []cu.IM{})
                if idx := slices.IndexFunc(rows, func(movement cu.IM) bool </span><span class="cov0" title="0">{
                        return cu.ToString(movement["movement_type"], "") == md.MovementTypeHead.String()
                }</span>); idx &gt; -1 <span class="cov0" title="0">{
                        row = rows[idx]
                        rowIndex = idx
                }</span> else<span class="cov0" title="0"> {
                        rows = append(rows, transRowTypeMap["movements"](stateData))
                        rowIndex = len(rows) - 1
                        row = rows[rowIndex]
                }</span>

        case md.TransTypeProduction.String():<span class="cov0" title="0">
                mName = "movements"
                rows = cu.ToIMA(stateData["movements"], []cu.IM{})
                if idx := slices.IndexFunc(rows, func(movement cu.IM) bool </span><span class="cov0" title="0">{
                        movementMeta := cu.ToIM(movement["movement_meta"], cu.IM{})
                        return cu.ToBoolean(movementMeta["shared"], false)
                }</span>); idx &gt; -1 <span class="cov0" title="0">{
                        row = rows[idx]
                        rowIndex = idx
                }</span> else<span class="cov0" title="0"> {
                        rows = append(rows, transRowTypeMap["movements"](stateData))
                        rowIndex = len(rows) - 1
                        row = rows[rowIndex]
                        row["movement_type"] = md.MovementTypeInventory.String()
                        cu.ToIM(row["movement_meta"], cu.IM{})["shared"] = true
                }</span>

        default:<span class="cov0" title="0">
                return evt, err</span>
        }

        <span class="cov0" title="0">values := cu.ToIM(evt.Value, cu.IM{})
        fieldName := cu.ToString(values["name"], "")
        value := cu.ToString(values["value"], "")

        switch fieldName </span>{
        case "payment_paid_date":<span class="cov0" title="0">
                row["paid_date"] = value</span>
        case "payment_amount":<span class="cov0" title="0">
                rowMeta := cu.ToIM(row["payment_meta"], cu.IM{})
                rowMeta["amount"] = cu.ToFloat(value, 0)
                if direction == md.DirectionOut.String() </span><span class="cov0" title="0">{
                        rowMeta["amount"] = -cu.ToFloat(rowMeta["amount"], 0)
                }</span>
                <span class="cov0" title="0">row["payment_meta"] = rowMeta</span>

        case "movement_product_code":<span class="cov0" title="0">
                valueData := cu.ToIM(values["value"], cu.IM{})
                selectedRow := cu.ToIM(valueData["row"], cu.IM{})
                row["product_code"] = selectedRow["code"]</span>
        case "movement_notes":<span class="cov0" title="0">
                rowMeta := cu.ToIM(row["movement_meta"], cu.IM{})
                rowMeta["notes"] = value
                row["movement_meta"] = rowMeta</span>
        case "movement_qty":<span class="cov0" title="0">
                rowMeta := cu.ToIM(row["movement_meta"], cu.IM{})
                rowMeta["qty"] = cu.ToFloat(value, 0)
                row["movement_meta"] = rowMeta</span>
        }
        <span class="cov0" title="0">rows[rowIndex] = row
        stateData[mName] = rows
        stateData["dirty"] = true
        client.SetEditor("trans", view, stateData)
        return evt, err</span>
}

func (s *TransService) linkAdd(evt ct.ResponseEvent, params cu.IM) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        trans := cu.ToIM(stateData["trans"], cu.IM{})
        currencyCode := cu.ToString(trans["currency_code"], "")
        places := cu.ToIMA(stateData["places"], []cu.IM{})
        if idx := slices.IndexFunc(places, func(place cu.IM) bool </span><span class="cov0" title="0">{
                return cu.ToString(place["code"], "") == cu.ToString(trans["place_code"], "")
        }</span>); idx != -1 <span class="cov0" title="0">{
                currencyCode = cu.ToString(places[idx]["currency_code"], "")
        }</span>

        <span class="cov0" title="0">view := cu.ToString(params["view"], "")
        code1 := cu.ToString(params["code1"], "")
        code2 := cu.ToString(params["code2"], "")

        rows := cu.ToIMA(stateData[view], []cu.IM{})
        index := len(rows)
        row := transRowTypeMap["link"](cu.IM{})
        row["id"] = -(index + 1)
        if code1 != "" </span><span class="cov0" title="0">{
                row["link_code_1"] = code1
        }</span>
        <span class="cov0" title="0">if code2 != "" </span><span class="cov0" title="0">{
                row["link_code_2"] = code2
        }</span>
        <span class="cov0" title="0">cu.ToIM(row["link_meta"], cu.IM{})["amount"] = cu.ToFloat(params["amount"], 0)
        rows = append(rows, row)
        stateData[view] = rows
        stateData["view"] = view
        stateData["dirty"] = true
        client.SetForm(view, cu.MergeIM(row, cu.IM{
                "trans_code": code2, "currency_code": currencyCode,
                "amount": cu.ToFloat(params["amount"], 0), "rate": 1,
        }), int64(index), false)
        return evt, err</span>
}

func (s *TransService) editorFieldViewAdd(evt ct.ResponseEvent, transMap cu.IM,
        resultUpdate func(params cu.IM) (re ct.ResponseEvent, err error)) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        view := cu.ToString(stateData["view"], "")
        trans := cu.ToIM(stateData["trans"], cu.IM{})
        transType := cu.ToString(trans["trans_type"], "")

        movements := cu.ToIMA(stateData["movements"], []cu.IM{})

        getBase := func() (base cu.IM) </span><span class="cov0" title="0">{
                if _, found := trans[view]; found </span><span class="cov0" title="0">{
                        return trans
                }</span>
                <span class="cov0" title="0">return stateData</span>
        }
        <span class="cov8" title="1">appendRow := func() (row cu.IM, index int64) </span><span class="cov0" title="0">{
                base := getBase()
                rows := cu.ToIMA(base[view], []cu.IM{})
                row = transRowTypeMap[view](stateData)
                row["id"] = -(len(rows) + 1)
                rows = append(rows, row)
                base[view] = rows
                return row, int64(len(rows) - 1)
        }</span>

        <span class="cov8" title="1">switch view </span>{
        case "items", "payments":<span class="cov0" title="0">
                row, index := appendRow()
                client.SetForm(view,
                        cu.MergeIM(row, cu.IM{"tax_codes": stateData["tax_codes"]}),
                        index, false)</span>

        case "movements":<span class="cov0" title="0">
                row, index := appendRow()
                switch transType </span>{
                case md.TransTypeDelivery.String():<span class="cov0" title="0">
                        // transfer movement
                        row["movement_type"] = md.MovementTypeInventory.String()
                        row["shipping_time"] = cu.ToString(trans["trans_date"], time.Now().Format("2006-01-02"))[:10] + "T00:00:00"
                        if len(movements) &gt; 1 </span><span class="cov0" title="0">{
                                row["place_code"] = cu.ToString(movements[1]["place_code"], "")
                        }</span>

                case md.TransTypeWaybill.String():<span class="cov0" title="0">
                        row["movement_type"] = md.MovementTypeTool.String()
                        row["shipping_time"] = cu.ToString(trans["trans_date"], time.Now().Format("2006-01-02"))[:10] + "T00:00:00"</span>

                case md.TransTypeFormula.String():<span class="cov0" title="0">
                        row["movement_type"] = md.MovementTypePlan.String()</span>

                default:<span class="cov0" title="0">
                        row["movement_type"] = md.MovementTypeInventory.String()
                        row["shipping_time"] = cu.ToString(trans["trans_date"], time.Now().Format("2006-01-02"))[:10] + "T00:00:00"
                        row["place_code"] = cu.ToString(trans["place_code"], "")</span>

                }
                <span class="cov0" title="0">client.SetForm(view,
                        cu.MergeIM(row, cu.IM{"places": stateData["places"], "trans_type": transType, "index": index}),
                        index, false)</span>

        case "tool_movement":<span class="cov0" title="0">
                stateData["params"] = cu.IM{
                        "ref_trans_code": cu.ToString(trans["code"], ""),
                        "trans_type":     md.TransTypeWaybill.String(),
                        "direction":      md.DirectionOut.String(),
                        "editor_title":   client.Msg("trans_waybill_new"),
                        "editor_icon":    ct.IconBriefcase,
                        "session_id":     client.Ticket.SessionID,
                }
                if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("inputbox_dirty"),
                                "warning_message": client.Msg("inputbox_drop"),
                                "next":            "trans",
                        }
                        client.SetForm("warning", modal, 0, true)
                }</span> else<span class="cov0" title="0"> {
                        return s.cls.setEditor(evt, "trans", stateData["params"].(cu.IM)), nil
                }</span>

        case "transitem_shipping":<span class="cov0" title="0">
                stateData["params"] = cu.IM{
                        "trans_code": cu.ToString(trans["code"], ""),
                        "session_id": client.Ticket.SessionID}
                if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                        modal := cu.IM{
                                "warning_label":   client.Msg("inputbox_dirty"),
                                "warning_message": client.Msg("inputbox_drop"),
                                "next":            "shipping",
                        }
                        client.SetForm("warning", modal, 0, true)
                }</span> else<span class="cov0" title="0"> {
                        //return s.cls.setEditor(evt, "shipping", stateData["params"].(cu.IM)), nil
                        return evt, nil
                }</span>

        case "maps":<span class="cov8" title="1">
                return s.cls.addMapField(evt, transMap, resultUpdate)</span>
        }
        <span class="cov8" title="1">return evt, err</span>
}

func (s *TransService) editorField(evt ct.ResponseEvent) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)
        view := cu.ToString(stateData["view"], "")

        trans := cu.ToIM(stateData["trans"], cu.IM{})
        transMeta := cu.ToIM(trans["trans_meta"], cu.IM{})
        transMetaWorksheet := cu.ToIM(transMeta["worksheet"], cu.IM{})
        transMetaRent := cu.ToIM(transMeta["rent"], cu.IM{})
        transMap := cu.ToIM(trans["trans_map"], cu.IM{})

        resultUpdate := func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov8" title="1">{
                trans["trans_meta"] = transMeta
                trans["trans_map"] = transMap
                stateData["trans"] = trans
                if cu.ToBoolean(params["dirty"], false) </span><span class="cov8" title="1">{
                        stateData["dirty"] = true
                }</span>
                <span class="cov8" title="1">client.SetEditor("trans", view, stateData)
                return evt, err</span>
        }

        <span class="cov8" title="1">values := cu.ToIM(evt.Value, cu.IM{})
        fieldName := cu.ToString(values["name"], "")
        value := cu.ToString(values["value"], "")
        valueData := cu.ToIM(values["value"], cu.IM{})
        row := cu.ToIM(valueData["row"], cu.IM{})

        fieldMap := map[string]func() (re ct.ResponseEvent, err error){
                ct.TableEventRowSelected: func() (re ct.ResponseEvent, err error) </span><span class="cov8" title="1">{
                        switch view </span>{
                        case "transitem_invoice":<span class="cov0" title="0">
                                stateData["params"] = cu.IM{
                                        "trans_code": cu.ToString(row["trans_code"], ""),
                                        "session_id": client.Ticket.SessionID}
                                if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                                        modal := cu.IM{
                                                "warning_label":   client.Msg("inputbox_dirty"),
                                                "warning_message": client.Msg("inputbox_drop"),
                                                "next":            "trans",
                                        }
                                        client.SetForm("warning", modal, 0, true)
                                }</span> else<span class="cov0" title="0"> {
                                        return s.cls.setEditor(evt, "trans", stateData["params"].(cu.IM)), nil
                                }</span>
                        default:<span class="cov8" title="1">
                                client.SetForm(view,
                                        cu.MergeIM(row, cu.IM{"tax_codes": stateData["tax_codes"], "places": stateData["places"]}),
                                        cu.ToInteger(row["index"], cu.ToInteger(valueData["index"], 0)), false)</span>
                        }
                        <span class="cov8" title="1">return evt, nil</span>
                },

                ct.TableEventAddItem: func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return s.editorFieldViewAdd(evt, transMap, resultUpdate)

                }</span>,

                ct.TableEventFormDelete: func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        fieldName := cu.ToString(row["field_name"], "")
                        delete(transMap, fieldName)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                ct.TableEventFormUpdate: func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return s.cls.updateMapField(evt, transMap, resultUpdate)
                }</span>,

                ct.TableEventFormChange: func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return evt, nil
                }</span>,

                ct.TableEventFormCancel: func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return evt, nil
                }</span>,

                ct.TableEventEditCell: func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        fieldName := cu.ToString(valueData["fieldname"], "")
                        if fieldName == "payment_link_add" </span><span class="cov0" title="0">{
                                return s.linkAdd(evt,
                                        cu.IM{"view": "payment_link", "code1": cu.ToString(row["code"], ""), "code2": "",
                                                "amount": cu.ToFloat(row["amount"], 0)})
                        }</span>
                        <span class="cov0" title="0">module := strings.Split(strings.TrimPrefix(fieldName, "ref_"), "_")[0]
                        fieldValue := cu.ToString(valueData["value"], "")
                        stateData["params"] = cu.IM{
                                "editor_view":    module,
                                module + "_code": fieldValue,
                                "session_id":     client.Ticket.SessionID,
                        }
                        if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_dirty"),
                                        "warning_message": client.Msg("inputbox_drop"),
                                        "next":            module,
                                }
                                client.SetForm("warning", modal, 0, true)
                                return evt, nil
                        }</span>
                        <span class="cov0" title="0">return s.cls.setEditor(evt, module, stateData["params"].(cu.IM)), nil</span>
                },

                "map_field": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        stateData["map_field"] = value
                        return resultUpdate(cu.IM{"dirty": false})
                }</span>,

                "queue": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        modal := cu.ToIM(client.Data["modal"], cu.IM{})
                        modalData := cu.ToIM(modal["data"], cu.IM{})
                        if err = s.cls.insertPrintQueue(ds, modalData); err == nil </span><span class="cov8" title="1">{
                                return s.cls.evtMsg(evt.Name, evt.TriggerName, client.Msg("report_add_queue"), ct.ToastTypeSuccess, 5), nil
                        }</span>
                        <span class="cov8" title="1">return evt, err</span>
                },

                "tags": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return s.cls.editorTags(evt, transMeta, resultUpdate)
                }</span>,

                "rate": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMeta[fieldName] = cu.ToFloat(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "ref_number": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "trans_state": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "direction": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        trans[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "trans_date": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        trans[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "currency_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        trans[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "due_time": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "paid_type": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "paid": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMeta[fieldName] = cu.ToBoolean(value, false)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "closed": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        transMeta[fieldName] = cu.ToBoolean(value, false)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        trans[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "place_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        trans[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "target_place_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        movements := cu.ToIMA(stateData["movements"], []cu.IM{})
                        for _, movement := range movements </span><span class="cov0" title="0">{
                                if cu.ToString(movement["movement_code"], "") != "" </span><span class="cov0" title="0">{
                                        movement["place_code"] = value
                                }</span>
                        }
                        <span class="cov0" title="0">stateData["movements"] = movements
                        return resultUpdate(cu.IM{"dirty": true})</span>
                },

                "customer_code": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return s.cls.editorCodeSelector(evt, "trans", strings.Split(fieldName, "_")[0], trans, resultUpdate)
                }</span>,

                "employee_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorCodeSelector(evt, "trans", strings.Split(fieldName, "_")[0], trans, resultUpdate)
                }</span>,

                "project_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorCodeSelector(evt, "trans", strings.Split(fieldName, "_")[0], trans, resultUpdate)
                }</span>,

                "transitem_code": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        return s.cls.editorCodeSelector(evt, "trans", strings.Split(fieldName, "_")[0], trans, resultUpdate)
                }</span>,

                "trans_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        stateData["params"] = cu.IM{
                                "trans_code": cu.ToString(value, ""),
                                "session_id": client.Ticket.SessionID}
                        if cu.ToBoolean(stateData["dirty"], false) </span><span class="cov0" title="0">{
                                modal := cu.IM{
                                        "warning_label":   client.Msg("inputbox_dirty"),
                                        "warning_message": client.Msg("inputbox_drop"),
                                        "next":            "trans",
                                }
                                client.SetForm("warning", modal, 0, true)
                                return evt, nil
                        }</span>
                        <span class="cov0" title="0">return s.cls.setEditor(evt, "trans", stateData["params"].(cu.IM)), nil</span>
                },

                "notes": func() (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
                        transMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "internal_notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMeta[fieldName] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "worksheet_distance": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMetaWorksheet["distance"] = cu.ToFloat(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "worksheet_repair": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMetaWorksheet["repair"] = cu.ToFloat(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "worksheet_total": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMetaWorksheet["total"] = cu.ToFloat(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "worksheet_notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMetaWorksheet["notes"] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "rent_holiday": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMetaRent["holiday"] = cu.ToFloat(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "rent_bad_tool": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMetaRent["bad_tool"] = cu.ToFloat(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "rent_other": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMetaRent["other"] = cu.ToFloat(value, 0)
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "rent_notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        transMetaRent["notes"] = value
                        return resultUpdate(cu.IM{"dirty": true})
                }</span>,

                "payment_amount": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.editorFieldExternal(evt)
                }</span>,

                "payment_paid_date": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.editorFieldExternal(evt)
                }</span>,

                "movement_product_code": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.cls.editorCodeSelector(evt, "trans", "product", cu.IM{},
                                func(params cu.IM) (re ct.ResponseEvent, err error) </span><span class="cov0" title="0">{
                                        event := cu.ToString(params["event"], "")
                                        if event == ct.SelectorEventSelected || event == ct.SelectorEventDelete </span><span class="cov0" title="0">{
                                                return s.editorFieldExternal(evt)
                                        }</span>
                                        <span class="cov0" title="0">return resultUpdate(params)</span>
                                })
                },

                "movement_qty": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.editorFieldExternal(evt)
                }</span>,

                "movement_notes": func() (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
                        return s.editorFieldExternal(evt)
                }</span>,
        }

        <span class="cov8" title="1">if fn, ok := fieldMap[fieldName]; ok </span><span class="cov8" title="1">{
                return fn()
        }</span>
        <span class="cov8" title="1">if slices.Contains([]string{"orientation", "template", "paper_size", "copy",
                "create_netto", "create_ref_number", "create_delivery", "create_direction", "create_trans_type",
        }, fieldName) </span><span class="cov8" title="1">{
                modal := cu.ToIM(client.Data["modal"], cu.IM{})
                modalData := cu.ToIM(modal["data"], cu.IM{})
                modalData[fieldName] = value
                client.SetForm(cu.ToString(modal["key"], ""), modalData, 0, true)
                return evt, nil
        }</span>
        <span class="cov8" title="1">return evt, nil</span>
}

func (s *TransService) createError(evt ct.ResponseEvent, msg string) (re ct.ResponseEvent, err error) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        modal := cu.IM{
                "title":      client.Msg("trans_create_title"),
                "info_label": msg,
                "icon":       ct.IconExclamationTriangle,
        }
        client.SetForm("info", modal, 0, true)
        return evt, nil
}</span>

func (s *TransService) createCheck(options cu.IM, trans md.Trans) (errMsg string) <span class="cov8" title="1">{
        transType := cu.ToString(options["create_trans_type"], trans.TransType.String())
        direction := cu.ToString(options["create_direction"], trans.Direction.String())
        status := cu.ToString(options["status"], md.TransStatusNormal.String())

        if (transType == md.TransTypeReceipt.String() || transType == md.TransTypeWorksheet.String()) &amp;&amp; direction == md.DirectionIn.String() </span><span class="cov0" title="0">{
                return "invalid_trans"
        }</span>
        <span class="cov8" title="1">if trans.TransMeta.Status.String() == md.TransStatusCancellation.String() </span><span class="cov0" title="0">{
                return "trans_create_cancellation_err1"
        }</span>
        <span class="cov8" title="1">if status == md.TransStatusCancellation.String() &amp;&amp;
                slices.Contains([]string{md.TransTypeReceipt.String(), md.TransTypeInvoice.String()}, transType) &amp;&amp; !trans.Deleted </span><span class="cov0" title="0">{
                return "trans_create_cancellation_err2"
        }</span>
        //if status == md.TransStatusCancellation.String() &amp;&amp; trans.TransCode != "" {
        //        return "trans_create_cancellation_err3"
        //        }
        <span class="cov8" title="1">if status == md.TransStatusAmendment.String() &amp;&amp; trans.Deleted </span><span class="cov0" title="0">{
                return "trans_create_amendment_err"
        }</span>
        <span class="cov8" title="1">return ""</span>
}

func (s *TransService) createProductQty(items []cu.IM, productCode string, deposit bool) (tqty float64) <span class="cov0" title="0">{
        for _, bi := range items </span><span class="cov0" title="0">{
                biMeta := cu.ToIM(bi["item_meta"], cu.IM{})
                if cu.ToString(bi["product_code"], "") == productCode &amp;&amp; cu.ToBoolean(biMeta["deposit"], false) == deposit </span><span class="cov0" title="0">{
                        tqty += cu.ToFloat(biMeta["qty"], 0)
                }</span>
        }
        <span class="cov0" title="0">return tqty</span>
}

func (s *TransService) createInvoiceItems(evt ct.ResponseEvent, options cu.IM) (items []cu.IM) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()

        trans := cu.ToIM(stateData["trans"], cu.IM{})
        baseItems := cu.ToIMA(stateData["items"], []cu.IM{})
        transitemInvoice := cu.ToIMA(stateData["transitem_invoice"], []cu.IM{})
        transitemShipping := cu.ToIMA(stateData["transitem_shipping"], []cu.IM{})
        taxCodes := cu.ToIMA(stateData["tax_codes"], []cu.IM{})
        currencies := cu.ToIMA(stateData["currencies"], []cu.IM{})
        digit := uint(s.currencyDigit(currencies, cu.ToString(trans["currency_code"], "")))

        deliveryBase := cu.ToBoolean(options["create_delivery"], false)
        nettoInvoice := cu.ToBoolean(options["create_netto"], false)

        items = []cu.IM{}
        products := map[string]bool{}

        recalcItem := func(item cu.IM) cu.IM </span><span class="cov0" title="0">{
                rate := s.taxRate(taxCodes, cu.ToString(item["tax_code"], ""))
                itemMeta := cu.ToIM(item["item_meta"], cu.IM{})
                itemMeta["net_amount"] = s.roundFloat(cu.ToFloat(itemMeta["fx_price"], 0)*(1-cu.ToFloat(itemMeta["discount"], 0)/100)*cu.ToFloat(itemMeta["qty"], 0), digit)
                itemMeta["vat_amount"] = s.roundFloat(cu.ToFloat(itemMeta["fx_price"], 0)*(1-cu.ToFloat(itemMeta["discount"], 0)/100)*cu.ToFloat(itemMeta["qty"], 0)*rate, digit)
                itemMeta["amount"] = s.roundFloat(cu.ToFloat(itemMeta["net_amount"], 0)+cu.ToFloat(itemMeta["vat_amount"], 0), digit)
                item["item_meta"] = itemMeta
                return item
        }</span>

        <span class="cov8" title="1">appendItem := func(item cu.IM, iqty float64) </span><span class="cov0" title="0">{
                if _, found := products[cu.ToString(item["product_code"], "")]; !found </span><span class="cov0" title="0">{
                        iqty -= s.createProductQty(transitemInvoice, cu.ToString(item["product_code"], ""), false)
                        products[cu.ToString(item["product_code"], "")] = true
                }</span>
                <span class="cov0" title="0">if iqty != 0 </span><span class="cov0" title="0">{
                        itemMeta := cu.ToIM(item["item_meta"], cu.IM{})
                        itemMeta["qty"] = iqty
                        item["item_meta"] = itemMeta
                        item = recalcItem(item)
                        items = append(items, item)
                }</span>
        }

        <span class="cov8" title="1">if deliveryBase </span><span class="cov0" title="0">{
                // create from order,worksheet and rent, on base the delivery rows
                for _, si := range transitemShipping </span><span class="cov0" title="0">{
                        if idx := slices.IndexFunc(baseItems, func(bi cu.IM) bool </span><span class="cov0" title="0">{
                                return cu.ToString(bi["id"], "")+"-"+cu.ToString(bi["product_code"], "") == cu.ToString(si["id"], "")
                        }</span>); idx &gt; -1 <span class="cov0" title="0">{
                                bi := baseItems[idx]
                                iqty := cu.ToFloat(si["sqty"], 0)
                                if cu.ToString(trans["direction"], "") == md.DirectionOut.String() </span><span class="cov0" title="0">{
                                        iqty = -iqty
                                }</span>
                                <span class="cov0" title="0">if iqty &gt; 0 </span><span class="cov0" title="0">{
                                        appendItem(cu.MergeIM(cu.IM{}, bi), iqty)
                                }</span>
                        }
                }
        } else<span class="cov8" title="1"> {
                for _, bi := range baseItems </span><span class="cov8" title="1">{
                        if nettoInvoice </span><span class="cov0" title="0">{
                                // create from order,worksheet and rent, on base the invoice rows
                                biMeta := cu.ToIM(bi["item_meta"], cu.IM{})
                                iqty := cu.ToFloat(biMeta["qty"], 0)
                                appendItem(cu.MergeIM(cu.IM{}, bi), iqty)
                        }</span> else<span class="cov8" title="1"> {
                                items = append(items, cu.MergeIM(cu.IM{}, bi))
                        }</span>
                }
        }

        // put to deposit rows
        <span class="cov8" title="1">for _, it := range items </span><span class="cov8" title="1">{
                if cu.ToBoolean(it["deposit"], false) </span><span class="cov0" title="0">{
                        dqty := s.createProductQty(transitemInvoice, cu.ToString(it["product_code"], ""), true)
                        if dqty != 0 </span><span class="cov0" title="0">{
                                item := cu.MergeIM(cu.IM{}, it)
                                item["qty"] = -dqty
                                items = append(items, item)
                        }</span>
                }
        }

        <span class="cov8" title="1">return items</span>
}

func (s *TransService) createItems(evt ct.ResponseEvent, options cu.IM, transCode string) (err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)

        trans := cu.ToIM(stateData["trans"], cu.IM{})
        transType := cu.ToString(options["create_trans_type"], cu.ToString(trans["trans_type"], ""))
        //direction := cu.ToString(options["direction"], cu.ToString(trans["direction"], ""))
        status := cu.ToString(options["status"], md.TransStatusNormal.String())

        items := cu.ToIMA(stateData["items"], []cu.IM{})
        if transType == md.TransTypeInvoice.String() || transType == md.TransTypeReceipt.String() </span><span class="cov8" title="1">{
                items = s.createInvoiceItems(evt, options)
        }</span>

        <span class="cov8" title="1">storno := func(it md.Item) md.Item </span><span class="cov8" title="1">{
                it.ItemMeta.Qty = -it.ItemMeta.Qty
                it.ItemMeta.NetAmount = -it.ItemMeta.NetAmount
                it.ItemMeta.VatAmount = -it.ItemMeta.VatAmount
                it.ItemMeta.Amount = -it.ItemMeta.Amount
                return it
        }</span>

        <span class="cov8" title="1">updateItem := func(it md.Item) (storeID int64, err error) </span><span class="cov8" title="1">{
                values := cu.IM{
                        "trans_code":   transCode,
                        "product_code": it.ProductCode,
                        "tax_code":     it.TaxCode,
                }
                ut.ConvertByteToIMData(it.ItemMeta, values, "item_meta")
                ut.ConvertByteToIMData(it.ItemMap, values, "item_map")
                return ds.StoreDataUpdate(md.Update{Values: values, Model: "item"})
        }</span>

        <span class="cov8" title="1">for _, it := range items </span><span class="cov8" title="1">{
                var item md.Item = md.Item{
                        TransCode: transCode,
                        ItemMeta: md.ItemMeta{
                                Tags: []string{},
                        },
                        ItemMap: cu.IM{},
                }
                if err = ut.ConvertToType(it, &amp;item); err == nil </span><span class="cov8" title="1">{
                        item.ItemMeta.OwnStock = 0
                        if transType == md.TransTypeInvoice.String() || transType == md.TransTypeReceipt.String() </span><span class="cov8" title="1">{
                                item.ItemMeta.Deposit = false
                        }</span>
                        <span class="cov8" title="1">if status == md.TransStatusCancellation.String() </span><span class="cov8" title="1">{
                                item = storno(item)
                        }</span>
                        <span class="cov8" title="1">if _, err = updateItem(item); err == nil </span><span class="cov8" title="1">{
                                if status == md.TransStatusAmendment.String() </span><span class="cov0" title="0">{
                                        _, err = updateItem(storno(item))
                                }</span>
                        }
                        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                }
        }
        <span class="cov8" title="1">return err</span>
}

func (s *TransService) createPayments(evt ct.ResponseEvent, options cu.IM, transCode string) (err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)

        status := cu.ToString(options["status"], md.TransStatusNormal.String())
        payments := cu.ToIMA(stateData["payments"], []cu.IM{})

        for _, pm := range payments </span><span class="cov8" title="1">{
                var payment md.Payment = md.Payment{
                        PaidDate: md.TimeDate{Time: time.Now()},
                        PaymentMeta: md.PaymentMeta{
                                Tags: []string{},
                        },
                        PaymentMap: cu.IM{},
                }
                if err = ut.ConvertToType(pm, &amp;payment); err == nil </span><span class="cov8" title="1">{
                        values := cu.IM{
                                "paid_date":  payment.PaidDate.String(),
                                "trans_code": transCode,
                        }
                        if status == md.TransStatusCancellation.String() </span><span class="cov8" title="1">{
                                payment.PaymentMeta.Amount = -payment.PaymentMeta.Amount
                        }</span>
                        <span class="cov8" title="1">ut.ConvertByteToIMData(payment.PaymentMeta, values, "payment_meta")
                        ut.ConvertByteToIMData(payment.PaymentMap, values, "payment_map")
                        if _, err = ds.StoreDataUpdate(md.Update{Values: values, Model: "payment"}); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                }
        }
        <span class="cov8" title="1">return err</span>
}

func (s *TransService) createMovements(evt ct.ResponseEvent, options cu.IM, transCode string) (err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)

        trans := cu.ToIM(stateData["trans"], cu.IM{})
        transType := cu.ToString(options["create_trans_type"], cu.ToString(trans["trans_type"], ""))
        status := cu.ToString(options["status"], md.TransStatusNormal.String())
        movementHead := cu.ToIM(stateData["movement_head"], cu.IM{})
        movements := cu.ToIMA(stateData["movements"], []cu.IM{})

        updateMovement := func(mv md.Movement) (storeID int64, err error) </span><span class="cov8" title="1">{
                values := cu.IM{
                        "movement_type": mv.MovementType.String(),
                        "shipping_time": mv.ShippingTime.String(),
                        "trans_code":    transCode,
                }
                if mv.MovementType == md.MovementTypeTool </span><span class="cov0" title="0">{
                        values["tool_code"] = mv.ToolCode
                }</span> else<span class="cov8" title="1"> {
                        values["product_code"] = mv.ProductCode
                }</span>
                <span class="cov8" title="1">if mv.PlaceCode != "" </span><span class="cov8" title="1">{
                        values["place_code"] = mv.PlaceCode
                }</span>
                <span class="cov8" title="1">if status == md.TransStatusCancellation.String() </span><span class="cov8" title="1">{
                        if mv.ItemCode != "" </span><span class="cov0" title="0">{
                                values["item_code"] = mv.ItemCode
                        }</span>
                        <span class="cov8" title="1">if mv.MovementCode != "" </span><span class="cov0" title="0">{
                                values["movement_code"] = mv.MovementCode
                        }</span>
                }
                <span class="cov8" title="1">ut.ConvertByteToIMData(mv.MovementMeta, values, "movement_meta")
                ut.ConvertByteToIMData(mv.MovementMap, values, "movement_map")
                return ds.StoreDataUpdate(md.Update{Values: values, Model: "movement"})</span>
        }

        <span class="cov8" title="1">getMovement := func(movement cu.IM) (mv md.Movement, err error) </span><span class="cov8" title="1">{
                mv = md.Movement{
                        MovementType: md.MovementType(md.MovementTypeInventory),
                        ShippingTime: md.TimeDateTime{Time: time.Now()},
                        MovementMeta: md.MovementMeta{
                                Tags: []string{},
                        },
                        MovementMap: cu.IM{},
                }
                err = ut.ConvertToType(movement, &amp;mv)
                return mv, err
        }</span>

        <span class="cov8" title="1">var mv md.Movement
        if transType == md.TransTypeFormula.String() || transType == md.TransTypeProduction.String() </span><span class="cov0" title="0">{
                if mv, err = getMovement(movementHead); err == nil </span><span class="cov0" title="0">{
                        _, err = updateMovement(mv)
                }</span>
                <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                        return err
                }</span>
        }

        <span class="cov8" title="1">for _, movement := range movements </span><span class="cov8" title="1">{
                if mv, err = getMovement(movement); err == nil </span><span class="cov8" title="1">{
                        if status == md.TransStatusCancellation.String() </span><span class="cov8" title="1">{
                                mv.MovementMeta.Qty = -mv.MovementMeta.Qty
                        }</span>
                        <span class="cov8" title="1">if _, err = updateMovement(mv); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>
                }
        }
        <span class="cov8" title="1">return err</span>
}

func (s *TransService) createTrans(evt ct.ResponseEvent, options cu.IM, trans md.Trans) (transCode string, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        ds := s.cls.getDataStore(client.Ticket.Database)

        user := cu.ToIM(stateData["user"], cu.IM{})
        configData := cu.ToIMA(stateData["config_data"], []cu.IM{})

        transType := cu.ToString(options["create_trans_type"], trans.TransType.String())
        direction := cu.ToString(options["create_direction"], trans.Direction.String())
        status := cu.ToString(options["status"], md.TransStatusNormal.String())

        values := cu.IM{
                "trans_type": transType,
                "trans_date": time.Now().Format(time.DateOnly),
                "direction":  direction,
                "auth_code":  user["code"],
        }

        optionalFields := map[string]func() (bool, any){
                "trans_code": func() (bool, any) </span><span class="cov8" title="1">{
                        return cu.ToBoolean(options["create_ref_number"], false) || (status == md.TransStatusCancellation.String()) ||
                                (status == md.TransStatusAmendment.String()), trans.Code
                }</span>,
                "customer_code": func() (bool, any) <span class="cov8" title="1">{
                        return trans.CustomerCode != "" &amp;&amp; transType != md.TransTypeReceipt.String(), trans.CustomerCode
                }</span>,
                "employee_code": func() (bool, any) <span class="cov8" title="1">{
                        return trans.EmployeeCode != "", trans.EmployeeCode
                }</span>,
                "project_code": func() (bool, any) <span class="cov8" title="1">{
                        return trans.ProjectCode != "", trans.ProjectCode
                }</span>,
                "place_code": func() (bool, any) <span class="cov8" title="1">{
                        return trans.PlaceCode != "", trans.PlaceCode
                }</span>,
                "currency_code": func() (bool, any) <span class="cov8" title="1">{
                        return trans.CurrencyCode != "", trans.CurrencyCode
                }</span>,
                "trans_date": func() (bool, any) <span class="cov8" title="1">{
                        return status == md.TransStatusCancellation.String(), trans.TransDate.Format(time.DateOnly)
                }</span>,
                "deleted": func() (bool, any) <span class="cov8" title="1">{
                        return status == md.TransStatusCancellation.String() &amp;&amp;
                                transType != md.TransTypeDelivery.String() &amp;&amp; transType != md.TransTypeInventory.String(), true
                }</span>,
        }

        <span class="cov8" title="1">for key, fn := range optionalFields </span><span class="cov8" title="1">{
                if ok, value := fn(); ok </span><span class="cov8" title="1">{
                        values[key] = value
                }</span>
        }

        <span class="cov8" title="1">meta := md.TransMeta{
                DueTime:       md.TimeDateTime{Time: time.Now()},
                RefNumber:     "",
                PaidType:      trans.TransMeta.PaidType,
                TaxFree:       trans.TransMeta.TaxFree,
                Paid:          false,
                Rate:          trans.TransMeta.Rate,
                Closed:        false,
                Status:        md.TransStatus(0).Get(status),
                TransState:    md.TransStateOK,
                Notes:         trans.TransMeta.Notes,
                InternalNotes: trans.TransMeta.InternalNotes,
                ReportNotes:   trans.TransMeta.ReportNotes,
                Worksheet:     md.TransMetaWorksheet{},
                Rent:          md.TransMetaRent{},
                Invoice:       md.TransMetaInvoice{},
                Tags:          trans.TransMeta.Tags,
        }

        optionalMeta := []func() (bool, func()){
                func() (bool, func()) </span><span class="cov8" title="1">{
                        return (transType == md.TransTypeWorksheet.String()), func() </span><span class="cov8" title="1">{
                                meta.Worksheet = md.TransMetaWorksheet{}
                        }</span>
                },
                func() (bool, func()) <span class="cov8" title="1">{
                        return (transType == md.TransTypeRent.String()), func() </span><span class="cov0" title="0">{
                                meta.Rent = md.TransMetaRent{}
                        }</span>
                },
                func() (bool, func()) <span class="cov8" title="1">{
                        return (transType == md.TransTypeInvoice.String()), func() </span><span class="cov8" title="1">{
                                meta.Invoice = md.TransMetaInvoice{}
                                if direction == md.DirectionOut.String() </span><span class="cov8" title="1">{
                                        if idx := slices.IndexFunc(configData, func(cf cu.IM) bool </span><span class="cov8" title="1">{
                                                return cu.ToString(cf["config_key"], "") == "default_deadline"
                                        }</span>); idx &gt; -1 <span class="cov8" title="1">{
                                                meta.DueTime = md.TimeDateTime{Time: time.Now().AddDate(0, 0, int(cu.ToInteger(cu.ToString(configData[idx]["config_value"], ""), 0)))}
                                        }</span>
                                }
                        }
                },
                func() (bool, func()) <span class="cov8" title="1">{
                        return (status == md.TransStatusCancellation.String()), func() </span><span class="cov8" title="1">{
                                meta.DueTime = trans.TransMeta.DueTime
                        }</span>
                },
        }
        <span class="cov8" title="1">for _, fn := range optionalMeta </span><span class="cov8" title="1">{
                if ok, fn := fn(); ok </span><span class="cov8" title="1">{
                        fn()
                }</span>
        }

        <span class="cov8" title="1">ut.ConvertByteToIMData(meta, values, "trans_meta")
        ut.ConvertByteToIMData(trans.TransMap, values, "trans_map")

        var transID int64
        update := md.Update{Values: values, Model: "trans"}
        if transID, err = ds.StoreDataUpdate(update); err == nil </span><span class="cov8" title="1">{
                var rows []cu.IM = []cu.IM{}
                if rows, err = ds.StoreDataQuery(md.Query{
                        Fields: []string{"*"}, From: "trans",
                        Filters: []md.Filter{
                                {Field: "id", Comp: "==", Value: transID},
                        },
                }, true); err == nil </span><span class="cov8" title="1">{
                        transCode = cu.ToString(cu.ToIM(rows[0], cu.IM{})["code"], "")
                }</span>
        }
        <span class="cov8" title="1">return transCode, err</span>
}

func (s *TransService) createData(evt ct.ResponseEvent, options cu.IM) (re ct.ResponseEvent, err error) <span class="cov8" title="1">{
        client := evt.Trigger.(*ct.Client)
        _, _, stateData := client.GetStateData()
        //ds := cls.getDataStore(client.Ticket.Database)

        var trans md.Trans = md.Trans{}
        ut.ConvertToType(stateData["trans"], &amp;trans)

        //transType := cu.ToString(options["trans_type"], trans.TransType.String())
        //direction := cu.ToString(options["direction"], trans.Direction.String())
        //status := cu.ToString(options["status"], md.TransStatusNormal.String())

        // to check some things...
        if errMsg := s.createCheck(options, trans); errMsg != "" </span><span class="cov0" title="0">{
                return s.createError(evt, client.Msg(errMsg))
        }</span>

        <span class="cov8" title="1">var transCode string
        if transCode, err = s.createTrans(evt, options, trans); err != nil </span><span class="cov0" title="0">{
                return s.createError(evt, client.Msg(err.Error()))
        }</span>

        <span class="cov8" title="1">if err = s.createItems(evt, options, transCode); err != nil </span><span class="cov0" title="0">{
                return s.createError(evt, client.Msg(err.Error()))
        }</span>

        <span class="cov8" title="1">if err = s.createPayments(evt, options, transCode); err != nil </span><span class="cov0" title="0">{
                return s.createError(evt, client.Msg(err.Error()))
        }</span>

        <span class="cov8" title="1">if err = s.createMovements(evt, options, transCode); err != nil </span><span class="cov0" title="0">{
                return s.createError(evt, client.Msg(err.Error()))
        }</span>

        <span class="cov8" title="1">return s.cls.setEditor(evt, "trans", cu.IM{
                "session_id": client.Ticket.SessionID,
                "trans_code": transCode,
        }), nil</span>
}

func (s *TransService) createModal(evt ct.ResponseEvent, data cu.IM) (re ct.ResponseEvent) <span class="cov0" title="0">{
        client := evt.Trigger.(*ct.Client)
        baseTransItem := cu.IM{
                "title": client.Msg("trans_create_title"),
                "icon":  ct.IconFileText,
                "trans_types": []string{
                        md.TransTypeOffer.String(), md.TransTypeOrder.String(), md.TransTypeWorksheet.String(),
                        md.TransTypeRent.String(), md.TransTypeInvoice.String(), md.TransTypeReceipt.String()},
                "create_trans_type": md.TransTypeOrder.String(),
                "create_direction":  md.DirectionOut.String(),
                "status":            md.TransStatusNormal.String(),
                "show_delivery":     false,
                "next":              "transitem_new",
                "module":            "trans",
                "editor_title":      client.Msg("transitem_title"),
                "editor_icon":       ct.IconFileText,
        }
        dataMap := map[string]func() cu.IM{
                "transitem": func() cu.IM </span><span class="cov0" title="0">{
                        return baseTransItem
                }</span>,
                "transpayment": func() cu.IM <span class="cov0" title="0">{
                        return cu.IM{
                                "title": client.Msg("trans_create_title"),
                                "icon":  ct.IconMoney,
                                "trans_types": []string{
                                        md.TransTypeCash.String(), md.TransTypeBank.String()},
                                "create_trans_type": md.TransTypeCash.String(),
                                "create_direction":  md.DirectionOut.String(),
                                "status":            md.TransStatusNormal.String(),
                                "next":              "transpayment_new",
                                "module":            "trans",
                        }
                }</span>,
                "transmovement": func() cu.IM <span class="cov0" title="0">{
                        return cu.IM{
                                "title": client.Msg("transmovement_view"),
                                "icon":  ct.IconTruck,
                                "trans_types": []string{
                                        md.TransTypeDelivery.String(), md.TransTypeInventory.String(), md.TransTypeProduction.String()},
                                "create_trans_type": md.TransTypeDelivery.String(),
                                "create_direction":  md.DirectionTransfer.String(),
                                "status":            md.TransStatusNormal.String(),
                                "next":              "transmovement_new",
                                "module":            "trans",
                        }
                }</span>,
                md.TransTypeOffer.String(): func() cu.IM <span class="cov0" title="0">{
                        return cu.MergeIM(baseTransItem, cu.IM{
                                "trans_types": []string{
                                        md.TransTypeOffer.String(), md.TransTypeOrder.String(), md.TransTypeWorksheet.String(),
                                        md.TransTypeRent.String()},
                                "create_trans_type": md.TransTypeOrder.String(),
                                "create_direction":  cu.ToString(data["create_direction"], md.DirectionOut.String()),
                                "show_delivery":     false, "create_ref_number": true, "create_netto": true,
                                "next": "trans_create",
                        })
                }</span>,
                md.TransTypeOrder.String(): func() cu.IM <span class="cov0" title="0">{
                        return cu.MergeIM(baseTransItem, cu.IM{
                                "trans_types": []string{
                                        md.TransTypeOffer.String(), md.TransTypeOrder.String(), md.TransTypeWorksheet.String(),
                                        md.TransTypeRent.String(), md.TransTypeInvoice.String(), md.TransTypeReceipt.String()},
                                "create_trans_type": md.TransTypeInvoice.String(),
                                "create_direction":  cu.ToString(data["create_direction"], md.DirectionOut.String()),
                                "show_delivery":     false, "create_ref_number": true, "create_netto": true,
                                "next": "trans_create",
                        })
                }</span>,
                md.TransTypeWorksheet.String(): func() cu.IM <span class="cov0" title="0">{
                        return cu.MergeIM(baseTransItem, cu.IM{
                                "trans_types": []string{
                                        md.TransTypeOffer.String(), md.TransTypeOrder.String(), md.TransTypeWorksheet.String(),
                                        md.TransTypeRent.String(), md.TransTypeInvoice.String(), md.TransTypeReceipt.String()},
                                "create_trans_type": md.TransTypeInvoice.String(),
                                "create_direction":  cu.ToString(data["create_direction"], md.DirectionOut.String()),
                                "show_delivery":     false, "create_ref_number": true, "create_netto": true,
                                "next": "trans_create",
                        })
                }</span>,
                md.TransTypeRent.String(): func() cu.IM <span class="cov0" title="0">{
                        return cu.MergeIM(baseTransItem, cu.IM{
                                "trans_types": []string{
                                        md.TransTypeOffer.String(), md.TransTypeOrder.String(), md.TransTypeWorksheet.String(),
                                        md.TransTypeRent.String(), md.TransTypeInvoice.String(), md.TransTypeReceipt.String()},
                                "create_trans_type": md.TransTypeInvoice.String(),
                                "create_direction":  cu.ToString(data["create_direction"], md.DirectionOut.String()),
                                "show_delivery":     false, "create_ref_number": true, "create_netto": true,
                                "next": "trans_create",
                        })
                }</span>,
                md.TransTypeInvoice.String(): func() cu.IM <span class="cov0" title="0">{
                        return cu.MergeIM(baseTransItem, cu.IM{
                                "trans_types": []string{
                                        md.TransTypeOrder.String(), md.TransTypeWorksheet.String(),
                                        md.TransTypeRent.String(), md.TransTypeInvoice.String(), md.TransTypeReceipt.String()},
                                "create_trans_type": md.TransTypeOrder.String(),
                                "create_direction":  cu.ToString(data["create_direction"], md.DirectionOut.String()),
                                "show_delivery":     false, "create_ref_number": true, "create_netto": false,
                                "next": "trans_create",
                        })
                }</span>,
        }
        <span class="cov0" title="0">client.SetForm("trans_create", cu.MergeIM(dataMap[cu.ToString(data["state_key"], "")](), data), 0, true)
        return evt</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
